const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Cixl8Xp_.js","assets/index-93kECIxS.js","assets/index-2ZZXDwaa.css","assets/EmojiPicker-CjG13MvQ.js","assets/AddCustomEmojiDialog-CFJjwvR3.js","assets/CreatePoll-DTsmGZGj.js","assets/CreatePoll-DdjxYr1F.css","assets/GIFPicker-BBjmArqO.js","assets/useDebounce-BAwwZHs4.js","assets/Skeleton-DlHB_Jmw.js","assets/MobileInputActions-BKU8hK_m.js","assets/index-D8MEszt3.js","assets/useCurrentChannelData-ZvX0vP2P.js","assets/useGetUserRecords-ByoHozo1.js","assets/useRavenSettings-3Tg7OUeN.js","assets/hover-card-D1VTG-28.js","assets/preferences-ep5Ke7JB.js","assets/DoctypeLinkRenderer-Dma5sl5s.js","assets/useDoctypeMeta-C0Qoed5I.js","assets/skeleton-C4uoHUPj.js","assets/useCurrentChannelData-BsL46_d-.css","assets/EmptyState-BGAXfB0m.js","assets/DateSeparator-CbJXS3Zi.js","assets/tabs-DsY8ua36.js","assets/tiptap-Rf8UWCWH.css"])))=>i.map(i=>d[i]);
var Ls=Object.defineProperty,Ps=Object.defineProperties;var Fs=Object.getOwnPropertyDescriptors;var Se=Object.getOwnPropertySymbols;var qe=Object.prototype.hasOwnProperty,Je=Object.prototype.propertyIsEnumerable;var Ke=(s,t,n)=>t in s?Ls(s,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[t]=n,x=(s,t)=>{for(var n in t||(t={}))qe.call(t,n)&&Ke(s,n,t[n]);if(Se)for(var n of Se(t))Je.call(t,n)&&Ke(s,n,t[n]);return s},I=(s,t)=>Ps(s,Fs(t));var V=(s,t)=>{var n={};for(var a in s)qe.call(s,a)&&t.indexOf(a)<0&&(n[a]=s[a]);if(s!=null&&Se)for(var a of Se(s))t.indexOf(a)<0&&Je.call(s,a)&&(n[a]=s[a]);return n};var q=(s,t,n)=>new Promise((a,r)=>{var o=c=>{try{l(n.next(c))}catch(f){r(f)}},d=c=>{try{l(n.throw(c))}catch(f){r(f)}},l=c=>c.done?a(c.value):Promise.resolve(c.value).then(o,d);l((n=n.apply(s,t)).next())});import{b5 as $s,r as u,b6 as Os,b7 as Rs,ck as Hs,b9 as Us,h as De,aC as ls,ep as Vs,a3 as ee,ac as Ks,eq as qs,j as e,a as v,p as U,a7 as X,n as L,er as Js,ci as R,es as Ys,et as Gs,O as le,dd as Ws,eu as Xs,ev as Zs,ew as Qs,ex as et,ey as st,ez as tt,e6 as nt,aI as ve,cS as $e,e2 as at,M as J,a4 as Ee,ax as fe,i as P,eA as rt,bo as ze,G as it,a6 as ce,cg as lt,aa as oe,ab as Ce,au as je,av as pe,P as de,v as cs,bm as Oe,eB as he,S as os,o as Y,bl as ds,a8 as us,eC as ct,bJ as ms,u as Re,ai as He,E as ue,aL as Me,c as _e,L as hs,bu as ot,ay as xe,d as K,eD as dt,ak as ut,al as mt,dT as ht,an as gt,ao as ft,em as xt,eE as jt,eF as pt,eb as bt,aq as gs,ar as fs,as as yt,at as xs,dK as wt,eG as js,eH as ps,aw as bs,d6 as ys,bx as ws,dR as _s,du as _t,ce as vt,V as we,eI as Ct,eJ as kt,br as Nt,a0 as St,bY as vs,bZ as Cs,aR as Tt,b_ as ks,a1 as Et,a2 as Mt,ad as Dt,ag as It,ah as At,aM as Ns,dV as Ue,d_ as Ie,e0 as Ae,eK as Bt,U as Ss,eL as zt,e1 as Lt,dh as ge,bF as Ye,eM as be,eN as ae,b as Pt,z as Ft,aP as $t,dY as Ot,dX as Rt,e as Ht,dS as Ut,dn as Vt,aB as Kt,eO as qt,bd as Jt}from"./index-93kECIxS.js";import{L as Z,U as Ts,P as Es,f as Be,V as Yt,r as Gt,D as Wt,o as Xt,W as Le,X as Pe,S as Zt,C as Qt,c as en,u as sn,Q as Ge,Y as tn,E as We,g as nn,x as an,a as rn,j as ln,t as cn,b as on,p as dn}from"./index-D8MEszt3.js";import{S as un,b as mn,H as hn,L as gn,I as fn,c as Ms,d as xn,e as jn,f as pn}from"./useCurrentChannelData-ZvX0vP2P.js";/* empty css                      */import{D as bn}from"./DoctypeLinkRenderer-Dma5sl5s.js";import{E as yn}from"./preferences-ep5Ke7JB.js";import{C as wn}from"./EmptyState-BGAXfB0m.js";import{r as W}from"./skeleton-C4uoHUPj.js";import{D as _n}from"./DateSeparator-CbJXS3Zi.js";import{m as vn,b as Cn,f as Xe,P as kn}from"./tabs-DsY8ua36.js";import{u as Nn}from"./useGetUserRecords-ByoHozo1.js";const Sn=["all","x","y","top","bottom","left","right"],Tn=["border-box","padding-box"],re=["current","0"],En=I(x({},$s),{side:{type:"enum",className:"rt-r-side",values:Sn,default:"all",responsive:!0},clip:{type:"enum",className:"rt-r-clip",values:Tn,default:"border-box",responsive:!0},p:{type:"enum",className:"rt-r-p",values:re,parseValue:ie,responsive:!0},px:{type:"enum",className:"rt-r-px",values:re,parseValue:ie,responsive:!0},py:{type:"enum",className:"rt-r-py",values:re,parseValue:ie,responsive:!0},pt:{type:"enum",className:"rt-r-pt",values:re,parseValue:ie,responsive:!0},pr:{type:"enum",className:"rt-r-pr",values:re,parseValue:ie,responsive:!0},pb:{type:"enum",className:"rt-r-pb",values:re,parseValue:ie,responsive:!0},pl:{type:"enum",className:"rt-r-pl",values:re,parseValue:ie,responsive:!0}});function ie(s){return s==="current"?"inset":s}const Ve=u.forwardRef((s,t)=>{const d=Os(s,En,Rs),{asChild:n,className:a}=d,r=V(d,["asChild","className"]),o=n?Hs:"div";return u.createElement(o,I(x({},r),{ref:t,className:Us("rt-Inset",a)}))});Ve.displayName="Inset";const Ds=Vs(s=>qs([]));function Ra(s){const{file:t}=u.useContext(De),n=u.useRef(null),[a,r]=ls(Ds(s)),[o,d]=u.useState(!0),l=u.useRef([]);l.current=a;const[c,f]=u.useState({});return{fileInputRef:n,files:a,setFiles:r,removeFile:p=>{let j=a.filter(y=>y.fileID!==p);r(j),f(y=>{const S=x({},y);return delete S[p],S})},addFile:p=>{const j=p;j&&(j.fileID=p.name+Date.now(),j.uploadProgress=0,r(y=>[...y,j]))},compressImages:o,setCompressImages:d,uploadFiles:(p,j)=>q(null,null,function*(){const y=[...l.current];if(y.length>0){const S=y.map((b,D)=>q(null,null,function*(){return t.uploadFile(b,{isPrivate:!0,doctype:"Raven Message",otherData:{channelID:s,compressImages:o,is_reply:D===0&&p?1:0,linked_message:D===0&&p?p.name:null,caption:D===0&&j?j:""},fieldname:"file"},(E,M)=>{const z=Math.round(E/(M!=null?M:b.size)*100);f(Q=>I(x({},Q),{[b.fileID]:{progress:z,isComplete:!1}}))},"raven.api.upload_file.upload_file_with_message").then(E=>(r(M=>M.filter(z=>z.fileID!==b.fileID)),f(M=>I(x({},M),{[b.fileID]:{progress:100,isComplete:!0}})),E.data.message)).catch(E=>(f(M=>{const z=x({},M);return delete z[b.fileID],z}),ee.error("There was an error uploading the file "+b.name,{description:Ks(E)}),null))}));return Promise.all(S).then(b=>(r([]),b.filter(D=>D!==null))).catch(b=>(console.error(b),[]))}else return Promise.resolve([])}),fileUploadProgress:c}}const F={size:"18"},$="bg-transparent dark:text-gray-11 sm:dark:text-gray-10 text-gray-11 hover:bg-accent-a3 hover:text-accent-a11 dark:hover:text-accent-a11",Mn=s=>e.jsx(v,x({justify:"between",align:"center",className:"border-t border-t-slate-5 bg-slate-2 rounded-b-radius4 overflow-hidden",p:"1"},s)),Ze=u.memo(()=>{const{editor:s}=Z(),t="bg-accent-a3";return s?e.jsxs(v,{gap:"2",align:"center",px:"1",py:"1",className:"sm:max-w-[60%] max-w-[100%] overflow-x-auto",children:[e.jsxs(v,{gap:"3",align:"center",children:[e.jsx(X,{content:R()+" + B","aria-label":R()+" + B",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleBold().run(),"aria-label":"bold",variant:"ghost",title:"Bold",size:"1",className:s.isActive("bold")?t:$,disabled:!s.can().chain().focus().toggleBold().run(),children:e.jsx(Js,x({},F))})}),e.jsx(X,{content:R()+" + I","aria-label":R()+" + I",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleItalic().run(),"aria-label":"italic",title:"Italic",variant:"ghost",size:"1",className:s.isActive("italic")?t:$,disabled:!s.can().chain().focus().toggleItalic().run(),children:e.jsx(Ys,x({},F))})}),e.jsx(X,{content:R()+" + U","aria-label":R()+" + U",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleUnderline().run(),"aria-label":"underline",title:"Underline",variant:"ghost",size:"1",className:s.isActive("underline")?t:$,disabled:!s.can().chain().focus().toggleUnderline().run(),children:e.jsx(Gs,x({},F))})})]}),e.jsx(le,{orientation:"vertical"}),e.jsxs(v,{gap:"3",align:"center",children:[e.jsx(X,{content:R()+" + E","aria-label":R()+" + E",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleCode().run(),"aria-label":"code",variant:"ghost",size:"1",title:"Code",className:s.isActive("code")?t:$,disabled:!s.can().chain().focus().toggleCode().run(),children:e.jsx(Ws,x({},F))})}),e.jsx(X,{content:R()+"+ Shift + E","aria-label":R()+"+ Shift + E",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleCodeBlock().run(),"aria-label":"code block",variant:"ghost",size:"1",title:"Code Block",className:s.isActive("codeBlock")?t:$,disabled:!s.can().chain().focus().toggleCodeBlock().run(),children:e.jsx(Xs,x({},F))})}),e.jsx(L,{onClick:()=>s.chain().focus().toggleStrike().run(),"aria-label":"strike",variant:"ghost",size:"1",title:"Strike",className:s.isActive("strike")?t:$,disabled:!s.can().chain().focus().toggleStrike().run(),children:e.jsx(Zs,x({},F))}),e.jsx(L,{onClick:()=>s.chain().focus().toggleBlockquote().run(),"aria-label":"blockquote",className:s.isActive("blockquote")?t:$,title:"Blockquote",size:"1",variant:"ghost",disabled:!s.can().chain().focus().toggleBlockquote().run(),children:e.jsx(Qs,x({},F))})]}),e.jsx(le,{orientation:"vertical"}),e.jsxs(v,{gap:"3",align:"center",children:[e.jsx(X,{content:R()+" + Shift + 7","aria-label":R()+" + Shift + 7",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleOrderedList().run(),"aria-label":"ordered list",title:"Ordered List",size:"1",variant:"ghost",className:s.isActive("orderedList")?t:$,disabled:!s.can().chain().focus().toggleOrderedList().run(),children:e.jsx(et,x({},F))})}),e.jsx(X,{content:R()+" + Shift + 8","aria-label":R()+" + Shift + 8",children:e.jsx(L,{onClick:()=>s.chain().focus().liftEmptyBlock().toggleBulletList().run(),"aria-label":"bullet list",title:"Bullet List",size:"1",variant:"ghost",className:s.isActive("bulletList")?t:$,disabled:!s.can().chain().focus().toggleBulletList().run(),children:e.jsx(st,x({},F))})})]}),e.jsx(le,{orientation:"vertical"}),e.jsx(v,{gap:"3",align:"center",children:e.jsx(X,{content:R()+" + Shift + H","aria-label":R()+" + Shift + H",children:e.jsx(L,{"aria-label":"highlight",onClick:()=>s.chain().focus().toggleHighlight().run(),title:"Highlight",variant:"ghost",size:"1",className:s.isActive("highlight")?t:$,disabled:!s.can().chain().focus().toggleHighlight().run(),children:e.jsx(tt,x({},F))})})}),e.jsx(Dn,{})]}):e.jsx(U,{})}),Dn=()=>{const{editor:s}=Z(),t=a=>q(null,null,function*(){let r=a;const d=(yield ve(()=>import("./index-Cixl8Xp_.js"),__vite__mapDeps([0,1,2]))).parse(r,void 0,{forwardDate:!0});return d.sort((l,c)=>c.index-l.index),d.forEach(l=>{var y,S,b,D;if(!l.start.isCertain("hour")&&!l.start.isCertain("minute")&&!l.start.isCertain("day"))return;const c=l.start.isCertain("hour")&&l.start.isCertain("minute"),f=l.start.date().getTime(),C=(S=(y=l.end)==null?void 0:y.date().getTime())!=null?S:null,N=C?((b=l.end)==null?void 0:b.isCertain("hour"))&&((D=l.end)==null?void 0:D.isCertain("minute")):!1,k=l.index,p=l.text;let j="";f&&(j+=`data-timestamp-start="${f}"`),C&&(j+=` data-timestamp-end="${C}"`),c||(j+=' data-timestamp-start-all-day="true"'),N||(j+=' data-timestamp-end-all-day="true"'),r=r.slice(0,k)+`<span class="timestamp" ${j}">${p}</span>`+r.slice(k+p.length)}),r}),n=()=>q(null,null,function*(){if(s){const{from:a,to:r,replaceWith:o,empty:d}=s.state.selection;if(d){const l=s.getHTML(),c=yield t(l);s.chain().focus().setContent(c).run()}else{const l=s.view.state.doc.textBetween(a,r," "),c=yield t(l);s.chain().focus().deleteSelection().insertContent(c).run()}}});return s?e.jsx(v,{gap:"3",align:"center",children:e.jsx(L,{"aria-label":"Parse timestamps from message",onClick:n,title:"Parse timestamps from message",variant:"ghost",size:"1",className:$,disabled:!s.can().chain().focus().run(),children:e.jsx(nt,x({},F))})}):e.jsx(U,{})},In=Ts.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something â€¦",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new Es({key:new Be("placeholder"),props:{decorations:({doc:s,selection:t})=>{const n=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:a}=t,r=[];if(!n)return null;const o=this.editor.isEmpty;return s.descendants((d,l)=>{const c=a>=l&&a<=l+d.nodeSize,f=!d.isLeaf&&Yt(d);if((c||!this.options.showOnlyCurrent)&&f){const C=[this.options.emptyNodeClass];o&&C.push(this.options.emptyEditorClass);const N=Gt.node(l,l+d.nodeSize,{class:C.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:d,pos:l,hasAnchor:c}):this.options.placeholder});r.push(N)}return this.options.includeChildren}),Wt.create(s,r)}}})]}}),An=u.forwardRef((s,t)=>{const[n,a]=u.useState(0),r=c=>{const f=s==null?void 0:s.items[c];f&&s.command({id:f.name,label:f.full_name})},o=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},d=()=>{a((n+1)%(s==null?void 0:s.items.length))},l=()=>{r(n)};return u.useEffect(()=>a(0),[s==null?void 0:s.items]),u.useImperativeHandle(t,()=>({onKeyDown:({event:c})=>c.key==="ArrowUp"?(o(),!0):c.key==="ArrowDown"?(d(),!0):c.key==="Enter"?(l(),!0):!1})),e.jsx($e,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(v,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-96 rounded-md",children:s!=null&&s.items.length?s.items.map((c,f)=>e.jsx(Bn,{item:c,index:f,selectItem:r,selectedIndex:n,itemsLength:s.items.length},c.name)):e.jsx("div",{className:"item",children:"No result"})})})}),Bn=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{const o=at(s.name),d=u.useRef(null);return u.useEffect(()=>{var l;t===a&&((l=d.current)==null||l.scrollIntoView({block:"nearest"}))},[a,t]),e.jsxs(v,{role:"button",ref:d,align:"center",title:s.full_name,"aria-label":`Mention ${s.full_name}`,className:J("px-3 py-1.5 gap-2 rounded-md",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:[e.jsx(Ee,{src:s.user_image,alt:s.full_name,loading:"lazy",variant:"solid",radius:"full",isActive:o,availabilityStatus:s.availability_status}),e.jsxs(fe,{width:"100%",justify:"between",align:"center",gap:"2",children:[e.jsxs(P,{as:"span",weight:"medium",size:"2",children:[" ",s.full_name]}),e.jsx(P,{as:"span",color:"gray",children:!s.is_member&&e.jsx(rt,{title:"This user is not a member of the channel"})})]})]},t)},zn=u.forwardRef((s,t)=>{const[n,a]=u.useState(0),r=c=>{const f=s==null?void 0:s.items[c];f&&s.command({id:f.name,label:f.channel_name})},o=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},d=()=>{a((n+1)%(s==null?void 0:s.items.length))},l=()=>{r(n)};return u.useEffect(()=>a(0),[s==null?void 0:s.items]),u.useImperativeHandle(t,()=>({onKeyDown:({event:c})=>c.key==="ArrowUp"?(o(),!0):c.key==="ArrowDown"?(d(),!0):c.key==="Enter"?(l(),!0):!1})),e.jsx($e,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(v,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-64 rounded-md",children:s!=null&&s.items.length?s.items.map((c,f)=>e.jsx(Ln,{item:c,index:f,selectItem:r,selectedIndex:n,itemsLength:s.items.length},c.name)):e.jsx("div",{className:"item",children:"No result"})})})}),Ln=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{const o=u.useRef(null);return u.useEffect(()=>{var d;t===a&&((d=o.current)==null||d.scrollIntoView({block:"nearest"}))},[a,t]),e.jsxs(v,{role:"button",align:"center",ref:o,title:s.channel_name,"aria-label":`Mention channel ${s.channel_name}`,className:J("px-3 py-2 gap-2 rounded-md",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:[e.jsx(ze,{type:s.type,size:"18"}),e.jsxs(P,{as:"span",weight:"medium",size:"2",children:[" ",s.channel_name]})]},t)};function Pn(s){return it({attr:{fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{strokeLinecap:"round",strokeLinejoin:"round",d:"M12.75 8.25v7.5m6-7.5h-3V12m0 0v3.75m0-3.75H18M9.75 9.348c-1.03-1.464-2.698-1.464-3.728 0-1.03 1.465-1.03 3.84 0 5.304 1.03 1.464 2.699 1.464 3.728 0V12h-1.5M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"},child:[]}]})(s)}const Fn=()=>{const{editor:s}=Z(),[t,n]=u.useState(!1);return u.useEffect(()=>{const a=r=>{r.key==="k"&&(r.metaKey||r.ctrlKey)&&r.shiftKey&&(r.preventDefault(),n(o=>!o))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[]),s?e.jsxs(ce,{open:t,onOpenChange:n,children:[e.jsx(X,{content:`Insert a command (${R()} + Shift + K)`,children:e.jsx(L,{size:"1",variant:"ghost",className:$,onClick:()=>n(!0),title:"Insert a Command","aria-label":"insert a command",children:e.jsx(lt,x({},F))})}),e.jsxs(oe,{className:Ce,children:[e.jsx(je,{children:"Insert a command"}),e.jsx(pe,{size:"2",children:"Select a saved command to insert into your message."}),e.jsx($n,{onClose:()=>n(!1)})]})]}):null},$n=({onClose:s})=>{const{editor:t}=Z(),n=de(),{data:a,isLoading:r}=cs("raven.api.ai_features.get_saved_prompts",{}),o=Oe();return e.jsxs(he,{label:"Global Command Menu",className:"command-menu",children:[e.jsx(he.Input,{autoFocus:n,className:"ml-0 my-2 text-base italic",placeholder:"Search saved prompts"}),e.jsxs(he.List,{children:[e.jsx(he.Empty,{className:"py-4",children:e.jsxs(os,{align:"center",justify:"center",gap:"2",children:[e.jsx(P,{size:"2",color:"gray",weight:"medium",children:"No saved prompts found"}),e.jsx(U,{children:e.jsx(Y,{className:"not-cal",variant:"soft",onClick:()=>o("/settings/commands"),children:"Create"})})]})}),r&&e.jsx(he.Loading,{children:"Loading..."}),a==null?void 0:a.message.map(d=>e.jsx(he.Item,{onSelect:()=>{t==null||t.chain().focus().insertContent(d.prompt).run(),s()},keywords:[d.prompt],value:d.prompt,children:d.prompt},d.name))]})]})},Is=()=>({recentlyUsedDoctypes:u.useMemo(()=>{var a;const n=(a=sessionStorage.getItem("recently-used-doctype"))!=null?a:"[]";return JSON.parse(n).map(r=>({value:r,description:"Recently used"}))},[]),addRecentlyUsedDocType:n=>{var o;const a=(o=sessionStorage.getItem("recently-used-doctype"))!=null?o:"[]";let r=JSON.parse(a);r.includes(n)||(r=[n,...r].slice(0,5)),sessionStorage.setItem("recently-used-doctype",JSON.stringify(r))}}),On=({channelID:s})=>{const[t,{off:n},a]=ds();return e.jsxs(ce,{open:t,onOpenChange:a,children:[e.jsx(X,{content:"Attach a document from the system",children:e.jsx(us,{children:e.jsx(L,{"aria-label":"Attach a document from the system",variant:"ghost",className:$,size:"1",title:"Attach a document from the system",children:e.jsx(ct,x({},F))})})}),e.jsxs(oe,{className:"static",children:[e.jsx(je,{className:"mb-1",children:"Send a document"}),e.jsx(pe,{size:"2",children:"Choose a document from the system to send."}),e.jsx(Rn,{channelID:s,onClose:n})]})]})},Rn=({channelID:s,onClose:t})=>{var j,y;const{loading:n,error:a,createDoc:r}=ms(),o=Re(),{watch:d}=o,l=()=>{o.reset(),t()},c=d("doctype"),f=d("docname"),{recentlyUsedDoctypes:C,addRecentlyUsedDocType:N}=Is(),k=S=>{N(S.doctype),r("Raven Message",{message_type:"Text",channel_id:s,text:S.message,link_doctype:S.doctype,link_document:S.docname}).then(()=>{l()})},p=()=>{o.setValue("docname","")};return e.jsx("form",{className:"pt-2",onSubmit:o.handleSubmit(k),children:e.jsx(He,I(x({},o),{children:e.jsxs(os,{gap:"2",children:[a&&e.jsx(ue,{error:a}),e.jsx(U,{width:"100%",children:e.jsxs(v,{direction:"column",gap:"2",children:[e.jsx(Me,{name:"doctype",label:"Document Type",autofocus:!0,suggestedItems:C,required:!0,rules:{required:"Document Type is required",onChange:p},filters:[["issingle","=",0],["istable","=",0]],doctype:"DocType"}),e.jsx(_e,{children:(j=o.formState.errors.doctype)==null?void 0:j.message})]})}),c&&e.jsx(U,{width:"100%",children:e.jsxs(v,{direction:"column",gap:"2",children:[e.jsx(Me,{name:"docname",required:!0,label:"Document Name",placeholder:"Select a document",disabled:!c,rules:{required:"Document Name is required"},doctype:c}),e.jsx(_e,{children:(y=o.formState.errors.docname)==null?void 0:y.message})]})}),e.jsx("div",{className:J("transition-all duration-500",f?"opacity-100":"opacity-0"),children:c&&f&&e.jsx(bn,{doctype:c,docname:f})}),e.jsx(U,{width:"100%",children:e.jsxs(v,{direction:"column",gap:"0",children:[e.jsxs(hs,{children:["Message ",e.jsx(P,{as:"span",size:"1",color:"gray",children:"(Optional)"})]}),e.jsx(ot,I(x({},o.register("message")),{placeholder:"Enter a message to send with the document"}))]})}),e.jsxs(v,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(xe,{disabled:n,children:e.jsx(Y,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(Y,{type:"button",disabled:n,onClick:o.handleSubmit(k),children:[n&&e.jsx(K,{className:"text-white"}),"Send"]})]})]})}))})},Hn=u.lazy(()=>ve(()=>import("./EmojiPicker-CjG13MvQ.js"),__vite__mapDeps([3,1,2,4]))),Un=u.lazy(()=>ve(()=>import("./CreatePoll-DTsmGZGj.js"),__vite__mapDeps([5,1,2,6]))),Vn=u.lazy(()=>ve(()=>import("./GIFPicker-BBjmArqO.js"),__vite__mapDeps([7,1,2,8,9]))),Kn=r=>{var o=r,{fileProps:s,channelID:t,isEdit:n}=o,a=V(o,["fileProps","channelID","isEdit"]);return e.jsxs(v,{gap:"2",align:"center",px:"1",py:"1",children:[e.jsxs(v,{gap:"3",align:"center",children:[!n&&t&&e.jsx(On,{channelID:t}),e.jsx(qn,{})]}),e.jsx(le,{orientation:"vertical"}),e.jsxs(v,{gap:"3",align:"center",children:[e.jsx(Fn,{}),t&&e.jsx(Wn,{channelID:t})]}),e.jsx(le,{orientation:"vertical"}),e.jsxs(v,{gap:"3",align:"center",children:[e.jsx(Jn,{}),e.jsx(Yn,{}),s&&e.jsx(Gn,{fileProps:s})]}),e.jsx(le,{orientation:"vertical"}),e.jsx(As,x({},a))]})},qn=()=>{const{editor:s}=Z();return s?e.jsxs(v,{gap:"3",children:[e.jsx(L,{onClick:()=>s.chain().focus().insertContent("#").run(),"aria-label":"mention channel",title:"Mention a channel",className:$,variant:"ghost",size:"1",disabled:!s.can().chain().focus().insertContent("#").run()||!s.isEditable,children:e.jsx(jt,x({},F))}),e.jsx(L,{onClick:()=>s.chain().focus().insertContent("@").run(),"aria-label":"mention user",variant:"ghost",className:$,size:"1",title:"Mention a user",disabled:!s.can().chain().focus().insertContent("@").run()||!s.isEditable,children:e.jsx(pt,x({},F))})]}):null},Jn=()=>{const{editor:s}=Z();if(!s)return null;const t=(n,a,r)=>{a?s.chain().focus().setImage({src:n,alt:r,title:r}).run():s.chain().focus().insertContent(n).run()};return e.jsxs(gs,{children:[e.jsx(fs,{children:e.jsx(L,{size:"1",variant:"ghost",className:$,title:"Add emoji",disabled:!s.can().chain().focus().insertContent("ðŸ˜…").run()||!s.isEditable,"aria-label":"add emoji",children:e.jsx(yt,x({},F))})}),e.jsx(xs,{children:e.jsx(Ve,{children:e.jsx(u.Suspense,{fallback:e.jsx(K,{}),children:e.jsx(Hn,{onSelect:t,allowCustomEmojis:!1})})})})]})},Yn=()=>{const{editor:s}=Z();return s?e.jsxs(gs,{children:[e.jsx(fs,{children:e.jsx(L,{size:"1",variant:"ghost",className:$,title:"Add GIF","aria-label":"add GIF",children:e.jsx(Pn,x({},F))})}),e.jsx(xs,{children:e.jsx(Ve,{children:e.jsx(u.Suspense,{fallback:e.jsx(K,{}),children:e.jsx(Vn,{onSelect:t=>s.chain().focus().setImage({src:t.media_formats.gif.url}).setHardBreak().run()})})})})]}):null},Gn=({fileProps:s})=>{const{editor:t}=Z(),n=()=>{var a,r;(a=s.fileInputRef)!=null&&a.current&&((r=s.fileInputRef)==null||r.current.openFileInput())};return e.jsx(L,{size:"1",onClick:n,variant:"ghost",className:$,disabled:(t==null?void 0:t.isEditable)===!1,title:"Attach file","aria-label":"attach file",children:e.jsx(wt,x({},F))})},As=o=>{var d=o,{sendMessage:s,messageSending:t,setContent:n,boxProps:a}=d,r=V(d,["sendMessage","messageSending","setContent","boxProps"]);const{editor:l}=Z(),c=(f=!1)=>{if(l){const C=l.getText().trim().length>0,N=l.getHTML().includes("img");let k="",p={};if(C||N){p=l.getJSON();const j=p.content;for(let y=j.length-1;y>=0&&(j[y].type==="paragraph"&&(!j[y].content||j[y].content.length===0));y--)j.pop();p.content=j,l.commands.setContent(p),k=l.getHTML()}l.setEditable(!1),s(k,p,f).then(()=>{n(""),l.chain().focus().clearContent(!0).run(),l.setEditable(!0)}).catch(()=>{l.setEditable(!0)})}};return e.jsxs(fe,I(x({gap:"2",align:"center"},a),{className:J("bg-accent-a2 py-1 px-1 rounded-radius2",a==null?void 0:a.className),children:[e.jsx(L,I(x({"aria-label":"send message",title:"Send message",size:"1",variant:"ghost",onClick:()=>c()},r),{className:J("rounded-r-none",r==null?void 0:r.className),children:t?e.jsx(K,{}):e.jsx(dt,x({},F))})),e.jsxs(ut,{children:[e.jsx(mt,{children:e.jsx(L,I(x({"aria-label":"send message",title:"Other options",variant:"ghost",size:"1"},r),{className:J("rounded-l-none",r==null?void 0:r.className),children:e.jsx(ht,I(x({},F),{className:"text-accent-a8"}))}))}),e.jsx(gt,{children:e.jsxs(ft,{onClick:()=>c(!0),children:[e.jsx(xt,{}),"Send without notification"]})})]})]}))},Wn=({channelID:s})=>{const[t,,n]=ds(!1),{editor:a}=Z();return e.jsxs(ce,{open:t,onOpenChange:n,children:[e.jsx(us,{children:e.jsx(L,{size:"1",variant:"ghost",className:$,disabled:(a==null?void 0:a.isEditable)===!1,title:"Create Poll","aria-label":"create poll",children:e.jsx(bt,{})})}),e.jsxs(oe,{className:Ce,children:[e.jsx(je,{children:"Create Poll"}),e.jsx(pe,{size:"2",children:"Create a quick poll to get everyone's thoughts on a topic."}),e.jsx(u.Suspense,{fallback:e.jsx(K,{}),children:e.jsx(Un,{channelID:s,setIsOpen:n})})]})]})},Xn=u.forwardRef((s,t)=>{const[n,a]=u.useState(0),r=c=>{const f=s==null?void 0:s.items[c];f&&s.command(f)},o=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},d=()=>{a((n+1)%(s==null?void 0:s.items.length))},l=()=>{r(n)};return u.useEffect(()=>a(0),[s==null?void 0:s.items]),u.useImperativeHandle(t,()=>({onKeyDown:({event:c})=>c.key==="ArrowUp"?(o(),!0):c.key==="ArrowDown"?(d(),!0):c.key==="Enter"?(l(),!0):!1})),e.jsx($e,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(v,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-96 rounded-md",children:s!=null&&s.items.length?s.items.map((c,f)=>{var C;return e.jsx(Zn,{item:c,index:f,selectItem:r,selectedIndex:n,itemsLength:s.items.length},(C=c.shortcodes)!=null?C:c.id)}):null})})}),Zn=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{var d;const o=u.useRef(null);return u.useEffect(()=>{var l;t===a&&((l=o.current)==null||l.scrollIntoView({block:"nearest"}))},[a,t]),e.jsx(v,{role:"button",ref:o,align:"center",title:s.id,"aria-label":`Select emoji ${s.id}`,className:J("px-3 py-1.5 gap-2 rounded-md cursor-pointer",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:e.jsxs(P,{as:"span",weight:"medium",size:"2",children:[e.jsx("em-emoji",{shortcodes:s.shortcodes})," ",(d=s.shortcodes)!=null?d:s.id]})},t)};function Qn(s,t=10){return q(this,null,function*(){const n=yield ps.search(s,{maxResults:t,caller:void 0}),a=[];return n.forEach(r=>{r&&r.skins[0].native&&a.push({shortcodes:r.skins[0].shortcodes,emoji:r.skins[0].native,name:r.name,id:r.id})}),a})}function ea(s=10){const t=js.get({maxFrequentRows:1,perLine:s}),n=[];return t.forEach(a=>{const r=ps.get(a);r&&r.skins[0].native&&n.push({id:r.id,shortcodes:r.skins[0].shortcodes,emoji:r.skins[0].native,name:r.name})}),n}const sa=Xt.create({name:"emoji",group:"inline",pluginKey:new Be("emojiSuggestion"),inline:!0,selectable:!1,atom:!0,addProseMirrorPlugins(){return[un({editor:this.editor,char:":",allowedPrefixes:null,items:s=>s.query.length!==0?Qn(s.query):ea(),render:()=>{let s,t;return{onStart:n=>{s=new Le(Xn,{props:n,editor:n.editor}),n.clientRect&&(t=Pe("body",{getReferenceClientRect:n.clientRect,appendTo:()=>document.body,content:s.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(n){s.updateProps(n),n.clientRect&&t[0].setProps({getReferenceClientRect:n.clientRect})},onKeyDown(n){var a;return n.event.key==="Escape"?(t[0].hide(),!0):(a=s.ref)==null?void 0:a.onKeyDown(n)},onExit(){t[0].destroy(),s.destroy()}}},command:({editor:s,range:t,props:n})=>{var a;s.chain().focus().deleteRange(t).insertContent(n.emoji).run(),js.add(n.id),(a=window.getSelection())==null||a.collapseToEnd()}})]}}),ta=u.lazy(()=>ve(()=>import("./MobileInputActions-BKU8hK_m.js"),__vite__mapDeps([10,1,2,11,12,13,14,15,16,17,18,19,8,20,21,22,23,24]))),me=en(nn);me.register("html",an);me.register("css",rn);me.register("js",ln);me.register("ts",cn);me.register("json",on);me.register("python",dn);const na=Ms.extend({name:"userMention"}).configure({suggestion:{char:"@",pluginKey:new Be("userMention"),allowedPrefixes:null,allow:s=>{const t=s.state.doc.textBetween(s.range.from-1,s.range.from,"");return!/[a-zA-Z0-9]/.test(t)}}}),aa=Ms.extend({name:"channelMention"}).configure({suggestion:{char:"#",pluginKey:new Be("channelMention"),allowedPrefixes:null,allow:s=>{const t=s.state.doc.textBetween(s.range.from-1,s.range.from,"");return!/[a-zA-Z0-9]/.test(t)}}}),ra=u.forwardRef(({isEdit:s,slotBefore:t,fileProps:n,onMessageSend:a,onUpArrow:r,channelMembers:o,onUserType:d,channelID:l,replyMessage:c,clearReplyMessage:f,placeholder:C="Type a message...",messageSending:N,sessionStorageKey:k="tiptap-editor",disableSessionStorage:p=!1,defaultText:j=""},y)=>{const{enabledUsers:S}=u.useContext(bs),b=u.useRef([]);u.useEffect(()=>{o?b.current=S.map(i=>I(x({},i),{is_member:i.name in o})).sort((i,h)=>i.is_member?-1:1):b.current=S.map(i=>I(x({},i),{is_member:!0}))},[o,S]);const{channels:D}=u.useContext(ys),{workspaceID:E}=ws(),M=_s(),[z]=ls(yn),Q=i=>{const h=i.getText().trim().length>0;let g="",w={};return h&&(g=i.getHTML(),w=i.getJSON()),i.setEditable(!1),a(g,w).then(()=>{i.commands.clearContent(!0),i.setEditable(!0),i.commands.focus("start")}).catch(()=>{i.setEditable(!0)}),i.commands.clearContent(!0)},se=i=>i.commands.first(({commands:h})=>[()=>h.newlineInCode(),()=>h.createParagraphNear(),()=>h.liftEmptyBlock(),()=>h.splitBlock()]),G=Ts.create({name:"keyboardHandler",addKeyboardShortcuts(){return{Enter:()=>{if(matchMedia("(max-device-width: 768px)").matches||matchMedia("(max-device-width: 1024px)").matches)return!1;const i=this.editor.isActive("codeBlock"),h=this.editor.isActive("listItem");return i||h?!1:z==="send-message"?Q(this.editor):se(this.editor)},"Mod-Enter":()=>{const i=this.editor.isActive("codeBlock"),h=this.editor.isActive("listItem"),g=this.editor.getText().trim().length>0;if(i)return this.editor.commands.newlineInCode();if(h)return!1;if(!i&&!h){let w="",B={};return g&&(w=this.editor.getHTML(),B=this.editor.getJSON()),this.editor.setEditable(!1),a(w,B).then(()=>{this.editor.commands.clearContent(!0),this.editor.setEditable(!0)}).catch(()=>{this.editor.setEditable(!0)}),this.editor.commands.clearContent(!0)}return!1},Backspace:()=>this.editor.isEmpty?(f==null||f(),this.editor.commands.clearContent(!0)):!1,"Shift-Enter":()=>se(this.editor),ArrowUp:()=>(this.editor.isEmpty&&(r==null||r()),!1)}},addProseMirrorPlugins(){return[new Es({props:{handleDOMEvents:{drop(i,h){if(!(h.dataTransfer&&h.dataTransfer.files&&h.dataTransfer.files.length)||!n)return;const w=Array.from(h.dataTransfer.files).filter(B=>/image/i.test(B.type));w.length!==0&&(h.preventDefault(),w.forEach(B=>{n.addFile(B)}))},paste(i,h){if(!(h.clipboardData&&h.clipboardData.files&&h.clipboardData.files.length)||!n)return;const w=Array.from(h.clipboardData.files);w.length!==0&&(h.preventDefault(),w.forEach(B=>{n.addFile(B)}))}}}})]}}),te=[Zt.configure({heading:!1,codeBlock:!1,listItem:{HTMLAttributes:{class:"rt-Text text-sm"}},paragraph:{HTMLAttributes:{class:"rt-Text text-sm"}},code:{HTMLAttributes:{class:"pt-0.5 px-1 pb-px bg-[var(--gray-a3)] dark:bg-[#0d0d0d] text-[var(--ruby-a11)] dark-[var(--accent-a3)] text text-xs font-mono rounded border border-gray-4 dark:border-gray-6"}}}),mn,hn.configure({multicolor:!0,HTMLAttributes:{class:"bg-[var(--yellow-6)] dark:bg-[var(--yellow-11)] px-2 py-1"}}),gn.extend({inclusive:!1}).configure({autolink:!0}),In.configure({placeholder:C}),Qt.extend({addKeyboardShortcuts(){var i;return I(x({},(i=this.parent)==null?void 0:i.call(this)),{"Mod-Shift-E":()=>this.editor.commands.toggleCodeBlock()})}}).configure({lowlight:me}),fn.configure({inline:!0}),G,na.configure({HTMLAttributes:{class:"mention"},renderHTML({options:i,node:h}){var g;return`${i.suggestion.char}${(g=h.attrs.label)!=null?g:h.attrs.id}`},suggestion:{items:i=>b.current.filter(h=>h.full_name.toLowerCase().startsWith(i.query.toLowerCase())).slice(0,10),render:()=>{let i,h;return{onStart:g=>{i=new Le(An,{props:g,editor:g.editor}),g.clientRect&&(h=Pe("body",{getReferenceClientRect:g.clientRect,appendTo:()=>document.body,content:i.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(g){i.updateProps(g),g.clientRect&&h[0].setProps({getReferenceClientRect:g.clientRect})},onKeyDown(g){var w;return g.event.key==="Escape"?(h[0].hide(),!0):(w=i.ref)==null?void 0:w.onKeyDown(g)},onExit(){h[0].destroy(),i.destroy()}}}}}),aa.configure({HTMLAttributes:{class:"mention"},renderHTML({options:i,node:h}){var g;return`${i.suggestion.char}${(g=h.attrs.label)!=null?g:h.attrs.id}`},suggestion:{items:i=>D.filter(h=>h.workspace===E&&h.channel_name.toLowerCase().startsWith(i.query.toLowerCase())).slice(0,10),render:()=>{let i,h;return{onStart:g=>{i=new Le(zn,{props:g,editor:g.editor}),g.clientRect&&(h=Pe("body",{getReferenceClientRect:g.clientRect,appendTo:()=>document.body,content:i.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(g){i.updateProps(g),g.clientRect&&h[0].setProps({getReferenceClientRect:g.clientRect})},onKeyDown(g){var w;return g.event.key==="Escape"?(h[0].hide(),!0):(w=i.ref)==null?void 0:w.onKeyDown(g)},onExit(){h[0].destroy(),i.destroy()}}}}}),sa,xn],[ne,T]=_t(j,k,p),A=de(),m=sn({extensions:te,content:ne,editorProps:{handleTextInput(){d==null||d()},attributes:{class:"tiptap-editor"+(c?" replying":"")+(s?" editing-message":"")}},onUpdate({editor:i}){T(i.getHTML())}},[c,d]);return u.useEffect(()=>{(A||s)&&setTimeout(()=>{m==null||m.chain().focus("end").run()},50)},[m,A,s,c]),u.useImperativeHandle(y,()=>({focusEditor:()=>{m==null||m.chain().focus().run()}})),M?e.jsx(U,{className:J("pt-2 pb-8 w-full bg-white dark:bg-gray-2 z-50 border-t border-t-gray-3 dark:border-t-gray-3",s?"bg-transparent dark:bg-transparent":"fixed bottom-0 left-0 px-4"),children:e.jsxs(Ge.Provider,{value:{editor:m},children:[t,e.jsxs(v,{align:"end",gap:"2",className:"w-full",children:[!s&&e.jsx("div",{className:"w-8",children:e.jsx(u.Suspense,{fallback:e.jsx(L,{radius:"full",color:"gray",variant:"soft",size:"2",className:"mb-1",children:e.jsx(vt,{size:"20"})}),children:e.jsx(ta,{fileProps:n,setContent:T,sendMessage:a,messageSending:N,channelID:l})})}),e.jsx(tn,{tippyOptions:{arrow:!0,offset:[90,15],inlinePositioning:!0},editor:m,children:e.jsx("div",{className:"bg-gray-1 dark:bg-gray-3 shadow-md p-2 rounded-md",children:e.jsx(Ze,{})})}),e.jsxs("div",{className:"border-[1.5px] flex items-end justify-between border-gray-4 rounded-radius2 w-[calc(100vw-72px)] focus-within:border-accent-a8",children:[e.jsx("div",{className:"w-[85%]",children:e.jsx(We,{editor:m})}),e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(As,{size:"2",variant:"soft",boxProps:{className:"rounded-r-radius2 rounded-l-none bg-transparent",gap:"0"},className:"bg-transparent hover:bg-accent-a3",sendMessage:a,messageSending:N,setContent:T})})]})]})]})}):e.jsx(U,{className:"border rounded-radius2 border-gray-300 dark:border-gray-500 dark:bg-gray-3",children:e.jsxs(Ge.Provider,{value:{editor:m},children:[t,e.jsx(We,{editor:m}),e.jsxs(Mn,{children:[e.jsx(Ze,{}),e.jsx(Kn,{fileProps:n,setContent:T,sendMessage:a,messageSending:N,isEdit:s,channelID:l})]})]})})}),Ha=(s,t,n,a)=>{const{call:r,loading:o}=we("raven.api.raven_message.send_message"),d=Ct(u.useCallback(c=>c(Ds(s)),[s]));return{sendMessage:u.useCallback((c,f,C=!1)=>q(null,null,function*(){const k=d().length>0;return c&&k?t(a,c).then(p=>{n(p)}):c?r({channel_id:s,text:c,json_content:f,is_reply:a?1:0,linked_message:a?a.name:null,send_silently:!!C}).then(p=>n([p.message])):k?t(a).then(p=>{n(p)}):Promise.resolve()}),[s,a,t,n]),loading:o}},Ua=u.forwardRef((s,t)=>{const D=s,{files:n,onFileChange:a,maxFiles:r,accept:o,maxFileSize:d,children:l,height:c,width:f,areaHeight:C}=D,N=V(D,["files","onFileChange","maxFiles","accept","maxFileSize","children","height","width","areaHeight"]),[k,p]=u.useState(!1),j=E=>d&&E.size>d*1e6?(ee.error(`Uh Oh! ${E.name} exceeded the maximum file size required.`),{code:"size-too-large",message:"File size is larger than the required size."}):null,{getRootProps:y,getInputProps:S,open:b}=kt({onDrop:(E,M)=>{a([...n,...E.map(z=>Object.assign(z,{fileID:z.name+Date.now(),uploadProgress:0}))]),r&&r<M.length&&ee.error(`Uh Oh! Maximum ${r} files can be uploaded. Please try again.`)},maxFiles:r||0,accept:o||void 0,validator:j,noClick:!0,noKeyboard:!0,onDragEnter:()=>p(!0),onDragLeave:()=>p(!1),onDropAccepted:()=>p(!1),onDropRejected:()=>p(!1)});return u.useImperativeHandle(t,()=>({openFileInput(){b()}})),e.jsxs(v,I(x(x({direction:"column",style:{height:c!=null?c:"calc(100vh - 80px)"},width:"100%"},y()),N),{children:[l,(r===void 0||n.length<r)&&e.jsxs(v,{align:"center",justify:"center",className:J("fixed top-14 border-2 border-dashed rounded-md border-gray-6 dark:bg-[#171923AA] bg-[#F7FAFCAA]",C!=null?C:"h-[calc(100vh-72px)]",f!=null?f:"w-[calc(100vw-var(--sidebar-width)-var(--space-8))]"),style:{zIndex:9999},display:k?"flex":"none",children:[e.jsx(P,{as:"span",size:"2",color:"gray",children:"Drop your files here. A Raven will pick it up."}),e.jsx("input",x({type:"file",style:{display:"none"}},S()))]})]}))}),ia=({onClose:s,message:t})=>{const{deleteDoc:n,error:a,loading:r}=Nt(),o=Oe(),d=()=>q(null,null,function*(){return n("Raven Message",t.name).then(()=>{ee("Message deleted",{duration:800}),t.is_thread&&o(`/channel/${t.channel_id}`),s()})});return e.jsxs(e.Fragment,{children:[e.jsxs(St,{children:["Delete ",t.is_thread?"Thread":"Message"]}),e.jsxs(v,{direction:"column",gap:"2",children:[e.jsxs(vs,{color:"red",size:"1",children:[e.jsx(Cs,{children:e.jsx(Tt,{size:"18"})}),e.jsx(ks,{size:"2",children:"This action is permanent and cannot be undone."})]}),e.jsx(ue,{error:a}),t.is_thread?e.jsx(P,{size:"2",children:"This message is a thread, deleting it will delete all messages in the thread."}):e.jsx(P,{size:"2",children:"Are you sure you want to delete this message? It will be deleted for all users."})]}),e.jsxs(v,{gap:"3",mt:"4",justify:"end",children:[e.jsx(Et,{children:e.jsx(Y,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsx(Mt,{children:e.jsxs(Y,{variant:"solid",color:"red",onClick:d,disabled:r,children:[r&&e.jsx(K,{className:"text-white"}),r?"Deleting":"Delete"]})})]})]})},la=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setDeleteMessage:n,isOpen:t!==null,onClose:a}},ca=({message:s,isOpen:t,onClose:n})=>e.jsx(Dt,{open:t,onOpenChange:n,children:e.jsx(It,{className:Ce,children:s&&e.jsx(ia,{onClose:n,message:s})})}),Qe=({onClose:s,message:t})=>{const{updateDoc:n,error:a,loading:r,reset:o}=At();u.useEffect(()=>{o()},[o]);const d=(l,c)=>q(null,null,function*(){return n("Raven Message",t.name,{text:l,json:c}).then(f=>{s(!0),ee.info("Message updated")})});return e.jsxs(e.Fragment,{children:[e.jsxs(v,{justify:"between",children:[e.jsx(je,{children:"Edit Message"}),e.jsx(Ns,{children:e.jsx(pe,{children:"Type in the new message text"})}),e.jsx(xe,{disabled:r,className:"invisible sm:visible",children:e.jsx(L,{size:"1",variant:"soft",color:"gray",children:e.jsx(Ue,{size:"18"})})})]}),e.jsxs(v,{gap:"2",direction:"column",children:[e.jsx(ue,{error:a}),e.jsx(ra,{onMessageSend:d,isEdit:!0,disableSessionStorage:!0,messageSending:r,defaultText:t.text}),e.jsx(v,{justify:"end",className:"hidden sm:block",children:e.jsxs(P,{size:"1",color:"gray",children:["Press ",e.jsx("b",{children:"Enter"})," to save"]})})]})]})},oa=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setEditMessage:n,isOpen:t!==null,onClose:a}},da=({message:s,isOpen:t,onClose:n})=>de()?e.jsx(ce,{open:t,onOpenChange:n,children:e.jsx(oe,{className:Ce,children:s&&e.jsx(Qe,{message:s,onClose:n})})}):e.jsx(Ie,{open:t,onClose:n,children:e.jsx(Ae,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(Qe,{message:s,onClose:n})})})}),ua=(s,t,n)=>{var T,A;Bt(),Oe();const a=_s(),{currentUser:r}=u.useContext(Ss),[o,d]=zt(),l=o.get("message_id"),[c,f]=u.useState(l||null);u.useEffect(()=>{let m=null;return c&&(m=setTimeout(()=>{f(null)},4e3)),()=>{m&&clearTimeout(m)}},[c]);const{call:C,loading:N}=we("raven.api.chat_stream.get_older_messages"),{call:k,loading:p}=we("raven.api.chat_stream.get_newer_messages"),j=u.useRef(!1),y=(m="auto")=>{if(!t.current)return;requestAnimationFrame(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})});const i=setTimeout(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})},100),h=setTimeout(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})},500);return()=>{clearTimeout(i),clearTimeout(h)}},S=(m,i="smooth")=>{requestAnimationFrame(()=>{var w;(w=document.getElementById(`message-${m}`))==null||w.scrollIntoView({behavior:i,block:"center"})});const h=setTimeout(()=>{var w;(w=document.getElementById(`message-${m}`))==null||w.scrollIntoView({behavior:i,block:"center"})},100),g=setTimeout(()=>{var w;(w=document.getElementById(`message-${m}`))==null||w.scrollIntoView({behavior:i,block:"center"})},250);return()=>{clearTimeout(h),clearTimeout(g)}},{data:b,isLoading:D,error:E,mutate:M}=cs("raven.api.chat_stream.get_messages",{channel_id:s,base_message:l||void 0},{path:`get_messages_for_channel_${s}`,baseMessage:l||void 0},{revalidateOnFocus:!!a,onSuccess:m=>{let i;return c?i=S(c):m.message.has_new_messages||(i=y(),j.current=!0),()=>{i&&i()}}});u.useEffect(()=>{if(!o.get("message_id"))return y()},[s]);const{call:z}=we("raven.api.raven_channel_member.track_visit");u.useEffect(()=>()=>{j.current&&z({channel_id:s})},[s]),Lt("Raven Channel",s!=null?s:"",()=>{}),ge("message_created",m=>{m.channel_id===s&&M(i=>{var h,g,w;if(i&&i.message.has_new_messages===!1){const B=(h=i.message.messages)!=null?h:[],H=[...B];if(m.message_details){const _=B.findIndex(O=>O.name===m.message_details.name);_!==-1?H[_]=m.message_details:H.push(m.message_details)}return H.sort((_,O)=>new Date(O.creation).getTime()-new Date(_.creation).getTime()),{message:{messages:H,has_old_messages:(g=i.message.has_old_messages)!=null?g:!1,has_new_messages:(w=i.message.has_new_messages)!=null?w:!1}}}else return i},{revalidate:!1}).then(()=>{(b==null?void 0:b.message.has_new_messages)===!1&&t.current&&(t.current.scrollTop+t.current.clientHeight>=t.current.scrollHeight-100||m.message_details.owner===r)&&y("smooth")})}),ge("message_edited",m=>{M(i=>m.message_id&&i?{message:{messages:i.message.messages.map(g=>g.name===m.message_id?x(x({},g),m.message_details):g),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}}:i,{revalidate:!1})}),ge("message_deleted",m=>{M(i=>i&&{message:{messages:i.message.messages.filter(g=>g.name!==m.message_id),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}},{revalidate:!1})}),ge("message_reacted",m=>{M(i=>m.message_id&&i?{message:{messages:i.message.messages.map(g=>g.name===m.message_id?I(x({},g),{message_reactions:m.reactions}):g),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}}:i,{revalidate:!1})}),ge("message_saved",m=>{M(i=>m.message_id&&i?{message:{messages:i.message.messages.map(g=>g.name===m.message_id?I(x({},g),{_liked_by:m.liked_by}):g),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}}:i,{revalidate:!1})});const Q=()=>{if(N||!(b!=null&&b.message.has_old_messages))return Promise.resolve();const m=t.current;if(!m)return Promise.resolve();const i=m.scrollHeight,h=m.scrollTop;return M(g=>{let w=null;return g&&g.message.messages.length>0&&g.message.has_old_messages&&(w=g.message.messages[g.message.messages.length-1],w)?C({channel_id:s,from_message:w.name}).then(B=>{var _,O,ke;return{message:{messages:[...g.message.messages,...(_=B==null?void 0:B.message.messages)!=null?_:[]],has_old_messages:(O=B==null?void 0:B.message.has_old_messages)!=null?O:!1,has_new_messages:(ke=g==null?void 0:g.message.has_new_messages)!=null?ke:!1}}}).catch(()=>g):g},{revalidate:!1}).then(()=>{requestAnimationFrame(()=>{if(m){const w=m.scrollHeight-i;m.scrollTop=h+w}})})},se=()=>{if(p||!(b!=null&&b.message.has_new_messages)||c)return Promise.resolve();M(m=>{let i=null;return m&&m.message.messages.length>0&&m.message.has_new_messages&&(i=m.message.messages[0],i)?k({channel_id:s,from_message:i.name,limit:10}).then(h=>{var w,B,H;return{message:{messages:[...(w=h==null?void 0:h.message.messages)!=null?w:[],...m.message.messages],has_old_messages:(B=m==null?void 0:m.message.has_old_messages)!=null?B:!1,has_new_messages:(H=h==null?void 0:h.message.has_new_messages)!=null?H:!1}}}).catch(()=>m):m},{revalidate:!1}).then(m=>{(m==null?void 0:m.message.has_new_messages)===!1&&(j.current=!0,y("smooth"))})},G=u.useMemo(()=>{var m;if(b){let i=(m=n==null?void 0:n.split(`
`))!=null?m:[];i=i.map(w=>w.trim());const h=[...b.message.messages],g=[];if(h.length>0){let w=h[h.length-1].creation.split(" ")[0],B=new Date(h[h.length-1].creation.split(".")[0]).getTime();g.push({creation:Ye(`${w} 00:00:00`).format("Do MMMM YYYY"),message_type:"date",name:w}),g.push(I(x({},h[h.length-1]),{is_continuation:0,is_pinned:i.includes(h[h.length-1].name)?1:0}));for(let H=h.length-2;H>=0;H--){const _=h[H],O=_.creation.split(" ")[0];let ke=new Date(_.creation.split(".")[0]).getTime();O!==w&&g.push({creation:Ye(`${O} 00:00:00`).format("Do MMMM YYYY"),message_type:"date",name:O});const Bs=_.is_bot_message?_.bot:_.owner,Ne=h[H+1],zs=Ne.message_type==="System"?null:Ne.is_bot_message?Ne.bot:Ne.owner;Bs!==zs?g.push(I(x({},_),{is_continuation:0,is_pinned:i.includes(_.name)?1:0})):ke-B>12e4?g.push(I(x({},_),{is_continuation:0,is_pinned:i.includes(_.name)?1:0})):g.push(I(x({},_),{is_continuation:1,is_pinned:i.includes(_.name)?1:0})),w=O,B=new Date(_.creation).getTime()}return g}else return[]}},[b,n]),te=m=>{var h;const i=G==null?void 0:G.findIndex(g=>g.name===m);i!==void 0&&i!==-1?((h=document.getElementById(`message-${m}`))==null||h.scrollIntoView({behavior:"smooth",block:"center"}),f(m)):(d({message_id:m}),f(m))},ne=()=>{d({})};return{messages:G,hasOlderMessages:(T=b==null?void 0:b.message.has_old_messages)!=null?T:!1,hasNewMessages:(A=b==null?void 0:b.message.has_new_messages)!=null?A:!1,loadingOlderMessages:N,isLoading:D,error:E,loadNewerMessages:se,loadOlderMessages:Q,scrollToMessage:te,highlightedMessage:c,goToLatestMessages:ne}},ma=()=>e.jsxs("div",{className:"py-4 animate-fadein",children:[e.jsx(ye,{isContinuation:!0,isShortText:!0}),e.jsx(ye,{isContinuation:!1,isImage:!0}),e.jsx(ye,{isContinuation:!1,isShortText:!0}),e.jsx(ye,{isContinuation:!0,isImage:!0}),e.jsx(ye,{isContinuation:!1,isLongText:!0})]}),ye=({isContinuation:s,isShortText:t,isImage:n,isLongText:a})=>e.jsxs("div",{className:"flex items-start gap-3 p-2",children:[e.jsx("div",{className:"w-8 flex items-center",children:s?e.jsx("div",{}):e.jsx(ha,{})}),e.jsxs("div",{className:"flex flex-col gap-1.5 justify-center",children:[!s&&e.jsxs("div",{className:"flex items-center gap-2 -mt-1",children:[e.jsx(W,{className:"rounded-md w-32 h-5"}),e.jsx(le,{orientation:"vertical"}),e.jsx(W,{className:"rounded-md w-16 h-5"})]}),t&&e.jsxs("div",{className:"gap-1 flex flex-col",children:[e.jsx(W,{className:"rounded-md w-48 h-5"}),e.jsx(W,{className:"rounded-md w-64 h-5"})]}),a&&e.jsxs("div",{className:"gap-1 flex flex-col",children:[e.jsx(W,{className:"rounded-md w-80 h-5"}),e.jsx(W,{className:"rounded-md w-64 h-5"}),e.jsx(W,{className:"rounded-md w-72 h-5"}),e.jsx(W,{className:"rounded-md w-48 h-5"})]}),n&&e.jsx("div",{className:"gap-1 flex flex-col",children:e.jsx(W,{className:"rounded-md w-96 h-64"})})]})]}),ha=()=>e.jsx(W,{className:"w-8 h-8 rounded-md"});var Fe=new Map,Te=new WeakMap,es=0,ga=void 0;function fa(s){return s?(Te.has(s)||(es+=1,Te.set(s,es.toString())),Te.get(s)):"0"}function xa(s){return Object.keys(s).sort().filter(t=>s[t]!==void 0).map(t=>`${t}_${t==="root"?fa(s.root):s[t]}`).toString()}function ja(s){const t=xa(s);let n=Fe.get(t);if(!n){const a=new Map;let r;const o=new IntersectionObserver(d=>{d.forEach(l=>{var c;const f=l.isIntersecting&&r.some(C=>l.intersectionRatio>=C);s.trackVisibility&&typeof l.isVisible=="undefined"&&(l.isVisible=f),(c=a.get(l.target))==null||c.forEach(C=>{C(f,l)})})},s);r=o.thresholds||(Array.isArray(s.threshold)?s.threshold:[s.threshold||0]),n={id:t,observer:o,elements:a},Fe.set(t,n)}return n}function pa(s,t,n={},a=ga){if(typeof window.IntersectionObserver=="undefined"&&a!==void 0){const c=s.getBoundingClientRect();return t(a,{isIntersecting:a,target:s,intersectionRatio:typeof n.threshold=="number"?n.threshold:0,time:0,boundingClientRect:c,intersectionRect:c,rootBounds:c}),()=>{}}const{id:r,observer:o,elements:d}=ja(n),l=d.get(s)||[];return d.has(s)||d.set(s,l),l.push(t),o.observe(s),function(){l.splice(l.indexOf(t),1),l.length===0&&(d.delete(s),o.unobserve(s)),d.size===0&&(o.disconnect(),Fe.delete(r))}}function ss({threshold:s,delay:t,trackVisibility:n,rootMargin:a,root:r,triggerOnce:o,skip:d,initialInView:l,fallbackInView:c,onChange:f}={}){var C;const[N,k]=u.useState(null),p=u.useRef(f),[j,y]=u.useState({inView:!!l,entry:void 0});p.current=f,u.useEffect(()=>{if(d||!N)return;let E;return E=pa(N,(M,z)=>{y({inView:M,entry:z}),p.current&&p.current(M,z),z.isIntersecting&&o&&E&&(E(),E=void 0)},{root:r,rootMargin:a,threshold:s,trackVisibility:n,delay:t},c),()=>{E&&E()}},[Array.isArray(s)?s.toString():s,N,r,a,o,d,n,c,t]);const S=(C=j.entry)==null?void 0:C.target,b=u.useRef(void 0);!N&&S&&!o&&!d&&b.current!==S&&(b.current=S,y({inView:!!l,entry:void 0}));const D=[k,j.inView,j.entry];return D.ref=D[0],D.inView=D[1],D.entry=D[2],D}const ba=r=>{var o=r,{selectedOptions:s,setSelectedOptions:t,label:n="Select Users / Channels"}=o,a=V(o,["selectedOptions","setSelectedOptions","label"]);const d=u.useContext(bs),l=u.useContext(ys),c=[...d.enabledUsers,...l.channels],f=de();function C(k,p){const j=p.toLowerCase();return c.filter(y=>{const S=k.find(b=>b.name===y.name);return"full_name"in y?!S&&(y.full_name.toLowerCase().includes(j)||y.name.toLowerCase().includes(j)):!S&&(y.channel_name.toLowerCase().includes(j)||y.name.toLowerCase().includes(j))})}function N({selectedOptions:k,setSelectedOptions:p}){const[j,y]=u.useState(""),S=u.useMemo(()=>C(k,j),[k,j]),{getSelectedItemProps:b,getDropdownProps:D,removeSelectedItem:E}=be({selectedItems:k,onStateChange({selectedItems:T,type:A}){switch(A){case be.stateChangeTypes.SelectedItemKeyDownBackspace:case be.stateChangeTypes.SelectedItemKeyDownDelete:case be.stateChangeTypes.DropdownKeyDownBackspace:case be.stateChangeTypes.FunctionRemoveSelectedItem:p(T!=null?T:[]);break}}}),{isOpen:M,getLabelProps:z,getMenuProps:Q,getInputProps:se,highlightedIndex:G,getItemProps:te,selectedItem:ne}=ae({items:S,itemToString(T){return T?T.name:""},defaultHighlightedIndex:0,selectedItem:null,inputValue:j,stateReducer(T,A){const{changes:m,type:i}=A;switch(i){case ae.stateChangeTypes.InputKeyDownEnter:case ae.stateChangeTypes.ItemClick:return I(x({},m),{isOpen:!0,highlightedIndex:0});default:return m}},onStateChange({inputValue:T,type:A,selectedItem:m}){switch(A){case ae.stateChangeTypes.InputKeyDownEnter:case ae.stateChangeTypes.ItemClick:case ae.stateChangeTypes.InputBlur:m&&(p([...k,m]),y(""));break;case ae.stateChangeTypes.InputChange:y(T!=null?T:"");break}}});return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(hs,I(x({className:"w-fit"},z()),{children:n})),e.jsx(Pt,x({placeholder:"Type a name...",className:"w-full",autoFocus:f},se(D()))),e.jsx("div",{className:"inline-flex gap-1 p-1 items-center flex-wrap",children:k.map(function(A,m){var i;return"channel_name"in A?e.jsxs("span",I(x({className:"rt-Button rt-BaseButton rt-variant-surface rt-r-size-2 flex items-center"},b({selectedItem:A,index:m})),{children:[e.jsx(ze,{type:A.type,size:"14"}),e.jsx(P,{size:"2",children:A.channel_name}),e.jsx("span",{className:"cursor-pointer",onClick:h=>{h.stopPropagation(),E(A)},children:"âœ•"})]}),`selected-item-${m}`):e.jsxs("span",I(x({className:"rt-Button rt-BaseButton rt-variant-surface rt-r-size-2 flex items-center"},b({selectedItem:A,index:m})),{children:[e.jsx(Ee,{src:(i=A.user_image)!=null?i:"",alt:A.full_name,size:"1",variant:"solid",color:"gray"}),e.jsx(P,{size:"2",children:A.full_name}),e.jsx("span",{className:"cursor-pointer",onClick:h=>{h.stopPropagation(),E(A)},children:"âœ•"})]}),`selected-item-${m}`)})})]}),e.jsx("ul",I(x({className:`sm:w-[550px] w-[24rem] absolute bg-background rounded-b-md mt-1 shadow-md z-[9999] max-h-96 overflow-scroll p-0 ${!(M&&S.length)&&"hidden"}`},Q()),{children:M&&S.map((T,A)=>{var m;return e.jsx("li",I(x({className:J(G===A&&"bg-accent-4",ne===T&&"font-bold","py-2 px-3 shadow-sm flex gap-2 items-center")},te({item:T,index:A})),{children:"channel_name"in T?e.jsxs(fe,{justify:"between",width:"100%",children:[e.jsxs(fe,{gap:"1",align:"center",children:[e.jsx(ze,{type:T.type,size:"14"}),e.jsx(P,{as:"span",weight:"medium",size:"2",children:T.channel_name})]}),e.jsxs(fe,{gap:"1",align:"center",children:[e.jsx(Ft,{color:"gray"}),e.jsx(P,{size:"1",color:"gray",children:T.workspace})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{src:(m=T.user_image)!=null?m:"",alt:T.full_name,size:"2"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(P,{as:"span",weight:"medium",size:"2",children:T.full_name}),e.jsx(P,{as:"span",size:"1",children:T.name})]})]})}),`${T.name}`)})}))]})}return e.jsx(N,{selectedOptions:s,setSelectedOptions:t})},ts=({onClose:s,message:t})=>{var N;const n=Re({defaultValues:{selected_options:null,message:t}}),{handleSubmit:a,reset:r,control:o}=n,{call:d,error:l,loading:c}=we("raven.api.raven_message.forward_message"),f=k=>{k.selected_options&&k.selected_options.length>0&&d({message_receivers:k.selected_options,forwarded_message:k.message}).then(()=>{ee.success("Message forwarded successfully!"),C()}).catch(()=>{ee.error("Failed to forward message")})},C=()=>{r(),s()};return e.jsx(He,I(x({},n),{children:e.jsxs("form",{onSubmit:a(f),children:[e.jsxs(v,{justify:"between",children:[e.jsx(je,{children:"Forward Message"}),e.jsx(Ns,{children:e.jsx(pe,{children:"Forward message to a user or channel"})}),e.jsx(xe,{onClick:C,children:e.jsx(L,{size:"1",variant:"soft",color:"gray",children:e.jsx(Ue,{size:"18"})})})]}),e.jsxs(v,{gap:"2",direction:"column",width:"100%",children:[e.jsx(ue,{error:l}),e.jsx(U,{width:"100%",children:e.jsxs(v,{direction:"column",gap:"2",children:[e.jsx(u.Suspense,{fallback:e.jsx(K,{}),children:e.jsx($t,{control:o,name:"selected_options",rules:{validate:k=>k&&k.length>0?!0:"Please select at least one member"},render:({field:{onChange:k,value:p}})=>e.jsx(ba,{setSelectedOptions:k,selectedOptions:p!=null?p:[]})})}),e.jsx(_e,{children:(N=n.formState.errors.selected_options)==null?void 0:N.message})]})})]}),e.jsxs(v,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(xe,{disabled:c,children:e.jsx(Y,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(Y,{type:"submit",disabled:c,children:[c&&e.jsx(K,{className:"text-white"}),c?"Sending":"Send"]})]})]})}))},ya=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setForwardMessage:n,isOpen:t!==null,onClose:a}},wa=({message:s,isOpen:t,onClose:n})=>de()?e.jsx(ce,{open:t,onOpenChange:n,children:e.jsx(oe,{className:"static",children:s&&e.jsx(ts,{message:s,onClose:n})})}):e.jsx(Ie,{open:t,onClose:n,children:e.jsx(Ae,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(ts,{message:s,onClose:n})})})}),ns=({onClose:s,message:t})=>{var b,D;const n=Re({defaultValues:{}}),{handleSubmit:a,reset:r,watch:o}=n,{call:d}=u.useContext(De),[l,c]=u.useState(!1),[f,C]=u.useState(null),{recentlyUsedDoctypes:N,addRecentlyUsedDocType:k}=Is(),p=E=>{if(t.file){k(E.doctype),c(!0);const M=t.file.split("?")[0];d.get("frappe.client.get_value",{doctype:"File",filters:{file_url:M,attached_to_doctype:"Raven Message",attached_to_name:t.name,attached_to_field:"file"},fieldname:["name"]}).then(z=>{z.message&&d.post("upload_file",{doctype:E.doctype,docname:E.docname,library_file_name:z.message.name})}).then(()=>{ee.success(`File attached to ${E.doctype} - ${E.docname}`),j()}).catch(z=>{C(z),ee.error("Failed to attach file")}).finally(()=>{c(!1)})}},j=()=>{r(),s()},y=o("doctype"),S=()=>{n.setValue("docname","")};return e.jsx(He,I(x({},n),{children:e.jsxs("form",{onSubmit:a(p),children:[e.jsxs(v,{justify:"between",children:[e.jsx(je,{children:"Attach File to Document"}),e.jsx(pe,{hidden:!0,children:"Attach the file to a document"}),e.jsx(xe,{onClick:j,children:e.jsx(L,{size:"1",variant:"soft",color:"gray",children:e.jsx(Ue,{size:"18"})})})]}),e.jsxs(v,{gap:"2",direction:"column",width:"100%",children:[e.jsx(ue,{error:f}),e.jsxs(vs,{children:[e.jsx(Cs,{children:e.jsx(Ot,{ext:Rt(t.file)})}),e.jsx(ks,{children:e.jsx(Ht,{href:t.file,children:Ut(t.file)})})]}),e.jsx(U,{width:"100%",children:e.jsxs(v,{direction:"column",gap:"2",children:[e.jsx(Me,{name:"doctype",label:"Document Type",autofocus:!0,suggestedItems:N,rules:{required:"Document Type is required",onChange:S},filters:[["issingle","=",0],["istable","=",0]],doctype:"DocType"}),e.jsx(_e,{children:(b=n.formState.errors.doctype)==null?void 0:b.message})]})}),y&&e.jsx(U,{width:"100%",children:e.jsxs(v,{direction:"column",gap:"2",children:[e.jsx(Me,{name:"docname",label:"Document Name",placeholder:"Select a document",disabled:!y,rules:{required:"Document Name is required"},doctype:y}),e.jsx(_e,{children:(D=n.formState.errors.docname)==null?void 0:D.message})]})})]}),e.jsxs(v,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(xe,{disabled:l,children:e.jsx(Y,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(Y,{type:"submit",disabled:l,children:[l&&e.jsx(K,{className:"text-white"}),"Attach"]})]})]})}))},_a=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setAttachDocument:n,isOpen:t!==null,onClose:a}},va=({message:s,isOpen:t,onClose:n})=>de()?e.jsx(ce,{open:t,onOpenChange:n,children:e.jsx(oe,{className:"static",children:s&&e.jsx(ns,{message:s,onClose:n})})}):e.jsx(Ie,{open:t,onClose:n,children:e.jsx(Ae,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(ns,{message:s,onClose:n})})})}),as=({reactions:s})=>{const t=u.useMemo(()=>s.flatMap(({reaction:n,users:a,is_custom:r,emoji_name:o})=>a.map(d=>({user:d,reaction:n,is_custom:r,emoji_name:o}))),[s]);return e.jsx(e.Fragment,{children:e.jsx(vn,{defaultValue:"All",children:e.jsxs(v,{direction:"column",gap:"4",children:[e.jsxs(Cn,{children:[e.jsx(rs,{emojiSrc:"All",emojiName:"All"}),s.map(n=>e.jsx(rs,{emojiSrc:n.reaction,isCustom:n.is_custom,emojiName:n.emoji_name,count:n.count},n.reaction))]}),e.jsxs(U,{children:[e.jsx(Xe,{value:"All",children:e.jsx(is,{users:t})}),s.map(n=>e.jsx(Xe,{value:n.reaction,children:e.jsx(is,{users:n.users.map(a=>({user:a,reaction:n.reaction,is_custom:n.is_custom,emoji_name:n.emoji_name}))})},n.reaction))]})]})})})},rs=({emojiSrc:s,count:t,emojiName:n,isCustom:a=!1})=>e.jsx(kn,{value:s,className:"text-gray-11",title:n,children:e.jsxs(v,{gap:"2",align:"center",justify:"center",children:[a?e.jsx("img",{src:s,alt:n,className:"w-[1.2rem] h-[1.2rem] object-contain object-center"}):n==="All"?e.jsx(P,{size:"3",children:"All"}):e.jsx(P,{size:"3",className:"w-[1.2rem] h-[1.2rem]",children:e.jsx("em-emoji",{native:n,set:"apple"})}),t&&e.jsx(P,{children:t})]})}),is=({users:s})=>e.jsx(U,{className:"overflow-hidden overflow-y-scroll h-[50vh] sm:h-64",children:e.jsx(v,{direction:"column",gap:"2",children:e.jsx(v,{direction:"column",children:s.map((t,n)=>e.jsx(Ca,{user:t.user,reaction:t.reaction,is_custom:t.is_custom,emoji_name:t.emoji_name},n))})})}),Ca=({user:s,reaction:t,is_custom:n,emoji_name:a})=>{var d,l;const r=Vt(s),o=(d=r==null?void 0:r.full_name)!=null?d:s;return e.jsx(U,{className:"hover:bg-slate-3 rounded-md",children:e.jsxs(v,{align:"center",justify:"between",children:[e.jsxs(v,{className:"p-2",gap:"3",align:"center",children:[e.jsx(Ee,{src:(l=r==null?void 0:r.user_image)!=null?l:"",alt:o,size:"2"}),e.jsx(P,{size:"2",weight:"medium",children:o})]}),n?e.jsx("img",{src:t,alt:a,title:a,className:"mr-3 w-[1.4rem] h-[1.4rem] object-contain object-center"}):e.jsx(P,{className:"pr-3 h-[1.4rem] w-[1.4rem]",size:"3",weight:"medium",children:e.jsx("em-emoji",{native:a,size:"1.2em",set:"apple"})})]})})},ka=s=>{const[t,n]=u.useState(null),a=t==null?void 0:t.message_reactions,r=u.useMemo(()=>{const d=JSON.parse(a!=null?a:"{}");return Object.entries(d).map(([l,c])=>I(x({},c),{emoji_name:l}))},[a]),o=u.useCallback(()=>{n(null),s==null||s()},[s]);return{reactions:r,message:t,onClose:o,isOpen:t!==null,setReactionMessage:n}},Na=a=>{var r=a,{isOpen:s,onClose:t}=r,n=V(r,["isOpen","onClose"]);return de()?e.jsx(ce,{open:s,onOpenChange:t,children:e.jsx(oe,{className:`${Ce} w-[450px]`,children:e.jsx(as,x({},n))})}):e.jsx(Ie,{open:s,onClose:t,children:e.jsx(Ae,{children:e.jsx("div",{className:"pb-12",children:e.jsx(as,x({},n))})})})},Sa=({message:s})=>e.jsxs(v,{align:"center",gap:"2",id:`message-${s.name}`,className:"pl-1 py-2.5",children:[e.jsx(jn,{timestamp:s.creation}),e.jsx(P,{as:"span",color:"gray",className:"pl-1.5",size:"1",children:s.text})]}),Va=u.forwardRef(({channelID:s,replyToMessage:t,showThreadButton:n=!0,pinnedMessagesString:a,scrollRef:r,onModalClose:o},d)=>{const{messages:l,hasOlderMessages:c,loadOlderMessages:f,goToLatestMessages:C,hasNewMessages:N,error:k,loadNewerMessages:p,isLoading:j,highlightedMessage:y,scrollToMessage:S}=ua(s,r,a),h=la(o),{setDeleteMessage:b}=h,D=V(h,["setDeleteMessage"]),g=oa(o),{setEditMessage:E}=g,M=V(g,["setEditMessage"]),w=ya(o),{setForwardMessage:z}=w,Q=V(w,["setForwardMessage"]),B=_a(o),{setAttachDocument:se}=B,G=V(B,["setAttachDocument"]),H=ka(o),{setReactionMessage:te}=H,ne=V(H,["setReactionMessage"]),T=_=>{S(_)},{name:A}=Kt();u.useImperativeHandle(d,()=>({onUpArrow:()=>{if(l&&l.length>0){const _=l[l.length-1];_.message_type==="Text"&&_.owner===A&&!_.is_bot_message&&E(_)}}}));const{ref:m}=ss({fallbackInView:!0,initialInView:!1,skip:!c,onChange:_=>q(null,null,function*(){_&&c&&(yield f())})}),{ref:i}=ss({fallbackInView:!0,skip:!N,initialInView:!1,onChange:_=>{_&&N&&p()}});return u.useEffect(()=>{if(!r.current)return;const _=new ResizeObserver(()=>{const O=r.current;O&&O.scrollTop+O.clientHeight>=O.scrollHeight-100&&requestAnimationFrame(()=>{O.scrollTo({top:O.scrollHeight,behavior:"instant"})})});return _.observe(r.current),()=>{_.disconnect()}},[]),e.jsxs("div",{className:"relative h-full flex flex-col overflow-y-auto pb-16 sm:pb-0",ref:r,children:[e.jsx("div",{ref:m,children:c&&!j&&e.jsx("div",{className:"flex w-full min-h-8 pb-4 justify-center items-center",children:e.jsx(K,{})})}),!j&&!c&&e.jsx(wn,{channelID:s!=null?s:""}),j&&e.jsx(ma,{}),k&&e.jsx(ue,{error:k}),e.jsx("div",{className:J("flex flex-col pb-4 z-50 transition-opacity duration-400 ease-ease-out-cubic",j?"opacity-0":"opacity-100"),children:l==null?void 0:l.map(_=>_.message_type==="date"?e.jsx(_n,{id:`date-${_.creation}`,className:"p-2 z-10 relative",children:_.creation},`date-${_.creation}`):_.message_type==="System"?e.jsx(Sa,{message:_},`${_.name}_${_.modified}`):e.jsx("div",{id:`message-${_.name}`,children:e.jsx("div",{className:"w-full overflow-x-clip overflow-y-visible text-ellipsis",children:e.jsx(pn,{message:_,isHighlighted:y===_.name,onReplyMessageClick:T,setEditMessage:E,replyToMessage:t,forwardMessage:z,showThreadButton:n,onAttachDocument:se,setDeleteMessage:b,setReactionMessage:te})})},`${_.name}_${_.modified}`))}),N&&e.jsx("div",{ref:i,children:e.jsx("div",{className:"flex w-full min-h-8 pb-4 justify-center items-center",children:e.jsx(K,{})})}),N&&e.jsx("div",{className:"fixed bottom-36 z-50 right-5",children:e.jsxs(Y,{className:"shadow-lg",onClick:C,children:["Scroll to new messages",e.jsx(qt,{size:18})]})}),e.jsx(ca,x({},D)),e.jsx(da,x({},M)),e.jsx(wa,x({},Q)),e.jsx(va,x({},G)),e.jsx(Na,x({},ne))]})}),Ka=({channelData:s,user:t})=>{const{mutate:n}=Jt(),{threadID:a}=ws(),{createDoc:r,error:o,loading:d}=ms(),l=()=>q(null,null,function*(){return r("Raven Channel Member",{channel_id:s?s==null?void 0:s.name:a,user_id:t}).then(()=>{n(["channel_members",s?s.name:a])})});return e.jsx(U,{children:e.jsxs(v,{direction:"column",align:"center",gap:s?"3":"2",className:"border border-gray-6 rounded-md bg-surface animate-fadein sm:mb-0 mb-2",p:s?"4":"3",children:[e.jsx(ue,{error:o}),e.jsxs(P,{as:"span",size:"2",children:["You are not a member of this ",s?"channel":"thread","."]}),e.jsxs(Y,{onClick:l,size:s?"2":"1",disabled:d,children:[d&&e.jsx(K,{className:"text-white"}),d?"Joining":e.jsxs("span",{className:"inline-flex gap-1 not-cal font-medium",children:["Join ",s?`${s==null?void 0:s.channel_name}`:"Conversation"]})]})]})})},Ta=s=>{const{socket:t}=u.useContext(De),[n,a]=u.useState([]);return u.useEffect(()=>{t&&(t.emit("raven_channel_get_typers",s),t.io.on("reconnect",()=>{t.emit("raven_channel_get_typers",s)}))},[s]),ge("raven_channel_typers",r=>{r.channel===s&&a(r.users)}),n},qa=s=>{const[t,n]=u.useState(0),a=u.useRef(!1),{socket:r}=u.useContext(De),o=u.useCallback(()=>{r==null||r.emit("raven_channel_typing",s)},[s]),d=u.useCallback(()=>{r==null||r.emit("raven_channel_typing_stopped",s)},[s]),l=u.useCallback(()=>{a.current||(a.current=!0,n(f=>f+1),o())},[o]);return u.useEffect(()=>{let f;return t>0&&(f=setTimeout(()=>{a.current=!1,n(0),d()},1e4)),()=>{clearTimeout(f)}},[t,d]),u.useEffect(()=>()=>{d()},[d]),{stopTyping:u.useCallback(()=>{d(),a.current=!1,n(0)},[d]),onUserType:l}},Ja=({channel:s})=>{const t=Ta(s),n=Nn(),{currentUser:a}=u.useContext(Ss),r=u.useMemo(()=>{const o=t.filter(d=>d!==a).map(d=>{var l,c,f,C;return(C=(f=(l=n[d])==null?void 0:l.first_name)!=null?f:(c=n[d])==null?void 0:c.full_name)!=null?C:d});return o.length===0?"":o.length===1?o[0]+" is typing...":o.length===2?o[0]+" and "+o[1]+" are typing...":o.length===3?o[0]+", "+o[1]+" and 1 other are typing...":o[0]+", "+o[1]+" and "+(o.length-2)+" others are typing..."},[t,n,a]);return r===""?null:e.jsxs(fe,{className:"gap-1.5 pl-0.5 pt-1 relative sm:bottom-0 bottom-16 sm:pb-0 pb-2",align:"center",children:[e.jsxs("div",{className:"flex items-center space-x-1 -mb-0.5",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"300ms"}})]}),e.jsx(P,{size:"1",as:"span",children:r})]})};export{Va as C,Ua as F,Pn as H,Ka as J,Ja as T,Ra as a,Ha as b,ra as c,Ve as e,qa as u};
