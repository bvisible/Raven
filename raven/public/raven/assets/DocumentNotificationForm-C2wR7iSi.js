var ne=Object.defineProperty,ae=Object.defineProperties;var ie=Object.getOwnPropertyDescriptors;var J=Object.getOwnPropertySymbols;var le=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable;var M=(r,a,n)=>a in r?ne(r,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[a]=n,y=(r,a)=>{for(var n in a||(a={}))le.call(a,n)&&M(r,n,a[n]);if(J)for(var n of J(a))ce.call(a,n)&&M(r,n,a[n]);return r},D=(r,a)=>ae(r,ie(a));import{j as e,c9 as oe,bA as te,ca as de,p as m,aJ as q,cb as w,S as j,b8 as he,L as g,b as I,c as b,aP as f,aD as k,aE as $,aF as R,aG as p,aL as H,aH as C,i as _,ax as v,aS as B,O as ue,bu as X,bV as V,e as je,aK as pe,o as xe,a7 as P,a as F,cc as E,r as L,M as T,aM as N,n as me,bW as be,aA as ge,m as ye,be as ve,bc as W,c6 as G,c7 as K}from"./index-R8dcyEON.js";import{u as Z}from"./useDoctypeMeta-BavVHbAP.js";import{V as fe}from"./InstructionField-CAvMjd5C.js";import{b as ee}from"./validations-DJFqvO1k.js";import{V as se}from"./DoctypeVariableDialogForm-CmHBUNAA.js";import{m as _e,b as Ce,P as S,f as U}from"./tabs-DQGMkBAG.js";import{m as we,d as Fe,P as De,f as Q,b as Te}from"./table-HDqE5ITd.js";const z={size:18,className:"mr-1.5"},Ae=({isEdit:r=!1})=>e.jsxs(_e,{defaultValue:"general",children:[e.jsxs(Ce,{children:[e.jsxs(S,{value:"general",children:[e.jsx(oe,y({},z))," Details"]}),e.jsxs(S,{value:"recipients",children:[e.jsx(te,y({},z))," Recipients"]}),e.jsxs(S,{value:"condition",children:[e.jsx(de,y({},z))," Conditions"]})]}),e.jsxs(m,{pt:"4",children:[e.jsx(U,{value:"general",children:e.jsx(Ne,{isEdit:r})}),e.jsx(U,{value:"recipients",children:e.jsx(ke,{})}),e.jsx(U,{value:"condition",children:e.jsx(Ve,{})})]})]}),Ne=({isEdit:r})=>{var u,s,o,t,i;const{register:a,control:n,formState:{errors:l}}=q(),d=w({name:"document_type",control:n});return e.jsxs(j,{gap:"4",children:[e.jsxs(he,{columns:"2",gap:"4",align:"center",children:[e.jsxs(j,{children:[e.jsxs(m,{children:[e.jsx(g,{htmlFor:"notification_name",isRequired:!0,children:"Name"}),e.jsx(I,D(y({id:"notification_name"},a("notification_name",{required:"Name is required",disabled:r})),{disabled:r,placeholder:"Salary Slip Notification","aria-invalid":l.notification_name?"true":"false"}))]}),l.notification_name&&e.jsx(b,{children:(u=l.notification_name)==null?void 0:u.message})]}),e.jsxs(j,{children:[e.jsxs(m,{children:[e.jsx(g,{htmlFor:"send_alert_on",isRequired:!0,children:"Send Alert On"}),e.jsx(f,{control:n,name:"send_alert_on",rules:{required:"Trigger is required"},render:({field:c})=>e.jsxs(k,{value:c.value,name:c.name,onValueChange:h=>c.onChange(h),children:[e.jsx($,{placeholder:"Pick a trigger",className:"w-full",autoFocus:!0}),e.jsxs(R,{children:[e.jsx(p,{value:"New Document",children:"New Document"}),e.jsx(p,{value:"Update",children:"Update"}),e.jsx(p,{value:"Submit",children:"Submit"}),e.jsx(p,{value:"Cancel",children:"Cancel"}),e.jsx(p,{value:"Delete",children:"Delete"})]})]})})]}),l.send_alert_on&&e.jsx(b,{children:(s=l.send_alert_on)==null?void 0:s.message})]}),e.jsxs(j,{children:[e.jsx(H,{name:"document_type",label:"Document Type",required:!0,placeholder:"e.g. Salary Slip",filters:[["istable","=",0],["issingle","=",0]],doctype:"DocType",rules:{required:"Document Type is required"}}),e.jsx(C,{children:"The document type to send the notification for."}),l.document_type&&e.jsx(b,{children:(o=l.document_type)==null?void 0:o.message})]}),e.jsxs(j,{children:[e.jsx(H,{name:"sender",label:"Sender",required:!0,placeholder:"Select a bot",doctype:"Raven Bot",rules:{required:"Sender is required"}}),e.jsx(C,{children:"Notifications are sent via bots. Select the bot to send the notification."}),l.sender&&e.jsx(b,{children:(t=l.sender)==null?void 0:t.message})]})]}),e.jsxs(j,{width:"fit-content",gap:"4",children:[e.jsx(_,{as:"label",size:"2",children:e.jsxs(v,{children:[e.jsx(f,{control:n,name:"enabled",render:({field:c})=>e.jsx(B,{checked:!!c.value,onCheckedChange:h=>c.onChange(h?1:0)})}),"Enabled"]})}),e.jsx(_,{as:"label",size:"2",children:e.jsxs(v,{children:[e.jsx(f,{control:n,name:"do_not_attach_doc",render:({field:c})=>e.jsx(B,{checked:!!c.value,onCheckedChange:h=>c.onChange(h?1:0)})}),e.jsxs(j,{gap:"1",children:["Hide document preview in the notification message",e.jsx(C,{children:"If checked, the document preview will not be attached to the notification message."})]})]})})]}),e.jsx(ue,{size:"4"}),e.jsxs(j,{children:[e.jsxs(m,{children:[e.jsx(g,{htmlFor:"message",children:"Message Content"}),e.jsx(X,D(y({},a("message")),{id:"message",placeholder:"Hi {{ doc.employee_name }}, your salary slip is ready.",rows:10,resize:"vertical","aria-invalid":l.message?"true":"false"}))]}),l.message&&e.jsx(b,{children:(i=l.message)==null?void 0:i.message}),e.jsxs(C,{size:"2",children:["The contents of the message to be sent. You can use Jinja tags to embed data from the document.",e.jsx("br",{}),"You can use data from the document like this: ",e.jsx(V,{children:"{{ doc.employee_name }}"}),". You can also use functions like ",e.jsx(V,{children:"{{ frappe.utils.today() }}"}),".",e.jsx("br",{}),"For a complete list of functions, see ",e.jsx(je,{href:"https://docs.frappe.io/framework/user/en/api/jinja",children:"Frappe's Jinja documentation"}),"."]})]}),d&&e.jsx(re,{doctype:d})]})},re=({doctype:r,withoutJinja:a})=>{const{doc:n}=Z(r),[l,d]=L.useState(""),u=L.useMemo(()=>{var t;if(!n)return[];const s=[...se,"Read Only"],o=l.toLowerCase();return(t=n.fields)==null?void 0:t.filter(i=>{var c;return ee(s,i.fieldtype)&&i.fieldname&&((c=i.label)==null?void 0:c.toLowerCase().includes(o))}).map(i=>({variable:`doc.${i.fieldname}`,description:e.jsxs("span",{children:[i.label," ",e.jsx(ge,{color:"gray",variant:"soft",children:i.fieldtype})]})}))},[n,l]);return e.jsxs(j,{children:[e.jsx(_,{size:"2",children:"Here are some variables you can use. Simply copy by clicking on the variable."}),e.jsxs(m,{children:[e.jsx(N,{children:e.jsx(g,{htmlFor:"search",children:"Search"})}),e.jsx(I,{placeholder:"Search",id:"search",value:l,onChange:s=>d(s.target.value),children:e.jsx(ye,{children:e.jsx(ve,{})})})]}),e.jsxs(we,{variant:"surface",children:[e.jsx(Fe,{children:e.jsxs(De,{children:[e.jsx(Q,{children:"Variable"}),e.jsx(Q,{children:"Description"})]})}),e.jsx(Te,{children:u==null?void 0:u.map(s=>e.jsx(fe,{variable:s.variable,description:s.description,withoutJinja:a},s.variable))})]})]})},ke=()=>{const{control:r}=q(),{fields:a,append:n,remove:l}=pe({control:r,name:"recipients"}),d=()=>{n({channel_type:"Channel",variable_type:"Static",value:""})};return e.jsxs(j,{gap:"4",children:[e.jsxs(v,{justify:"between",align:"center",children:[e.jsx(_,{size:"2",children:"Recipients are the users who will receive the notification. You can choose to send the notification to channels or specific users."}),e.jsx(xe,{onClick:d,variant:"soft",size:"2",type:"button",className:"not-cal",children:"Add Recipient"})]}),e.jsxs("div",{className:"grid grid-cols-11 gap-y-2 border border-gray-4 rounded-md",children:[e.jsx("div",{className:"col-span-3 bg-gray-2 p-3 font-bold text-sm border-b border-gray-4",children:e.jsxs(v,{align:"center",children:["Channel Type",e.jsx(P,{content:"The channel to send the notification to.",children:e.jsx(F,{align:"center",justify:"center",children:e.jsx(E,{})})})]})}),e.jsx("div",{className:"col-span-3 bg-gray-2 p-3 font-bold text-sm border-b border-gray-4",children:e.jsxs(v,{align:"center",children:["Variable Type",e.jsx(P,{content:"The type of variable to use.<br /><br />Static: fixed channel/user<br /><br />Document Field: use a field from the document which will point to a channel/user<br /><br />Jinja: use a Jinja expression that resolves to a channel/user",children:e.jsx(F,{align:"center",justify:"center",children:e.jsx(E,{})})})]})}),e.jsx("div",{className:"col-span-4 bg-gray-2 p-3 font-bold text-sm border-b border-gray-4",children:e.jsxs(v,{align:"center",children:["Value",e.jsx(P,{content:"The value to use for the recipient. This can be a channel or user ID.",children:e.jsx(F,{align:"center",justify:"center",children:e.jsx(E,{})})})]})}),e.jsx("div",{className:"col-span-1 bg-gray-2 p-3 font-bold text-sm border-b border-gray-4"}),a.map((u,s)=>e.jsxs(L.Fragment,{children:[e.jsx("div",{className:T("col-span-3 p-2",s!==a.length-1?"border-b border-gray-4":""),children:e.jsxs(m,{children:[e.jsx(N,{children:e.jsxs(g,{htmlFor:`recipients.${s}.channel_type`,children:["Channel Type for Row ",s+1]})}),e.jsx(f,{control:r,name:`recipients.${s}.channel_type`,rules:{required:"Channel Type is required"},render:({field:o,fieldState:t})=>e.jsxs(j,{gap:"1",children:[e.jsxs(k,{value:o.value,onValueChange:i=>o.onChange(i),children:[e.jsx($,{placeholder:"Pick a channel type",className:"w-64","aria-invalid":t.error?"true":"false"}),e.jsxs(R,{children:[e.jsx(p,{value:"Channel",children:"Channel"}),e.jsx(p,{value:"User",children:"Direct Message"})]})]}),t.error&&e.jsx(b,{children:t.error.message})]})})]})}),e.jsx("div",{className:T("col-span-3 p-2",s!==a.length-1?"border-b border-gray-4":""),children:e.jsxs(m,{children:[e.jsx(N,{children:e.jsxs(g,{htmlFor:`recipients.${s}.variable_type`,children:["Variable Type for Row ",s+1]})}),e.jsx(f,{control:r,name:`recipients.${s}.variable_type`,render:({field:o,fieldState:t})=>e.jsxs(j,{gap:"1",children:[e.jsxs(k,{value:o.value,onValueChange:i=>o.onChange(i),children:[e.jsx($,{placeholder:"Pick a variable type",className:"w-64","aria-invalid":t.error?"true":"false"}),e.jsxs(R,{children:[e.jsx(p,{value:"Static",children:"Static"}),e.jsx(p,{value:"DocField",children:"Document Field"}),e.jsx(p,{value:"Jinja",children:"Jinja"})]})]}),t.error&&e.jsx(b,{children:t.error.message})]})})]})}),e.jsx("div",{className:T("col-span-4 p-2",s!==a.length-1?"border-b border-gray-4":""),children:e.jsxs(m,{children:[e.jsx(N,{children:e.jsxs(g,{htmlFor:`recipients.${s}.value`,children:["Value for Row ",s+1]})}),e.jsx(j,{gap:"1",children:e.jsx(f,{control:r,name:`recipients.${s}.value`,rules:{required:"Value is required"},render:({field:o,fieldState:t})=>e.jsx($e,{index:s,value:o.value,onChange:i=>o.onChange(i),fieldState:t,onBlur:o.onBlur})})})]})}),e.jsx("div",{className:T("col-span-1 p-2 flex justify-center",s!==a.length-1?"border-b border-gray-4":""),children:e.jsx(me,{variant:"surface",color:"red",onClick:()=>l(s),children:e.jsx(be,{})})})]},s))]}),e.jsxs(_,{size:"2",children:["You can use Jinja to get the recipient.",e.jsx("br",{}),"For example, you might have the employee ID in the document and you want to send the notification to the user linked to that employee ID. You can use the following variable to get the recipient: ",e.jsx(V,{color:"gray",size:"2",children:"{{ frappe.db.get_value('Employee', doc.employee_id, 'user') }}"})]})]})},$e=({index:r,value:a,onChange:n,onBlur:l,fieldState:d})=>{const{control:u}=q(),s=w({control:u,name:`recipients.${r}.variable_type`}),o=w({control:u,name:`recipients.${r}.channel_type`}),t=w({control:u,name:"document_type"});return s==="Static"?o==="Channel"?e.jsx(W,{label:"Channel",hideLabel:!0,filters:[["is_direct_message","=",0],["is_archived","=",0],["is_thread","=",0]],required:!0,placeholder:"Select a channel",doctype:"Raven Channel",value:a,"aria-invalid":d!=null&&d.error?"true":"false",setValue:n}):e.jsx(W,{label:"User",hideLabel:!0,filters:[["enabled","=",1],["type","=","User"]],required:!0,placeholder:"Select a user",doctype:"Raven User",value:a,"aria-invalid":d!=null&&d.error?"true":"false",setValue:n}):s==="DocField"&&t?e.jsx(Re,{index:r,type:o,value:a,onChange:n,onBlur:l,document_type:t}):e.jsx(I,{value:a,onChange:i=>n(i.target.value),onBlur:l,placeholder:'e.g. {{ frappe.db.get_value("Employee", doc.employee_id, "user_id") }}',"aria-invalid":d!=null&&d.error?"true":"false"})},Re=({type:r,document_type:a,value:n,onChange:l,onBlur:d,fieldState:u})=>{const{doc:s}=Z(a),{suggestedFields:o,fields:t}=L.useMemo(()=>{var Y;const i=[...se,"Read Only"],c=[],h=[];if(!s)return{fields:h,suggestedFields:[]};(Y=s.fields)==null||Y.forEach(x=>{ee(i,x.fieldtype)&&(x.fieldtype==="Link"?x.options&&(r==="Channel"&&(x.options.includes("Raven Channel")?c.push(x):h.push(x)),r==="User"&&(x.options.includes("Raven User")||x.options.includes("User")?c.push(x):h.push(x))):h.push(x))});const A={fieldname:"owner",label:"Owner",fieldtype:"Link",options:"User"};r==="User"?c.push(A):h.push(A);const O={fieldname:"modified_by",label:"Modified By",fieldtype:"Link",options:"User"};return r==="User"?c.push(O):h.push(O),{fields:h,suggestedFields:c}},[s,r]);return e.jsxs(k,{onValueChange:l,value:n,children:[e.jsx($,{placeholder:"Pick a field",className:"w-full",onBlur:d,"aria-invalid":u!=null&&u.error?"true":"false"}),e.jsxs(R,{children:[o.length>0&&e.jsxs(G,{children:[e.jsx(K,{children:"Suggested"}),o.map(i=>{var c;return e.jsxs(p,{value:(c=i.fieldname)!=null?c:"",children:[i.label," (",i.fieldname,")"]},i.fieldname)})]}),e.jsxs(G,{children:[e.jsx(K,{children:"All"}),t.map(i=>{var c,h;return e.jsxs(p,{value:(c=i.fieldname)!=null?c:"",children:[(h=i.label)!=null?h:""," (",i.fieldname,")"]},i.fieldname)})]})]})]})},Ve=()=>{const{register:r,control:a,formState:{errors:n}}=q(),l=w({name:"document_type",control:a});return e.jsxs(j,{children:[e.jsx(m,{children:e.jsxs(F,{direction:"row",gap:"4",align:"start",children:[e.jsxs(F,{direction:"column",style:{width:"60%"},children:[e.jsx(g,{htmlFor:"condition",children:"Condition"}),e.jsx(X,D(y({id:"condition"},r("condition")),{placeholder:"e.g. doc.docstatus == 1",rows:10})),(n==null?void 0:n.condition)&&e.jsx(b,{className:"pt-1",children:n.condition.message}),e.jsx(C,{style:{paddingTop:"0.25rem"},children:"Optional: The notification will be sent if this expression is true."})]}),e.jsxs(V,{color:"gray",size:"2",className:"mt-7 p-4",children:[e.jsx(_,{weight:"bold",size:"2",className:"block",children:"Some examples:"}),e.jsx("br",{}),'doc.status == "Open"',e.jsx("br",{}),e.jsx("br",{}),'doc.status == "Received" or doc.status == "Partially Received" ',e.jsx("br",{}),e.jsx("br",{}),"doc.total > 10000"]})]})}),l&&e.jsx(re,{doctype:l,withoutJinja:!0})]})};export{Ae as D};
