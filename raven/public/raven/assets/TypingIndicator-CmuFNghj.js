const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/EmojiPicker-J_iKZ5Mw.js","assets/index-R8dcyEON.js","assets/index-C_bAo5WJ.css","assets/AddCustomEmojiDialog-CZI-RBSt.js","assets/CreatePoll-A-Bb7bim.js","assets/CreatePoll-CE21K4bl.css","assets/GIFPicker-D7CZtAfl.js","assets/useDebounce-DCdcqx-R.js","assets/Skeleton-DFPQynXy.js","assets/MobileInputActions-CSqL-36P.js","assets/index-BQr9T4g4.js","assets/useCurrentChannelData-B_RQzLTH.js","assets/useGetUserRecords-DZmPiqFl.js","assets/useRavenSettings-BruiZaC6.js","assets/hover-card-B0cTsQeu.js","assets/preferences-D9zjGYzN.js","assets/DoctypeLinkRenderer-H9xZNCg1.js","assets/useDoctypeMeta-BavVHbAP.js","assets/skeleton-CumY7mT4.js","assets/useCurrentChannelData-BsL46_d-.css","assets/EmptyState-DGSqNDea.js","assets/DateSeparator-CKn_TvrF.js","assets/tabs-DQGMkBAG.js","assets/tiptap-CwkfU7Sh.css"])))=>i.map(i=>d[i]);
var Ps=Object.defineProperty,Fs=Object.defineProperties;var Os=Object.getOwnPropertyDescriptors;var Te=Object.getOwnPropertySymbols;var Je=Object.prototype.hasOwnProperty,Ge=Object.prototype.propertyIsEnumerable;var Ye=(s,t,n)=>t in s?Ps(s,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[t]=n,x=(s,t)=>{for(var n in t||(t={}))Je.call(t,n)&&Ye(s,n,t[n]);if(Te)for(var n of Te(t))Ge.call(t,n)&&Ye(s,n,t[n]);return s},A=(s,t)=>Fs(s,Os(t));var K=(s,t)=>{var n={};for(var a in s)Je.call(s,a)&&t.indexOf(a)<0&&(n[a]=s[a]);if(s!=null&&Te)for(var a of Te(s))t.indexOf(a)<0&&Ge.call(s,a)&&(n[a]=s[a]);return n};var G=(s,t,n)=>new Promise((a,r)=>{var i=l=>{try{c(n.next(l))}catch(h){r(h)}},u=l=>{try{c(n.throw(l))}catch(h){r(h)}},c=l=>l.done?a(l.value):Promise.resolve(l.value).then(i,u);c((n=n.apply(s,t)).next())});import{b5 as $s,r as d,b6 as Hs,b7 as Us,ck as Vs,b9 as Ks,h as Ae,aC as os,ep as qs,a3 as q,ac as Ys,eq as Js,j as e,a as C,p as U,a7 as W,n as z,er as Gs,ci as $,es as Ws,et as Zs,O as oe,dd as Xs,eu as Qs,ev as et,ew as st,ex as tt,ey as nt,ez as at,e6 as rt,aI as ke,cS as Oe,e2 as it,M as Z,a4 as Me,ax as je,i as R,eA as lt,bo as ze,G as $e,a6 as de,cg as ct,aa as ue,ab as Ne,au as ye,av as we,P as me,v as ds,bm as He,eB as fe,S as us,o as X,bl as ms,a8 as hs,eC as ot,bJ as gs,u as Ue,ai as Ve,E as he,aL as De,c as Ce,L as fs,bu as dt,ay as be,d as Y,_ as te,eD as ut,eE as mt,eF as ht,ak as gt,al as ft,dT as xt,an as jt,ao as pt,em as bt,eG as yt,eH as wt,eb as _t,aq as xs,ar as js,as as vt,at as ps,dK as Ct,eI as bs,eJ as ys,aw as ws,d6 as _s,bx as vs,dR as Cs,du as kt,ce as Nt,V as pe,eK as St,eL as Tt,br as Et,a0 as Mt,bY as ks,bZ as Ns,aR as Dt,b_ as Ss,a1 as At,a2 as It,ad as Lt,ag as Bt,ah as zt,aM as Ts,dV as Ke,d_ as Ie,e0 as Le,eM as Rt,U as Es,eN as Pt,e1 as Ft,dh as xe,bF as We,eO as _e,eP as ie,b as Ot,z as $t,aP as Ht,dY as Ut,dX as Vt,e as Kt,dS as qt,dn as Yt,Q as Jt,aB as Gt,eQ as Wt,bd as Zt}from"./index-R8dcyEON.js";import{O as Q,V as Ms,P as Ds,f as Be,W as Xt,r as Qt,D as en,o as sn,X as Re,Y as Pe,S as tn,C as nn,c as an,u as rn,U as Ze,Z as ln,E as Xe,g as cn,x as on,a as dn,j as un,t as mn,b as hn,p as gn}from"./index-BQr9T4g4.js";import{S as fn,b as xn,H as jn,L as pn,I as bn,c as As,d as yn,e as wn,f as _n}from"./useCurrentChannelData-B_RQzLTH.js";/* empty css                      */import{D as vn}from"./DoctypeLinkRenderer-H9xZNCg1.js";import{E as Cn,T as kn}from"./preferences-D9zjGYzN.js";import{C as Nn}from"./EmptyState-DGSqNDea.js";import{r as se}from"./skeleton-CumY7mT4.js";import{D as Sn}from"./DateSeparator-CKn_TvrF.js";import{m as Tn,b as En,f as Qe,P as Mn}from"./tabs-DQGMkBAG.js";import{u as Dn}from"./useGetUserRecords-DZmPiqFl.js";const An=["all","x","y","top","bottom","left","right"],In=["border-box","padding-box"],le=["current","0"],Ln=A(x({},$s),{side:{type:"enum",className:"rt-r-side",values:An,default:"all",responsive:!0},clip:{type:"enum",className:"rt-r-clip",values:In,default:"border-box",responsive:!0},p:{type:"enum",className:"rt-r-p",values:le,parseValue:ce,responsive:!0},px:{type:"enum",className:"rt-r-px",values:le,parseValue:ce,responsive:!0},py:{type:"enum",className:"rt-r-py",values:le,parseValue:ce,responsive:!0},pt:{type:"enum",className:"rt-r-pt",values:le,parseValue:ce,responsive:!0},pr:{type:"enum",className:"rt-r-pr",values:le,parseValue:ce,responsive:!0},pb:{type:"enum",className:"rt-r-pb",values:le,parseValue:ce,responsive:!0},pl:{type:"enum",className:"rt-r-pl",values:le,parseValue:ce,responsive:!0}});function ce(s){return s==="current"?"inset":s}const qe=d.forwardRef((s,t)=>{const u=Hs(s,Ln,Us),{asChild:n,className:a}=u,r=K(u,["asChild","className"]),i=n?Vs:"div";return d.createElement(i,A(x({},r),{ref:t,className:Ks("rt-Inset",a)}))});qe.displayName="Inset";const Is=qs(s=>Js([]));function Ga(s){const{file:t}=d.useContext(Ae),n=d.useRef(null),[a,r]=os(Is(s)),[i,u]=d.useState(!0),c=d.useRef([]);c.current=a;const[l,h]=d.useState({});return{fileInputRef:n,files:a,setFiles:r,removeFile:b=>{let w=a.filter(y=>y.fileID!==b);r(w),h(y=>{const k=x({},y);return delete k[b],k})},addFile:b=>{const w=b;w&&(w.fileID=b.name+Date.now(),w.uploadProgress=0,r(y=>[...y,w]))},compressImages:i,setCompressImages:u,uploadFiles:(b,w)=>G(null,null,function*(){const y=[...c.current];if(y.length>0){const k=y.map((p,M)=>G(null,null,function*(){return t.uploadFile(p,{isPrivate:!0,doctype:"Raven Message",otherData:{channelID:s,compressImages:i,is_reply:M===0&&b?1:0,linked_message:M===0&&b?b.name:null,caption:M===0&&w?w:""},fieldname:"file"},(T,E)=>{const I=Math.round(T/(E!=null?E:p.size)*100);h(V=>A(x({},V),{[p.fileID]:{progress:I,isComplete:!1}}))},"raven.api.upload_file.upload_file_with_message").then(T=>(r(E=>E.filter(I=>I.fileID!==p.fileID)),h(E=>A(x({},E),{[p.fileID]:{progress:100,isComplete:!0}})),T.data.message)).catch(T=>(h(E=>{const I=x({},E);return delete I[p.fileID],I}),q.error("There was an error uploading the file "+p.name,{description:Ys(T)}),null))}));return Promise.all(k).then(p=>(r([]),p.filter(M=>M!==null))).catch(p=>(console.error(p),[]))}else return Promise.resolve([])}),fileUploadProgress:l}}const F={size:"18"},O="bg-transparent dark:text-gray-11 sm:dark:text-gray-10 text-gray-11 hover:bg-accent-a3 hover:text-accent-a11 dark:hover:text-accent-a11",Bn=s=>e.jsx(C,x({justify:"between",align:"center",className:"border-t border-t-slate-5 bg-slate-2 rounded-b-radius4 overflow-hidden",p:"1"},s)),es=d.memo(()=>{const{editor:s}=Q(),t="bg-accent-a3";return s?e.jsxs(C,{gap:"2",align:"center",px:"1",py:"1",className:"sm:max-w-[60%] max-w-[100%] overflow-x-auto",children:[e.jsxs(C,{gap:"3",align:"center",children:[e.jsx(W,{content:$()+" + B","aria-label":$()+" + B",children:e.jsx(z,{onClick:()=>s.chain().focus().toggleBold().run(),"aria-label":"bold",variant:"ghost",title:"Bold",size:"1",className:s.isActive("bold")?t:O,disabled:!s.can().chain().focus().toggleBold().run(),children:e.jsx(Gs,x({},F))})}),e.jsx(W,{content:$()+" + I","aria-label":$()+" + I",children:e.jsx(z,{onClick:()=>s.chain().focus().toggleItalic().run(),"aria-label":"italic",title:"Italic",variant:"ghost",size:"1",className:s.isActive("italic")?t:O,disabled:!s.can().chain().focus().toggleItalic().run(),children:e.jsx(Ws,x({},F))})}),e.jsx(W,{content:$()+" + U","aria-label":$()+" + U",children:e.jsx(z,{onClick:()=>s.chain().focus().toggleUnderline().run(),"aria-label":"underline",title:"Underline",variant:"ghost",size:"1",className:s.isActive("underline")?t:O,disabled:!s.can().chain().focus().toggleUnderline().run(),children:e.jsx(Zs,x({},F))})})]}),e.jsx(oe,{orientation:"vertical"}),e.jsxs(C,{gap:"3",align:"center",children:[e.jsx(W,{content:$()+" + E","aria-label":$()+" + E",children:e.jsx(z,{onClick:()=>s.chain().focus().toggleCode().run(),"aria-label":"code",variant:"ghost",size:"1",title:"Code",className:s.isActive("code")?t:O,disabled:!s.can().chain().focus().toggleCode().run(),children:e.jsx(Xs,x({},F))})}),e.jsx(W,{content:$()+"+ Shift + E","aria-label":$()+"+ Shift + E",children:e.jsx(z,{onClick:()=>s.chain().focus().toggleCodeBlock().run(),"aria-label":"code block",variant:"ghost",size:"1",title:"Code Block",className:s.isActive("codeBlock")?t:O,disabled:!s.can().chain().focus().toggleCodeBlock().run(),children:e.jsx(Qs,x({},F))})}),e.jsx(z,{onClick:()=>s.chain().focus().toggleStrike().run(),"aria-label":"strike",variant:"ghost",size:"1",title:"Strike",className:s.isActive("strike")?t:O,disabled:!s.can().chain().focus().toggleStrike().run(),children:e.jsx(et,x({},F))}),e.jsx(z,{onClick:()=>s.chain().focus().toggleBlockquote().run(),"aria-label":"blockquote",className:s.isActive("blockquote")?t:O,title:"Blockquote",size:"1",variant:"ghost",disabled:!s.can().chain().focus().toggleBlockquote().run(),children:e.jsx(st,x({},F))})]}),e.jsx(oe,{orientation:"vertical"}),e.jsxs(C,{gap:"3",align:"center",children:[e.jsx(W,{content:$()+" + Shift + 7","aria-label":$()+" + Shift + 7",children:e.jsx(z,{onClick:()=>s.chain().focus().toggleOrderedList().run(),"aria-label":"ordered list",title:"Ordered List",size:"1",variant:"ghost",className:s.isActive("orderedList")?t:O,disabled:!s.can().chain().focus().toggleOrderedList().run(),children:e.jsx(tt,x({},F))})}),e.jsx(W,{content:$()+" + Shift + 8","aria-label":$()+" + Shift + 8",children:e.jsx(z,{onClick:()=>s.chain().focus().liftEmptyBlock().toggleBulletList().run(),"aria-label":"bullet list",title:"Bullet List",size:"1",variant:"ghost",className:s.isActive("bulletList")?t:O,disabled:!s.can().chain().focus().toggleBulletList().run(),children:e.jsx(nt,x({},F))})})]}),e.jsx(oe,{orientation:"vertical"}),e.jsx(C,{gap:"3",align:"center",children:e.jsx(W,{content:$()+" + Shift + H","aria-label":$()+" + Shift + H",children:e.jsx(z,{"aria-label":"highlight",onClick:()=>s.chain().focus().toggleHighlight().run(),title:"Highlight",variant:"ghost",size:"1",className:s.isActive("highlight")?t:O,disabled:!s.can().chain().focus().toggleHighlight().run(),children:e.jsx(at,x({},F))})})}),e.jsx(zn,{})]}):e.jsx(U,{})}),zn=()=>{const{editor:s}=Q(),t=a=>G(null,null,function*(){let r=a;const u=(yield ke(()=>import("./index-CFH22xHK.js"),[])).parse(r,void 0,{forwardDate:!0});return u.sort((c,l)=>l.index-c.index),u.forEach(c=>{var y,k,p,M;if(!c.start.isCertain("hour")&&!c.start.isCertain("minute")&&!c.start.isCertain("day"))return;const l=c.start.isCertain("hour")&&c.start.isCertain("minute"),h=c.start.date().getTime(),j=(k=(y=c.end)==null?void 0:y.date().getTime())!=null?k:null,N=j?((p=c.end)==null?void 0:p.isCertain("hour"))&&((M=c.end)==null?void 0:M.isCertain("minute")):!1,_=c.index,b=c.text;let w="";h&&(w+=`data-timestamp-start="${h}"`),j&&(w+=` data-timestamp-end="${j}"`),l||(w+=' data-timestamp-start-all-day="true"'),N||(w+=' data-timestamp-end-all-day="true"'),r=r.slice(0,_)+`<span class="timestamp" ${w}">${b}</span>`+r.slice(_+b.length)}),r}),n=()=>G(null,null,function*(){if(s){const{from:a,to:r,replaceWith:i,empty:u}=s.state.selection;if(u){const c=s.getHTML(),l=yield t(c);s.chain().focus().setContent(l).run()}else{const c=s.view.state.doc.textBetween(a,r," "),l=yield t(c);s.chain().focus().deleteSelection().insertContent(l).run()}}});return s?e.jsx(C,{gap:"3",align:"center",children:e.jsx(z,{"aria-label":"Parse timestamps from message",onClick:n,title:"Parse timestamps from message",variant:"ghost",size:"1",className:O,disabled:!s.can().chain().focus().run(),children:e.jsx(rt,x({},F))})}):e.jsx(U,{})},Rn=Ms.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something â€¦",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new Ds({key:new Be("placeholder"),props:{decorations:({doc:s,selection:t})=>{const n=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:a}=t,r=[];if(!n)return null;const i=this.editor.isEmpty;return s.descendants((u,c)=>{const l=a>=c&&a<=c+u.nodeSize,h=!u.isLeaf&&Xt(u);if((l||!this.options.showOnlyCurrent)&&h){const j=[this.options.emptyNodeClass];i&&j.push(this.options.emptyEditorClass);const N=Qt.node(c,c+u.nodeSize,{class:j.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:u,pos:c,hasAnchor:l}):this.options.placeholder});r.push(N)}return this.options.includeChildren}),en.create(s,r)}}})]}}),Pn=d.forwardRef((s,t)=>{const[n,a]=d.useState(0),r=l=>{const h=s==null?void 0:s.items[l];h&&s.command({id:h.name,label:h.full_name})},i=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},u=()=>{a((n+1)%(s==null?void 0:s.items.length))},c=()=>{r(n)};return d.useEffect(()=>a(0),[s==null?void 0:s.items]),d.useImperativeHandle(t,()=>({onKeyDown:({event:l})=>l.key==="ArrowUp"?(i(),!0):l.key==="ArrowDown"?(u(),!0):l.key==="Enter"?(c(),!0):!1})),e.jsx(Oe,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(C,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-96 rounded-md",children:s!=null&&s.items.length?s.items.map((l,h)=>e.jsx(Fn,{item:l,index:h,selectItem:r,selectedIndex:n,itemsLength:s.items.length},l.name)):e.jsx("div",{className:"item",children:"No result"})})})}),Fn=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{const i=it(s.name),u=d.useRef(null);return d.useEffect(()=>{var c;t===a&&((c=u.current)==null||c.scrollIntoView({block:"nearest"}))},[a,t]),e.jsxs(C,{role:"button",ref:u,align:"center",title:s.full_name,"aria-label":`Mention ${s.full_name}`,className:Z("px-3 py-1.5 gap-2 rounded-md",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:[e.jsx(Me,{src:s.user_image,alt:s.full_name,loading:"lazy",variant:"solid",radius:"full",isActive:i,availabilityStatus:s.availability_status}),e.jsxs(je,{width:"100%",justify:"between",align:"center",gap:"2",children:[e.jsxs(R,{as:"span",weight:"medium",size:"2",children:[" ",s.full_name]}),e.jsx(R,{as:"span",color:"gray",children:!s.is_member&&e.jsx(lt,{title:"This user is not a member of the channel"})})]})]},t)},On=d.forwardRef((s,t)=>{const[n,a]=d.useState(0),r=l=>{const h=s==null?void 0:s.items[l];h&&s.command({id:h.name,label:h.channel_name})},i=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},u=()=>{a((n+1)%(s==null?void 0:s.items.length))},c=()=>{r(n)};return d.useEffect(()=>a(0),[s==null?void 0:s.items]),d.useImperativeHandle(t,()=>({onKeyDown:({event:l})=>l.key==="ArrowUp"?(i(),!0):l.key==="ArrowDown"?(u(),!0):l.key==="Enter"?(c(),!0):!1})),e.jsx(Oe,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(C,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-64 rounded-md",children:s!=null&&s.items.length?s.items.map((l,h)=>e.jsx($n,{item:l,index:h,selectItem:r,selectedIndex:n,itemsLength:s.items.length},l.name)):e.jsx("div",{className:"item",children:"No result"})})})}),$n=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{const i=d.useRef(null);return d.useEffect(()=>{var u;t===a&&((u=i.current)==null||u.scrollIntoView({block:"nearest"}))},[a,t]),e.jsxs(C,{role:"button",align:"center",ref:i,title:s.channel_name,"aria-label":`Mention channel ${s.channel_name}`,className:Z("px-3 py-2 gap-2 rounded-md",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:[e.jsx(ze,{type:s.type,size:"18"}),e.jsxs(R,{as:"span",weight:"medium",size:"2",children:[" ",s.channel_name]})]},t)};function Wa(s){return $e({attr:{viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{d:"M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 0 0 1.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06ZM18.584 5.106a.75.75 0 0 1 1.06 0c3.808 3.807 3.808 9.98 0 13.788a.75.75 0 0 1-1.06-1.06 8.25 8.25 0 0 0 0-11.668.75.75 0 0 1 0-1.06Z"},child:[]},{tag:"path",attr:{d:"M15.932 7.757a.75.75 0 0 1 1.061 0 6 6 0 0 1 0 8.486.75.75 0 0 1-1.06-1.061 4.5 4.5 0 0 0 0-6.364.75.75 0 0 1 0-1.06Z"},child:[]}]})(s)}function Za(s){return $e({attr:{viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{d:"M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 0 0 1.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06ZM17.78 9.22a.75.75 0 1 0-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06l1.72-1.72 1.72 1.72a.75.75 0 1 0 1.06-1.06L20.56 12l1.72-1.72a.75.75 0 1 0-1.06-1.06l-1.72 1.72-1.72-1.72Z"},child:[]}]})(s)}function Hn(s){return $e({attr:{fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{strokeLinecap:"round",strokeLinejoin:"round",d:"M12.75 8.25v7.5m6-7.5h-3V12m0 0v3.75m0-3.75H18M9.75 9.348c-1.03-1.464-2.698-1.464-3.728 0-1.03 1.465-1.03 3.84 0 5.304 1.03 1.464 2.699 1.464 3.728 0V12h-1.5M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"},child:[]}]})(s)}const Un=()=>{const{editor:s}=Q(),[t,n]=d.useState(!1);return d.useEffect(()=>{const a=r=>{r.key==="k"&&(r.metaKey||r.ctrlKey)&&r.shiftKey&&(r.preventDefault(),n(i=>!i))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[]),s?e.jsxs(de,{open:t,onOpenChange:n,children:[e.jsx(W,{content:`Insert a command (${$()} + Shift + K)`,children:e.jsx(z,{size:"1",variant:"ghost",className:O,onClick:()=>n(!0),title:"Insert a Command","aria-label":"insert a command",children:e.jsx(ct,x({},F))})}),e.jsxs(ue,{className:Ne,children:[e.jsx(ye,{children:"Insert a command"}),e.jsx(we,{size:"2",children:"Select a saved command to insert into your message."}),e.jsx(Vn,{onClose:()=>n(!1)})]})]}):null},Vn=({onClose:s})=>{const{editor:t}=Q(),n=me(),{data:a,isLoading:r}=ds("raven.api.ai_features.get_saved_prompts",{}),i=He();return e.jsxs(fe,{label:"Global Command Menu",className:"command-menu",children:[e.jsx(fe.Input,{autoFocus:n,className:"ml-0 my-2 text-base italic",placeholder:"Search saved prompts"}),e.jsxs(fe.List,{children:[e.jsx(fe.Empty,{className:"py-4",children:e.jsxs(us,{align:"center",justify:"center",gap:"2",children:[e.jsx(R,{size:"2",color:"gray",weight:"medium",children:"No saved prompts found"}),e.jsx(U,{children:e.jsx(X,{className:"not-cal",variant:"soft",onClick:()=>i("/settings/commands"),children:"Create"})})]})}),r&&e.jsx(fe.Loading,{children:"Loading..."}),a==null?void 0:a.message.map(u=>e.jsx(fe.Item,{onSelect:()=>{t==null||t.chain().focus().insertContent(u.prompt).run(),s()},keywords:[u.prompt],value:u.prompt,children:u.prompt},u.name))]})]})},Ls=()=>({recentlyUsedDoctypes:d.useMemo(()=>{var a;const n=(a=sessionStorage.getItem("recently-used-doctype"))!=null?a:"[]";return JSON.parse(n).map(r=>({value:r,description:"Recently used"}))},[]),addRecentlyUsedDocType:n=>{var i;const a=(i=sessionStorage.getItem("recently-used-doctype"))!=null?i:"[]";let r=JSON.parse(a);r.includes(n)||(r=[n,...r].slice(0,5)),sessionStorage.setItem("recently-used-doctype",JSON.stringify(r))}}),Kn=({channelID:s})=>{const[t,{off:n},a]=ms();return e.jsxs(de,{open:t,onOpenChange:a,children:[e.jsx(W,{content:"Attach a document from the system",children:e.jsx(hs,{children:e.jsx(z,{"aria-label":"Attach a document from the system",variant:"ghost",className:O,size:"1",title:"Attach a document from the system",children:e.jsx(ot,x({},F))})})}),e.jsxs(ue,{className:"static",children:[e.jsx(ye,{className:"mb-1",children:"Send a document"}),e.jsx(we,{size:"2",children:"Choose a document from the system to send."}),e.jsx(qn,{channelID:s,onClose:n})]})]})},qn=({channelID:s,onClose:t})=>{var w,y;const{loading:n,error:a,createDoc:r}=gs(),i=Ue(),{watch:u}=i,c=()=>{i.reset(),t()},l=u("doctype"),h=u("docname"),{recentlyUsedDoctypes:j,addRecentlyUsedDocType:N}=Ls(),_=k=>{N(k.doctype),r("Raven Message",{message_type:"Text",channel_id:s,text:k.message,link_doctype:k.doctype,link_document:k.docname}).then(()=>{c()})},b=()=>{i.setValue("docname","")};return e.jsx("form",{className:"pt-2",onSubmit:i.handleSubmit(_),children:e.jsx(Ve,A(x({},i),{children:e.jsxs(us,{gap:"2",children:[a&&e.jsx(he,{error:a}),e.jsx(U,{width:"100%",children:e.jsxs(C,{direction:"column",gap:"2",children:[e.jsx(De,{name:"doctype",label:"Document Type",autofocus:!0,suggestedItems:j,required:!0,rules:{required:"Document Type is required",onChange:b},filters:[["issingle","=",0],["istable","=",0]],doctype:"DocType"}),e.jsx(Ce,{children:(w=i.formState.errors.doctype)==null?void 0:w.message})]})}),l&&e.jsx(U,{width:"100%",children:e.jsxs(C,{direction:"column",gap:"2",children:[e.jsx(De,{name:"docname",required:!0,label:"Document Name",placeholder:"Select a document",disabled:!l,rules:{required:"Document Name is required"},doctype:l}),e.jsx(Ce,{children:(y=i.formState.errors.docname)==null?void 0:y.message})]})}),e.jsx("div",{className:Z("transition-all duration-500",h?"opacity-100":"opacity-0"),children:l&&h&&e.jsx(vn,{doctype:l,docname:h})}),e.jsx(U,{width:"100%",children:e.jsxs(C,{direction:"column",gap:"0",children:[e.jsxs(fs,{children:["Message ",e.jsx(R,{as:"span",size:"1",color:"gray",children:"(Optional)"})]}),e.jsx(dt,A(x({},i.register("message")),{placeholder:"Enter a message to send with the document"}))]})}),e.jsxs(C,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(be,{disabled:n,children:e.jsx(X,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(X,{type:"button",disabled:n,onClick:i.handleSubmit(_),children:[n&&e.jsx(Y,{className:"text-white"}),"Send"]})]})]})}))})};function Yn(s={}){const{language:t="fr-FR",continuous:n=!1,interimResults:a=!0,onResult:r,onError:i}=s,[u,c]=d.useState(!1),[l,h]=d.useState(""),j=d.useRef(null),N=typeof window!="undefined"&&("SpeechRecognition"in window||"webkitSpeechRecognition"in window);d.useEffect(()=>{if(!N)return;const y=window.SpeechRecognition||window.webkitSpeechRecognition,k=new y;return k.continuous=n,k.interimResults=a,k.lang=t,k.onstart=()=>{c(!0)},k.onresult=p=>{let M="",T="";for(let I=p.resultIndex;I<p.results.length;I++){const V=p.results[I];V.isFinal?M+=V[0].transcript:T+=V[0].transcript}const E=M||T;h(E),r&&r(E,!!M)},k.onerror=p=>{console.error("Speech recognition error:",p.error),c(!1),i&&i(p.error)},k.onend=()=>{c(!1)},j.current=k,()=>{j.current&&j.current.abort()}},[N,t,n,a,r,i]);const _=d.useCallback(()=>{if(!N||!j.current){console.error("Speech recognition is not supported in this browser"),i&&i("not-supported");return}h("");try{j.current.start()}catch(y){console.error("Error starting speech recognition:",y)}},[N,i]),b=d.useCallback(()=>{j.current&&j.current.stop()},[]),w=d.useCallback(()=>{h("")},[]);return{isListening:u,isSupported:N,transcript:l,startListening:_,stopListening:b,resetTranscript:w}}const Jn=({language:s="fr-FR"})=>{const{editor:t}=Q(),n=d.useCallback((h,j)=>{t&&j&&h.trim()&&t.chain().focus().insertContent(h+" ").run()},[t]),a=d.useCallback(h=>{h==="not-allowed"?q.error(te("Microphone access denied"),{description:te("Please allow microphone access in your browser settings")}):h==="not-supported"?q.error(te("Speech recognition not supported"),{description:te("Your browser does not support speech recognition")}):h!=="no-speech"&&h!=="aborted"&&q.error(te("Speech recognition error"),{description:h})},[]),{isListening:r,isSupported:i,startListening:u,stopListening:c}=Yn({language:s,continuous:!0,interimResults:!0,onResult:n,onError:a});if(d.useEffect(()=>()=>{r&&c()},[r,c]),!t||!i)return null;const l=()=>{r?c():u()};return e.jsx(W,{content:r?te("Stop dictation"):te("Voice dictation"),children:e.jsx(z,{size:"1",variant:"ghost",className:r?"bg-red-3 text-red-11 animate-pulse":O,onClick:l,disabled:!t.isEditable,title:r?te("Stop dictation"):te("Voice dictation"),"aria-label":r?"stop dictation":"start dictation",children:r?e.jsx(ut,A(x({},F),{className:"text-red-11"})):e.jsx(mt,x({},F))})})},Gn=d.lazy(()=>ke(()=>import("./EmojiPicker-J_iKZ5Mw.js"),__vite__mapDeps([0,1,2,3]))),Wn=d.lazy(()=>ke(()=>import("./CreatePoll-A-Bb7bim.js"),__vite__mapDeps([4,1,2,5]))),Zn=d.lazy(()=>ke(()=>import("./GIFPicker-D7CZtAfl.js"),__vite__mapDeps([6,1,2,7,8]))),Xn=r=>{var i=r,{fileProps:s,channelID:t,isEdit:n}=i,a=K(i,["fileProps","channelID","isEdit"]);return e.jsxs(C,{gap:"2",align:"center",px:"1",py:"1",children:[e.jsxs(C,{gap:"3",align:"center",children:[!n&&t&&e.jsx(Kn,{channelID:t}),e.jsx(Qn,{})]}),e.jsx(oe,{orientation:"vertical"}),e.jsxs(C,{gap:"3",align:"center",children:[e.jsx(Un,{}),t&&e.jsx(na,{channelID:t})]}),e.jsx(oe,{orientation:"vertical"}),e.jsxs(C,{gap:"3",align:"center",children:[e.jsx(ea,{}),e.jsx(sa,{}),s&&e.jsx(ta,{fileProps:s}),e.jsx(Jn,{})]}),e.jsx(oe,{orientation:"vertical"}),e.jsx(Bs,x({},a))]})},Qn=()=>{const{editor:s}=Q();return s?e.jsxs(C,{gap:"3",children:[e.jsx(z,{onClick:()=>s.chain().focus().insertContent("#").run(),"aria-label":"mention channel",title:"Mention a channel",className:O,variant:"ghost",size:"1",disabled:!s.can().chain().focus().insertContent("#").run()||!s.isEditable,children:e.jsx(yt,x({},F))}),e.jsx(z,{onClick:()=>s.chain().focus().insertContent("@").run(),"aria-label":"mention user",variant:"ghost",className:O,size:"1",title:"Mention a user",disabled:!s.can().chain().focus().insertContent("@").run()||!s.isEditable,children:e.jsx(wt,x({},F))})]}):null},ea=()=>{const{editor:s}=Q();if(!s)return null;const t=(n,a,r)=>{a?s.chain().focus().setImage({src:n,alt:r,title:r}).run():s.chain().focus().insertContent(n).run()};return e.jsxs(xs,{children:[e.jsx(js,{children:e.jsx(z,{size:"1",variant:"ghost",className:O,title:"Add emoji",disabled:!s.can().chain().focus().insertContent("ðŸ˜…").run()||!s.isEditable,"aria-label":"add emoji",children:e.jsx(vt,x({},F))})}),e.jsx(ps,{children:e.jsx(qe,{children:e.jsx(d.Suspense,{fallback:e.jsx(Y,{}),children:e.jsx(Gn,{onSelect:t,allowCustomEmojis:!1})})})})]})},sa=()=>{const{editor:s}=Q();return s?e.jsxs(xs,{children:[e.jsx(js,{children:e.jsx(z,{size:"1",variant:"ghost",className:O,title:"Add GIF","aria-label":"add GIF",children:e.jsx(Hn,x({},F))})}),e.jsx(ps,{children:e.jsx(qe,{children:e.jsx(d.Suspense,{fallback:e.jsx(Y,{}),children:e.jsx(Zn,{onSelect:t=>s.chain().focus().setImage({src:t.media_formats.gif.url}).setHardBreak().run()})})})})]}):null},ta=({fileProps:s})=>{const{editor:t}=Q(),n=()=>{var a,r;(a=s.fileInputRef)!=null&&a.current&&((r=s.fileInputRef)==null||r.current.openFileInput())};return e.jsx(z,{size:"1",onClick:n,variant:"ghost",className:O,disabled:(t==null?void 0:t.isEditable)===!1,title:"Attach file","aria-label":"attach file",children:e.jsx(Ct,x({},F))})},Bs=i=>{var u=i,{sendMessage:s,messageSending:t,setContent:n,boxProps:a}=u,r=K(u,["sendMessage","messageSending","setContent","boxProps"]);const{editor:c}=Q(),l=(h=!1)=>{if(c){const j=c.getText().trim().length>0,N=c.getHTML().includes("img");let _="",b={};if(j||N){b=c.getJSON();const w=b.content;for(let y=w.length-1;y>=0&&(w[y].type==="paragraph"&&(!w[y].content||w[y].content.length===0));y--)w.pop();b.content=w,c.commands.setContent(b),_=c.getHTML()}c.setEditable(!1),s(_,b,h).then(()=>{n(""),c.chain().focus().clearContent(!0).run(),c.setEditable(!0)}).catch(()=>{c.setEditable(!0)})}};return e.jsxs(je,A(x({gap:"2",align:"center"},a),{className:Z("bg-accent-a2 py-1 px-1 rounded-radius2",a==null?void 0:a.className),children:[e.jsx(z,A(x({"aria-label":"send message",title:"Send message",size:"1",variant:"ghost",onClick:()=>l()},r),{className:Z("rounded-r-none",r==null?void 0:r.className),children:t?e.jsx(Y,{}):e.jsx(ht,x({},F))})),e.jsxs(gt,{children:[e.jsx(ft,{children:e.jsx(z,A(x({"aria-label":"send message",title:"Other options",variant:"ghost",size:"1"},r),{className:Z("rounded-l-none",r==null?void 0:r.className),children:e.jsx(xt,A(x({},F),{className:"text-accent-a8"}))}))}),e.jsx(jt,{children:e.jsxs(pt,{onClick:()=>l(!0),children:[e.jsx(bt,{}),"Send without notification"]})})]})]}))},na=({channelID:s})=>{const[t,,n]=ms(!1),{editor:a}=Q();return e.jsxs(de,{open:t,onOpenChange:n,children:[e.jsx(hs,{children:e.jsx(z,{size:"1",variant:"ghost",className:O,disabled:(a==null?void 0:a.isEditable)===!1,title:"Create Poll","aria-label":"create poll",children:e.jsx(_t,{})})}),e.jsxs(ue,{className:Ne,children:[e.jsx(ye,{children:"Create Poll"}),e.jsx(we,{size:"2",children:"Create a quick poll to get everyone's thoughts on a topic."}),e.jsx(d.Suspense,{fallback:e.jsx(Y,{}),children:e.jsx(Wn,{channelID:s,setIsOpen:n})})]})]})},aa=d.forwardRef((s,t)=>{const[n,a]=d.useState(0),r=l=>{const h=s==null?void 0:s.items[l];h&&s.command(h)},i=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},u=()=>{a((n+1)%(s==null?void 0:s.items.length))},c=()=>{r(n)};return d.useEffect(()=>a(0),[s==null?void 0:s.items]),d.useImperativeHandle(t,()=>({onKeyDown:({event:l})=>l.key==="ArrowUp"?(i(),!0):l.key==="ArrowDown"?(u(),!0):l.key==="Enter"?(c(),!0):!1})),e.jsx(Oe,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(C,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-96 rounded-md",children:s!=null&&s.items.length?s.items.map((l,h)=>{var j;return e.jsx(ra,{item:l,index:h,selectItem:r,selectedIndex:n,itemsLength:s.items.length},(j=l.shortcodes)!=null?j:l.id)}):null})})}),ra=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{var u;const i=d.useRef(null);return d.useEffect(()=>{var c;t===a&&((c=i.current)==null||c.scrollIntoView({block:"nearest"}))},[a,t]),e.jsx(C,{role:"button",ref:i,align:"center",title:s.id,"aria-label":`Select emoji ${s.id}`,className:Z("px-3 py-1.5 gap-2 rounded-md cursor-pointer",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:e.jsxs(R,{as:"span",weight:"medium",size:"2",children:[e.jsx("em-emoji",{shortcodes:s.shortcodes})," ",(u=s.shortcodes)!=null?u:s.id]})},t)};function ia(s,t=10){return G(this,null,function*(){const n=yield ys.search(s,{maxResults:t,caller:void 0}),a=[];return n.forEach(r=>{r&&r.skins[0].native&&a.push({shortcodes:r.skins[0].shortcodes,emoji:r.skins[0].native,name:r.name,id:r.id})}),a})}function la(s=10){const t=bs.get({maxFrequentRows:1,perLine:s}),n=[];return t.forEach(a=>{const r=ys.get(a);r&&r.skins[0].native&&n.push({id:r.id,shortcodes:r.skins[0].shortcodes,emoji:r.skins[0].native,name:r.name})}),n}const ca=sn.create({name:"emoji",group:"inline",pluginKey:new Be("emojiSuggestion"),inline:!0,selectable:!1,atom:!0,addProseMirrorPlugins(){return[fn({editor:this.editor,char:":",allowedPrefixes:null,items:s=>s.query.length!==0?ia(s.query):la(),render:()=>{let s,t;return{onStart:n=>{s=new Re(aa,{props:n,editor:n.editor}),n.clientRect&&(t=Pe("body",{getReferenceClientRect:n.clientRect,appendTo:()=>document.body,content:s.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(n){s.updateProps(n),n.clientRect&&t[0].setProps({getReferenceClientRect:n.clientRect})},onKeyDown(n){var a;return n.event.key==="Escape"?(t[0].hide(),!0):(a=s.ref)==null?void 0:a.onKeyDown(n)},onExit(){t[0].destroy(),s.destroy()}}},command:({editor:s,range:t,props:n})=>{var a;s.chain().focus().deleteRange(t).insertContent(n.emoji).run(),bs.add(n.id),(a=window.getSelection())==null||a.collapseToEnd()}})]}}),oa=d.lazy(()=>ke(()=>import("./MobileInputActions-CSqL-36P.js"),__vite__mapDeps([9,1,2,10,11,12,13,14,15,16,17,18,7,19,20,21,22,23]))),ge=an(cn);ge.register("html",on);ge.register("css",dn);ge.register("js",un);ge.register("ts",mn);ge.register("json",hn);ge.register("python",gn);const da=As.extend({name:"userMention"}).configure({suggestion:{char:"@",pluginKey:new Be("userMention"),allowedPrefixes:null,allow:s=>{const t=s.state.doc.textBetween(s.range.from-1,s.range.from,"");return!/[a-zA-Z0-9]/.test(t)}}}),ua=As.extend({name:"channelMention"}).configure({suggestion:{char:"#",pluginKey:new Be("channelMention"),allowedPrefixes:null,allow:s=>{const t=s.state.doc.textBetween(s.range.from-1,s.range.from,"");return!/[a-zA-Z0-9]/.test(t)}}}),ma=d.forwardRef(({isEdit:s,slotBefore:t,fileProps:n,onMessageSend:a,onUpArrow:r,channelMembers:i,onUserType:u,channelID:c,replyMessage:l,clearReplyMessage:h,placeholder:j="Type a message...",messageSending:N,sessionStorageKey:_="tiptap-editor",disableSessionStorage:b=!1,defaultText:w=""},y)=>{const{enabledUsers:k}=d.useContext(ws),p=d.useRef([]);d.useEffect(()=>{i?p.current=k.map(o=>A(x({},o),{is_member:o.name in i})).sort((o,g)=>o.is_member?-1:1):p.current=k.map(o=>A(x({},o),{is_member:!0}))},[i,k]);const{channels:M}=d.useContext(_s),{workspaceID:T}=vs(),E=Cs(),[I]=os(Cn),V=o=>{const g=o.getText().trim().length>0;let f="",v={};return g&&(f=o.getHTML(),v=o.getJSON()),o.setEditable(!1),a(f,v).then(()=>{o.commands.clearContent(!0),o.setEditable(!0),o.commands.focus("start")}).catch(()=>{o.setEditable(!0)}),o.commands.clearContent(!0)},ne=o=>o.commands.first(({commands:g})=>[()=>g.newlineInCode(),()=>g.createParagraphNear(),()=>g.liftEmptyBlock(),()=>g.splitBlock()]),ee=Ms.create({name:"keyboardHandler",addKeyboardShortcuts(){return{Enter:()=>{if(matchMedia("(max-device-width: 768px)").matches||matchMedia("(max-device-width: 1024px)").matches)return!1;const o=this.editor.isActive("codeBlock"),g=this.editor.isActive("listItem");return o||g?!1:I==="send-message"?V(this.editor):ne(this.editor)},"Mod-Enter":()=>{const o=this.editor.isActive("codeBlock"),g=this.editor.isActive("listItem"),f=this.editor.getText().trim().length>0;if(o)return this.editor.commands.newlineInCode();if(g)return!1;if(!o&&!g){let v="",B={};return f&&(v=this.editor.getHTML(),B=this.editor.getJSON()),this.editor.setEditable(!1),a(v,B).then(()=>{this.editor.commands.clearContent(!0),this.editor.setEditable(!0)}).catch(()=>{this.editor.setEditable(!0)}),this.editor.commands.clearContent(!0)}return!1},Backspace:()=>this.editor.isEmpty?(h==null||h(),this.editor.commands.clearContent(!0)):!1,"Shift-Enter":()=>ne(this.editor),ArrowUp:()=>(this.editor.isEmpty&&(r==null||r()),!1)}},addProseMirrorPlugins(){return[new Ds({props:{handleDOMEvents:{drop(o,g){if(!(g.dataTransfer&&g.dataTransfer.files&&g.dataTransfer.files.length)||!n)return;const v=Array.from(g.dataTransfer.files).filter(B=>/image/i.test(B.type));v.length!==0&&(g.preventDefault(),v.forEach(B=>{n.addFile(B)}))},paste(o,g){if(!(g.clipboardData&&g.clipboardData.files&&g.clipboardData.files.length)||!n)return;const v=Array.from(g.clipboardData.files);v.length!==0&&(g.preventDefault(),v.forEach(B=>{n.addFile(B)}))}}}})]}}),ae=[tn.configure({heading:!1,codeBlock:!1,listItem:{HTMLAttributes:{class:"rt-Text text-sm"}},paragraph:{HTMLAttributes:{class:"rt-Text text-sm"}},code:{HTMLAttributes:{class:"pt-0.5 px-1 pb-px bg-[var(--gray-a3)] dark:bg-[#0d0d0d] text-[var(--ruby-a11)] dark-[var(--accent-a3)] text text-xs font-mono rounded border border-gray-4 dark:border-gray-6"}}}),xn,jn.configure({multicolor:!0,HTMLAttributes:{class:"bg-[var(--yellow-6)] dark:bg-[var(--yellow-11)] px-2 py-1"}}),pn.extend({inclusive:!1}).configure({autolink:!0}),Rn.configure({placeholder:j}),nn.extend({addKeyboardShortcuts(){var o;return A(x({},(o=this.parent)==null?void 0:o.call(this)),{"Mod-Shift-E":()=>this.editor.commands.toggleCodeBlock()})}}).configure({lowlight:ge}),bn.configure({inline:!0}),ee,da.configure({HTMLAttributes:{class:"mention"},renderHTML({options:o,node:g}){var f;return`${o.suggestion.char}${(f=g.attrs.label)!=null?f:g.attrs.id}`},suggestion:{items:o=>p.current.filter(g=>g.full_name.toLowerCase().startsWith(o.query.toLowerCase())).slice(0,10),render:()=>{let o,g;return{onStart:f=>{o=new Re(Pn,{props:f,editor:f.editor}),f.clientRect&&(g=Pe("body",{getReferenceClientRect:f.clientRect,appendTo:()=>document.body,content:o.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(f){o.updateProps(f),f.clientRect&&g[0].setProps({getReferenceClientRect:f.clientRect})},onKeyDown(f){var v;return f.event.key==="Escape"?(g[0].hide(),!0):(v=o.ref)==null?void 0:v.onKeyDown(f)},onExit(){g[0].destroy(),o.destroy()}}}}}),ua.configure({HTMLAttributes:{class:"mention"},renderHTML({options:o,node:g}){var f;return`${o.suggestion.char}${(f=g.attrs.label)!=null?f:g.attrs.id}`},suggestion:{items:o=>M.filter(g=>g.workspace===T&&g.channel_name.toLowerCase().startsWith(o.query.toLowerCase())).slice(0,10),render:()=>{let o,g;return{onStart:f=>{o=new Re(On,{props:f,editor:f.editor}),f.clientRect&&(g=Pe("body",{getReferenceClientRect:f.clientRect,appendTo:()=>document.body,content:o.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(f){o.updateProps(f),f.clientRect&&g[0].setProps({getReferenceClientRect:f.clientRect})},onKeyDown(f){var v;return f.event.key==="Escape"?(g[0].hide(),!0):(v=o.ref)==null?void 0:v.onKeyDown(f)},onExit(){g[0].destroy(),o.destroy()}}}}}),ca,yn],[re,D]=kt(w,_,b),L=me(),m=rn({extensions:ae,content:re,editorProps:{handleTextInput(){u==null||u()},attributes:{class:"tiptap-editor"+(l?" replying":"")+(s?" editing-message":"")}},onUpdate({editor:o}){D(o.getHTML())}},[l,u]);return d.useEffect(()=>{(L||s)&&setTimeout(()=>{m==null||m.chain().focus("end").run()},50)},[m,L,s,l]),d.useImperativeHandle(y,()=>({focusEditor:()=>{m==null||m.chain().focus().run()}})),E?e.jsx(U,{className:Z("pt-2 pb-8 w-full bg-white dark:bg-gray-2 z-50 border-t border-t-gray-3 dark:border-t-gray-3",s?"bg-transparent dark:bg-transparent":"fixed bottom-0 left-0 px-4"),children:e.jsxs(Ze.Provider,{value:{editor:m},children:[t,e.jsxs(C,{align:"end",gap:"2",className:"w-full",children:[!s&&e.jsx("div",{className:"w-8",children:e.jsx(d.Suspense,{fallback:e.jsx(z,{radius:"full",color:"gray",variant:"soft",size:"2",className:"mb-1",children:e.jsx(Nt,{size:"20"})}),children:e.jsx(oa,{fileProps:n,setContent:D,sendMessage:a,messageSending:N,channelID:c})})}),e.jsx(ln,{tippyOptions:{arrow:!0,offset:[90,15],inlinePositioning:!0},editor:m,children:e.jsx("div",{className:"bg-gray-1 dark:bg-gray-3 shadow-md p-2 rounded-md",children:e.jsx(es,{})})}),e.jsxs("div",{className:"border-[1.5px] flex items-end justify-between border-gray-4 rounded-radius2 w-[calc(100vw-72px)] focus-within:border-accent-a8",children:[e.jsx("div",{className:"w-[85%]",children:e.jsx(Xe,{editor:m})}),e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(Bs,{size:"2",variant:"soft",boxProps:{className:"rounded-r-radius2 rounded-l-none bg-transparent",gap:"0"},className:"bg-transparent hover:bg-accent-a3",sendMessage:a,messageSending:N,setContent:D})})]})]})]})}):e.jsx(U,{className:"border rounded-radius2 border-gray-300 dark:border-gray-500 dark:bg-gray-3",children:e.jsxs(Ze.Provider,{value:{editor:m},children:[t,e.jsx(Xe,{editor:m}),e.jsxs(Bn,{children:[e.jsx(es,{}),e.jsx(Xn,{fileProps:n,setContent:D,sendMessage:a,messageSending:N,isEdit:s,channelID:c})]})]})})}),Xa=(s,t,n,a)=>{const{call:r,loading:i}=pe("raven.api.raven_message.send_message"),u=St(d.useCallback(l=>l(Is(s)),[s]));return{sendMessage:d.useCallback((l,h,j=!1)=>G(null,null,function*(){const _=u().length>0;return l&&_?t(a,l).then(b=>{n(b)}):l?r({channel_id:s,text:l,json_content:h,is_reply:a?1:0,linked_message:a?a.name:null,send_silently:!!j}).then(b=>n([b.message])):_?t(a).then(b=>{n(b)}):Promise.resolve()}),[s,a,t,n]),loading:i}},Qa=d.forwardRef((s,t)=>{const M=s,{files:n,onFileChange:a,maxFiles:r,accept:i,maxFileSize:u,children:c,height:l,width:h,areaHeight:j}=M,N=K(M,["files","onFileChange","maxFiles","accept","maxFileSize","children","height","width","areaHeight"]),[_,b]=d.useState(!1),w=T=>u&&T.size>u*1e6?(q.error(`Uh Oh! ${T.name} exceeded the maximum file size required.`),{code:"size-too-large",message:"File size is larger than the required size."}):null,{getRootProps:y,getInputProps:k,open:p}=Tt({onDrop:(T,E)=>{a([...n,...T.map(I=>Object.assign(I,{fileID:I.name+Date.now(),uploadProgress:0}))]),r&&r<E.length&&q.error(`Uh Oh! Maximum ${r} files can be uploaded. Please try again.`)},maxFiles:r||0,accept:i||void 0,validator:w,noClick:!0,noKeyboard:!0,onDragEnter:()=>b(!0),onDragLeave:()=>b(!1),onDropAccepted:()=>b(!1),onDropRejected:()=>b(!1)});return d.useImperativeHandle(t,()=>({openFileInput(){p()}})),e.jsxs(C,A(x(x({direction:"column",style:{height:l!=null?l:"calc(100vh - 80px)"},width:"100%"},y()),N),{children:[c,(r===void 0||n.length<r)&&e.jsxs(C,{align:"center",justify:"center",className:Z("fixed top-14 border-2 border-dashed rounded-md border-gray-6 dark:bg-[#171923AA] bg-[#F7FAFCAA]",j!=null?j:"h-[calc(100vh-72px)]",h!=null?h:"w-[calc(100vw-var(--sidebar-width)-var(--space-8))]"),style:{zIndex:9999},display:_?"flex":"none",children:[e.jsx(R,{as:"span",size:"2",color:"gray",children:"Drop your files here. A Raven will pick it up."}),e.jsx("input",x({type:"file",style:{display:"none"}},k()))]})]}))}),ha=({onClose:s,message:t})=>{const{deleteDoc:n,error:a,loading:r}=Et(),i=He(),u=()=>G(null,null,function*(){return n("Raven Message",t.name).then(()=>{q("Message deleted",{duration:800}),t.is_thread&&i(`/channel/${t.channel_id}`),s()})});return e.jsxs(e.Fragment,{children:[e.jsxs(Mt,{children:["Delete ",t.is_thread?"Thread":"Message"]}),e.jsxs(C,{direction:"column",gap:"2",children:[e.jsxs(ks,{color:"red",size:"1",children:[e.jsx(Ns,{children:e.jsx(Dt,{size:"18"})}),e.jsx(Ss,{size:"2",children:"This action is permanent and cannot be undone."})]}),e.jsx(he,{error:a}),t.is_thread?e.jsx(R,{size:"2",children:"This message is a thread, deleting it will delete all messages in the thread."}):e.jsx(R,{size:"2",children:"Are you sure you want to delete this message? It will be deleted for all users."})]}),e.jsxs(C,{gap:"3",mt:"4",justify:"end",children:[e.jsx(At,{children:e.jsx(X,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsx(It,{children:e.jsxs(X,{variant:"solid",color:"red",onClick:u,disabled:r,children:[r&&e.jsx(Y,{className:"text-white"}),r?"Deleting":"Delete"]})})]})]})},ga=s=>{const[t,n]=d.useState(null),a=d.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setDeleteMessage:n,isOpen:t!==null,onClose:a}},fa=({message:s,isOpen:t,onClose:n})=>e.jsx(Lt,{open:t,onOpenChange:n,children:e.jsx(Bt,{className:Ne,children:s&&e.jsx(ha,{onClose:n,message:s})})}),ss=({onClose:s,message:t})=>{const{updateDoc:n,error:a,loading:r,reset:i}=zt();d.useEffect(()=>{i()},[i]);const u=(c,l)=>G(null,null,function*(){return n("Raven Message",t.name,{text:c,json:l}).then(h=>{s(!0),q.info("Message updated")})});return e.jsxs(e.Fragment,{children:[e.jsxs(C,{justify:"between",children:[e.jsx(ye,{children:"Edit Message"}),e.jsx(Ts,{children:e.jsx(we,{children:"Type in the new message text"})}),e.jsx(be,{disabled:r,className:"invisible sm:visible",children:e.jsx(z,{size:"1",variant:"soft",color:"gray",children:e.jsx(Ke,{size:"18"})})})]}),e.jsxs(C,{gap:"2",direction:"column",children:[e.jsx(he,{error:a}),e.jsx(ma,{onMessageSend:u,isEdit:!0,disableSessionStorage:!0,messageSending:r,defaultText:t.text}),e.jsx(C,{justify:"end",className:"hidden sm:block",children:e.jsxs(R,{size:"1",color:"gray",children:["Press ",e.jsx("b",{children:"Enter"})," to save"]})})]})]})},xa=s=>{const[t,n]=d.useState(null),a=d.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setEditMessage:n,isOpen:t!==null,onClose:a}},ja=({message:s,isOpen:t,onClose:n})=>me()?e.jsx(de,{open:t,onOpenChange:n,children:e.jsx(ue,{className:Ne,children:s&&e.jsx(ss,{message:s,onClose:n})})}):e.jsx(Ie,{open:t,onClose:n,children:e.jsx(Le,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(ss,{message:s,onClose:n})})})}),pa=(s,t,n)=>{var D,L;Rt(),He();const a=Cs(),{currentUser:r}=d.useContext(Es),[i,u]=Pt(),c=i.get("message_id"),[l,h]=d.useState(c||null);d.useEffect(()=>{let m=null;return l&&(m=setTimeout(()=>{h(null)},4e3)),()=>{m&&clearTimeout(m)}},[l]);const{call:j,loading:N}=pe("raven.api.chat_stream.get_older_messages"),{call:_,loading:b}=pe("raven.api.chat_stream.get_newer_messages"),w=d.useRef(!1),y=(m="auto")=>{if(!t.current)return;requestAnimationFrame(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})});const o=setTimeout(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})},100),g=setTimeout(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})},500);return()=>{clearTimeout(o),clearTimeout(g)}},k=(m,o="smooth")=>{requestAnimationFrame(()=>{var v;(v=document.getElementById(`message-${m}`))==null||v.scrollIntoView({behavior:o,block:"center"})});const g=setTimeout(()=>{var v;(v=document.getElementById(`message-${m}`))==null||v.scrollIntoView({behavior:o,block:"center"})},100),f=setTimeout(()=>{var v;(v=document.getElementById(`message-${m}`))==null||v.scrollIntoView({behavior:o,block:"center"})},250);return()=>{clearTimeout(g),clearTimeout(f)}},{data:p,isLoading:M,error:T,mutate:E}=ds("raven.api.chat_stream.get_messages",{channel_id:s,base_message:c||void 0},{path:`get_messages_for_channel_${s}`,baseMessage:c||void 0},{revalidateOnFocus:!!a,onSuccess:m=>{let o;return l?o=k(l):m.message.has_new_messages||(o=y(),w.current=!0),()=>{o&&o()}}});d.useEffect(()=>{if(!i.get("message_id"))return y()},[s]);const{call:I}=pe("raven.api.raven_channel_member.track_visit");d.useEffect(()=>()=>{w.current&&I({channel_id:s})},[s]),Ft("Raven Channel",s!=null?s:"",()=>{}),xe("message_created",m=>{m.channel_id===s&&E(o=>{var g,f,v;if(o&&o.message.has_new_messages===!1){const B=(g=o.message.messages)!=null?g:[],H=[...B];if(m.message_details){const P=B.findIndex(S=>S.name===m.message_details.name);P!==-1?H[P]=m.message_details:H.push(m.message_details)}return H.sort((P,S)=>new Date(S.creation).getTime()-new Date(P.creation).getTime()),{message:{messages:H,has_old_messages:(f=o.message.has_old_messages)!=null?f:!1,has_new_messages:(v=o.message.has_new_messages)!=null?v:!1}}}else return o},{revalidate:!1}).then(()=>{(p==null?void 0:p.message.has_new_messages)===!1&&t.current&&(t.current.scrollTop+t.current.clientHeight>=t.current.scrollHeight-100||m.message_details.owner===r)&&y("smooth")})}),xe("message_edited",m=>{E(o=>m.message_id&&o?{message:{messages:o.message.messages.map(f=>f.name===m.message_id?x(x({},f),m.message_details):f),has_old_messages:o.message.has_old_messages,has_new_messages:o.message.has_new_messages}}:o,{revalidate:!1})}),xe("message_deleted",m=>{E(o=>o&&{message:{messages:o.message.messages.filter(f=>f.name!==m.message_id),has_old_messages:o.message.has_old_messages,has_new_messages:o.message.has_new_messages}},{revalidate:!1})}),xe("message_reacted",m=>{E(o=>m.message_id&&o?{message:{messages:o.message.messages.map(f=>f.name===m.message_id?A(x({},f),{message_reactions:m.reactions}):f),has_old_messages:o.message.has_old_messages,has_new_messages:o.message.has_new_messages}}:o,{revalidate:!1})}),xe("message_saved",m=>{E(o=>m.message_id&&o?{message:{messages:o.message.messages.map(f=>f.name===m.message_id?A(x({},f),{_liked_by:m.liked_by}):f),has_old_messages:o.message.has_old_messages,has_new_messages:o.message.has_new_messages}}:o,{revalidate:!1})});const V=()=>{if(N||!(p!=null&&p.message.has_old_messages))return Promise.resolve();const m=t.current;if(!m)return Promise.resolve();const o=m.scrollHeight,g=m.scrollTop;return E(f=>{let v=null;return f&&f.message.messages.length>0&&f.message.has_old_messages&&(v=f.message.messages[f.message.messages.length-1],v)?j({channel_id:s,from_message:v.name}).then(B=>{var P,S,J;return{message:{messages:[...f.message.messages,...(P=B==null?void 0:B.message.messages)!=null?P:[]],has_old_messages:(S=B==null?void 0:B.message.has_old_messages)!=null?S:!1,has_new_messages:(J=f==null?void 0:f.message.has_new_messages)!=null?J:!1}}}).catch(()=>f):f},{revalidate:!1}).then(()=>{requestAnimationFrame(()=>{if(m){const v=m.scrollHeight-o;m.scrollTop=g+v}})})},ne=()=>{if(b||!(p!=null&&p.message.has_new_messages)||l)return Promise.resolve();E(m=>{let o=null;return m&&m.message.messages.length>0&&m.message.has_new_messages&&(o=m.message.messages[0],o)?_({channel_id:s,from_message:o.name,limit:10}).then(g=>{var v,B,H;return{message:{messages:[...(v=g==null?void 0:g.message.messages)!=null?v:[],...m.message.messages],has_old_messages:(B=m==null?void 0:m.message.has_old_messages)!=null?B:!1,has_new_messages:(H=g==null?void 0:g.message.has_new_messages)!=null?H:!1}}}).catch(()=>m):m},{revalidate:!1}).then(m=>{(m==null?void 0:m.message.has_new_messages)===!1&&(w.current=!0,y("smooth"))})},ee=d.useMemo(()=>{var m;if(p){let o=(m=n==null?void 0:n.split(`
`))!=null?m:[];o=o.map(v=>v.trim());const g=[...p.message.messages],f=[];if(g.length>0){let v=g[g.length-1].creation.split(" ")[0],B=new Date(g[g.length-1].creation.split(".")[0]).getTime();f.push({creation:We(`${v} 00:00:00`).format("Do MMMM YYYY"),message_type:"date",name:v}),f.push(A(x({},g[g.length-1]),{is_continuation:0,is_pinned:o.includes(g[g.length-1].name)?1:0}));for(let H=g.length-2;H>=0;H--){const P=g[H],S=P.creation.split(" ")[0];let J=new Date(P.creation.split(".")[0]).getTime();S!==v&&f.push({creation:We(`${S} 00:00:00`).format("Do MMMM YYYY"),message_type:"date",name:S});const zs=P.is_bot_message?P.bot:P.owner,Se=g[H+1],Rs=Se.message_type==="System"?null:Se.is_bot_message?Se.bot:Se.owner;zs!==Rs?f.push(A(x({},P),{is_continuation:0,is_pinned:o.includes(P.name)?1:0})):J-B>12e4?f.push(A(x({},P),{is_continuation:0,is_pinned:o.includes(P.name)?1:0})):f.push(A(x({},P),{is_continuation:1,is_pinned:o.includes(P.name)?1:0})),v=S,B=new Date(P.creation).getTime()}return f}else return[]}},[p,n]),ae=m=>{var g;const o=ee==null?void 0:ee.findIndex(f=>f.name===m);o!==void 0&&o!==-1?((g=document.getElementById(`message-${m}`))==null||g.scrollIntoView({behavior:"smooth",block:"center"}),h(m)):(u({message_id:m}),h(m))},re=()=>{u({})};return{messages:ee,hasOlderMessages:(D=p==null?void 0:p.message.has_old_messages)!=null?D:!1,hasNewMessages:(L=p==null?void 0:p.message.has_new_messages)!=null?L:!1,loadingOlderMessages:N,isLoading:M,error:T,loadNewerMessages:ne,loadOlderMessages:V,scrollToMessage:ae,highlightedMessage:l,goToLatestMessages:re}},ba=()=>e.jsxs("div",{className:"py-4 animate-fadein",children:[e.jsx(ve,{isContinuation:!0,isShortText:!0}),e.jsx(ve,{isContinuation:!1,isImage:!0}),e.jsx(ve,{isContinuation:!1,isShortText:!0}),e.jsx(ve,{isContinuation:!0,isImage:!0}),e.jsx(ve,{isContinuation:!1,isLongText:!0})]}),ve=({isContinuation:s,isShortText:t,isImage:n,isLongText:a})=>e.jsxs("div",{className:"flex items-start gap-3 p-2",children:[e.jsx("div",{className:"w-8 flex items-center",children:s?e.jsx("div",{}):e.jsx(ya,{})}),e.jsxs("div",{className:"flex flex-col gap-1.5 justify-center",children:[!s&&e.jsxs("div",{className:"flex items-center gap-2 -mt-1",children:[e.jsx(se,{className:"rounded-md w-32 h-5"}),e.jsx(oe,{orientation:"vertical"}),e.jsx(se,{className:"rounded-md w-16 h-5"})]}),t&&e.jsxs("div",{className:"gap-1 flex flex-col",children:[e.jsx(se,{className:"rounded-md w-48 h-5"}),e.jsx(se,{className:"rounded-md w-64 h-5"})]}),a&&e.jsxs("div",{className:"gap-1 flex flex-col",children:[e.jsx(se,{className:"rounded-md w-80 h-5"}),e.jsx(se,{className:"rounded-md w-64 h-5"}),e.jsx(se,{className:"rounded-md w-72 h-5"}),e.jsx(se,{className:"rounded-md w-48 h-5"})]}),n&&e.jsx("div",{className:"gap-1 flex flex-col",children:e.jsx(se,{className:"rounded-md w-96 h-64"})})]})]}),ya=()=>e.jsx(se,{className:"w-8 h-8 rounded-md"});var Fe=new Map,Ee=new WeakMap,ts=0,wa=void 0;function _a(s){return s?(Ee.has(s)||(ts+=1,Ee.set(s,ts.toString())),Ee.get(s)):"0"}function va(s){return Object.keys(s).sort().filter(t=>s[t]!==void 0).map(t=>`${t}_${t==="root"?_a(s.root):s[t]}`).toString()}function Ca(s){const t=va(s);let n=Fe.get(t);if(!n){const a=new Map;let r;const i=new IntersectionObserver(u=>{u.forEach(c=>{var l;const h=c.isIntersecting&&r.some(j=>c.intersectionRatio>=j);s.trackVisibility&&typeof c.isVisible=="undefined"&&(c.isVisible=h),(l=a.get(c.target))==null||l.forEach(j=>{j(h,c)})})},s);r=i.thresholds||(Array.isArray(s.threshold)?s.threshold:[s.threshold||0]),n={id:t,observer:i,elements:a},Fe.set(t,n)}return n}function ka(s,t,n={},a=wa){if(typeof window.IntersectionObserver=="undefined"&&a!==void 0){const l=s.getBoundingClientRect();return t(a,{isIntersecting:a,target:s,intersectionRatio:typeof n.threshold=="number"?n.threshold:0,time:0,boundingClientRect:l,intersectionRect:l,rootBounds:l}),()=>{}}const{id:r,observer:i,elements:u}=Ca(n),c=u.get(s)||[];return u.has(s)||u.set(s,c),c.push(t),i.observe(s),function(){c.splice(c.indexOf(t),1),c.length===0&&(u.delete(s),i.unobserve(s)),u.size===0&&(i.disconnect(),Fe.delete(r))}}function ns({threshold:s,delay:t,trackVisibility:n,rootMargin:a,root:r,triggerOnce:i,skip:u,initialInView:c,fallbackInView:l,onChange:h}={}){var j;const[N,_]=d.useState(null),b=d.useRef(h),[w,y]=d.useState({inView:!!c,entry:void 0});b.current=h,d.useEffect(()=>{if(u||!N)return;let T;return T=ka(N,(E,I)=>{y({inView:E,entry:I}),b.current&&b.current(E,I),I.isIntersecting&&i&&T&&(T(),T=void 0)},{root:r,rootMargin:a,threshold:s,trackVisibility:n,delay:t},l),()=>{T&&T()}},[Array.isArray(s)?s.toString():s,N,r,a,i,u,n,l,t]);const k=(j=w.entry)==null?void 0:j.target,p=d.useRef(void 0);!N&&k&&!i&&!u&&p.current!==k&&(p.current=k,y({inView:!!c,entry:void 0}));const M=[_,w.inView,w.entry];return M.ref=M[0],M.inView=M[1],M.entry=M[2],M}const Na=r=>{var i=r,{selectedOptions:s,setSelectedOptions:t,label:n="Select Users / Channels"}=i,a=K(i,["selectedOptions","setSelectedOptions","label"]);const u=d.useContext(ws),c=d.useContext(_s),l=[...u.enabledUsers,...c.channels],h=me();function j(_,b){const w=b.toLowerCase();return l.filter(y=>{const k=_.find(p=>p.name===y.name);return"full_name"in y?!k&&(y.full_name.toLowerCase().includes(w)||y.name.toLowerCase().includes(w)):!k&&(y.channel_name.toLowerCase().includes(w)||y.name.toLowerCase().includes(w))})}function N({selectedOptions:_,setSelectedOptions:b}){const[w,y]=d.useState(""),k=d.useMemo(()=>j(_,w),[_,w]),{getSelectedItemProps:p,getDropdownProps:M,removeSelectedItem:T}=_e({selectedItems:_,onStateChange({selectedItems:D,type:L}){switch(L){case _e.stateChangeTypes.SelectedItemKeyDownBackspace:case _e.stateChangeTypes.SelectedItemKeyDownDelete:case _e.stateChangeTypes.DropdownKeyDownBackspace:case _e.stateChangeTypes.FunctionRemoveSelectedItem:b(D!=null?D:[]);break}}}),{isOpen:E,getLabelProps:I,getMenuProps:V,getInputProps:ne,highlightedIndex:ee,getItemProps:ae,selectedItem:re}=ie({items:k,itemToString(D){return D?D.name:""},defaultHighlightedIndex:0,selectedItem:null,inputValue:w,stateReducer(D,L){const{changes:m,type:o}=L;switch(o){case ie.stateChangeTypes.InputKeyDownEnter:case ie.stateChangeTypes.ItemClick:return A(x({},m),{isOpen:!0,highlightedIndex:0});default:return m}},onStateChange({inputValue:D,type:L,selectedItem:m}){switch(L){case ie.stateChangeTypes.InputKeyDownEnter:case ie.stateChangeTypes.ItemClick:case ie.stateChangeTypes.InputBlur:m&&(b([..._,m]),y(""));break;case ie.stateChangeTypes.InputChange:y(D!=null?D:"");break}}});return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(fs,A(x({className:"w-fit"},I()),{children:n})),e.jsx(Ot,x({placeholder:"Type a name...",className:"w-full",autoFocus:h},ne(M()))),e.jsx("div",{className:"inline-flex gap-1 p-1 items-center flex-wrap",children:_.map(function(L,m){var o;return"channel_name"in L?e.jsxs("span",A(x({className:"rt-Button rt-BaseButton rt-variant-surface rt-r-size-2 flex items-center"},p({selectedItem:L,index:m})),{children:[e.jsx(ze,{type:L.type,size:"14"}),e.jsx(R,{size:"2",children:L.channel_name}),e.jsx("span",{className:"cursor-pointer",onClick:g=>{g.stopPropagation(),T(L)},children:"âœ•"})]}),`selected-item-${m}`):e.jsxs("span",A(x({className:"rt-Button rt-BaseButton rt-variant-surface rt-r-size-2 flex items-center"},p({selectedItem:L,index:m})),{children:[e.jsx(Me,{src:(o=L.user_image)!=null?o:"",alt:L.full_name,size:"1",variant:"solid",color:"gray"}),e.jsx(R,{size:"2",children:L.full_name}),e.jsx("span",{className:"cursor-pointer",onClick:g=>{g.stopPropagation(),T(L)},children:"âœ•"})]}),`selected-item-${m}`)})})]}),e.jsx("ul",A(x({className:`sm:w-[550px] w-[24rem] absolute bg-background rounded-b-md mt-1 shadow-md z-[9999] max-h-96 overflow-scroll p-0 ${!(E&&k.length)&&"hidden"}`},V()),{children:E&&k.map((D,L)=>{var m;return e.jsx("li",A(x({className:Z(ee===L&&"bg-accent-4",re===D&&"font-bold","py-2 px-3 shadow-sm flex gap-2 items-center")},ae({item:D,index:L})),{children:"channel_name"in D?e.jsxs(je,{justify:"between",width:"100%",children:[e.jsxs(je,{gap:"1",align:"center",children:[e.jsx(ze,{type:D.type,size:"14"}),e.jsx(R,{as:"span",weight:"medium",size:"2",children:D.channel_name})]}),e.jsxs(je,{gap:"1",align:"center",children:[e.jsx($t,{color:"gray"}),e.jsx(R,{size:"1",color:"gray",children:D.workspace})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Me,{src:(m=D.user_image)!=null?m:"",alt:D.full_name,size:"2"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(R,{as:"span",weight:"medium",size:"2",children:D.full_name}),e.jsx(R,{as:"span",size:"1",children:D.name})]})]})}),`${D.name}`)})}))]})}return e.jsx(N,{selectedOptions:s,setSelectedOptions:t})},as=({onClose:s,message:t})=>{var N;const n=Ue({defaultValues:{selected_options:null,message:t}}),{handleSubmit:a,reset:r,control:i}=n,{call:u,error:c,loading:l}=pe("raven.api.raven_message.forward_message"),h=_=>{_.selected_options&&_.selected_options.length>0&&u({message_receivers:_.selected_options,forwarded_message:_.message}).then(()=>{q.success("Message forwarded successfully!"),j()}).catch(()=>{q.error("Failed to forward message")})},j=()=>{r(),s()};return e.jsx(Ve,A(x({},n),{children:e.jsxs("form",{onSubmit:a(h),children:[e.jsxs(C,{justify:"between",children:[e.jsx(ye,{children:"Forward Message"}),e.jsx(Ts,{children:e.jsx(we,{children:"Forward message to a user or channel"})}),e.jsx(be,{onClick:j,children:e.jsx(z,{size:"1",variant:"soft",color:"gray",children:e.jsx(Ke,{size:"18"})})})]}),e.jsxs(C,{gap:"2",direction:"column",width:"100%",children:[e.jsx(he,{error:c}),e.jsx(U,{width:"100%",children:e.jsxs(C,{direction:"column",gap:"2",children:[e.jsx(d.Suspense,{fallback:e.jsx(Y,{}),children:e.jsx(Ht,{control:i,name:"selected_options",rules:{validate:_=>_&&_.length>0?!0:"Please select at least one member"},render:({field:{onChange:_,value:b}})=>e.jsx(Na,{setSelectedOptions:_,selectedOptions:b!=null?b:[]})})}),e.jsx(Ce,{children:(N=n.formState.errors.selected_options)==null?void 0:N.message})]})})]}),e.jsxs(C,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(be,{disabled:l,children:e.jsx(X,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(X,{type:"submit",disabled:l,children:[l&&e.jsx(Y,{className:"text-white"}),l?"Sending":"Send"]})]})]})}))},Sa=s=>{const[t,n]=d.useState(null),a=d.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setForwardMessage:n,isOpen:t!==null,onClose:a}},Ta=({message:s,isOpen:t,onClose:n})=>me()?e.jsx(de,{open:t,onOpenChange:n,children:e.jsx(ue,{className:"static",children:s&&e.jsx(as,{message:s,onClose:n})})}):e.jsx(Ie,{open:t,onClose:n,children:e.jsx(Le,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(as,{message:s,onClose:n})})})}),rs=({onClose:s,message:t})=>{var p,M;const n=Ue({defaultValues:{}}),{handleSubmit:a,reset:r,watch:i}=n,{call:u}=d.useContext(Ae),[c,l]=d.useState(!1),[h,j]=d.useState(null),{recentlyUsedDoctypes:N,addRecentlyUsedDocType:_}=Ls(),b=T=>{if(t.file){_(T.doctype),l(!0);const E=t.file.split("?")[0];u.get("frappe.client.get_value",{doctype:"File",filters:{file_url:E,attached_to_doctype:"Raven Message",attached_to_name:t.name,attached_to_field:"file"},fieldname:["name"]}).then(I=>{I.message&&u.post("upload_file",{doctype:T.doctype,docname:T.docname,library_file_name:I.message.name})}).then(()=>{q.success(`File attached to ${T.doctype} - ${T.docname}`),w()}).catch(I=>{j(I),q.error("Failed to attach file")}).finally(()=>{l(!1)})}},w=()=>{r(),s()},y=i("doctype"),k=()=>{n.setValue("docname","")};return e.jsx(Ve,A(x({},n),{children:e.jsxs("form",{onSubmit:a(b),children:[e.jsxs(C,{justify:"between",children:[e.jsx(ye,{children:"Attach File to Document"}),e.jsx(we,{hidden:!0,children:"Attach the file to a document"}),e.jsx(be,{onClick:w,children:e.jsx(z,{size:"1",variant:"soft",color:"gray",children:e.jsx(Ke,{size:"18"})})})]}),e.jsxs(C,{gap:"2",direction:"column",width:"100%",children:[e.jsx(he,{error:h}),e.jsxs(ks,{children:[e.jsx(Ns,{children:e.jsx(Ut,{ext:Vt(t.file)})}),e.jsx(Ss,{children:e.jsx(Kt,{href:t.file,children:qt(t.file)})})]}),e.jsx(U,{width:"100%",children:e.jsxs(C,{direction:"column",gap:"2",children:[e.jsx(De,{name:"doctype",label:"Document Type",autofocus:!0,suggestedItems:N,rules:{required:"Document Type is required",onChange:k},filters:[["issingle","=",0],["istable","=",0]],doctype:"DocType"}),e.jsx(Ce,{children:(p=n.formState.errors.doctype)==null?void 0:p.message})]})}),y&&e.jsx(U,{width:"100%",children:e.jsxs(C,{direction:"column",gap:"2",children:[e.jsx(De,{name:"docname",label:"Document Name",placeholder:"Select a document",disabled:!y,rules:{required:"Document Name is required"},doctype:y}),e.jsx(Ce,{children:(M=n.formState.errors.docname)==null?void 0:M.message})]})})]}),e.jsxs(C,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(be,{disabled:c,children:e.jsx(X,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(X,{type:"submit",disabled:c,children:[c&&e.jsx(Y,{className:"text-white"}),"Attach"]})]})]})}))},Ea=s=>{const[t,n]=d.useState(null),a=d.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setAttachDocument:n,isOpen:t!==null,onClose:a}},Ma=({message:s,isOpen:t,onClose:n})=>me()?e.jsx(de,{open:t,onOpenChange:n,children:e.jsx(ue,{className:"static",children:s&&e.jsx(rs,{message:s,onClose:n})})}):e.jsx(Ie,{open:t,onClose:n,children:e.jsx(Le,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(rs,{message:s,onClose:n})})})}),is=({reactions:s})=>{const t=d.useMemo(()=>s.flatMap(({reaction:n,users:a,is_custom:r,emoji_name:i})=>a.map(u=>({user:u,reaction:n,is_custom:r,emoji_name:i}))),[s]);return e.jsx(e.Fragment,{children:e.jsx(Tn,{defaultValue:"All",children:e.jsxs(C,{direction:"column",gap:"4",children:[e.jsxs(En,{children:[e.jsx(ls,{emojiSrc:"All",emojiName:"All"}),s.map(n=>e.jsx(ls,{emojiSrc:n.reaction,isCustom:n.is_custom,emojiName:n.emoji_name,count:n.count},n.reaction))]}),e.jsxs(U,{children:[e.jsx(Qe,{value:"All",children:e.jsx(cs,{users:t})}),s.map(n=>e.jsx(Qe,{value:n.reaction,children:e.jsx(cs,{users:n.users.map(a=>({user:a,reaction:n.reaction,is_custom:n.is_custom,emoji_name:n.emoji_name}))})},n.reaction))]})]})})})},ls=({emojiSrc:s,count:t,emojiName:n,isCustom:a=!1})=>e.jsx(Mn,{value:s,className:"text-gray-11",title:n,children:e.jsxs(C,{gap:"2",align:"center",justify:"center",children:[a?e.jsx("img",{src:s,alt:n,className:"w-[1.2rem] h-[1.2rem] object-contain object-center"}):n==="All"?e.jsx(R,{size:"3",children:"All"}):e.jsx(R,{size:"3",className:"w-[1.2rem] h-[1.2rem]",children:e.jsx("em-emoji",{native:n,set:"apple"})}),t&&e.jsx(R,{children:t})]})}),cs=({users:s})=>e.jsx(U,{className:"overflow-hidden overflow-y-scroll h-[50vh] sm:h-64",children:e.jsx(C,{direction:"column",gap:"2",children:e.jsx(C,{direction:"column",children:s.map((t,n)=>e.jsx(Da,{user:t.user,reaction:t.reaction,is_custom:t.is_custom,emoji_name:t.emoji_name},n))})})}),Da=({user:s,reaction:t,is_custom:n,emoji_name:a})=>{var u,c;const r=Yt(s),i=(u=r==null?void 0:r.full_name)!=null?u:s;return e.jsx(U,{className:"hover:bg-slate-3 rounded-md",children:e.jsxs(C,{align:"center",justify:"between",children:[e.jsxs(C,{className:"p-2",gap:"3",align:"center",children:[e.jsx(Me,{src:(c=r==null?void 0:r.user_image)!=null?c:"",alt:i,size:"2"}),e.jsx(R,{size:"2",weight:"medium",children:i})]}),n?e.jsx("img",{src:t,alt:a,title:a,className:"mr-3 w-[1.4rem] h-[1.4rem] object-contain object-center"}):e.jsx(R,{className:"pr-3 h-[1.4rem] w-[1.4rem]",size:"3",weight:"medium",children:e.jsx("em-emoji",{native:a,size:"1.2em",set:"apple"})})]})})},Aa=s=>{const[t,n]=d.useState(null),a=t==null?void 0:t.message_reactions,r=d.useMemo(()=>{const u=JSON.parse(a!=null?a:"{}");return Object.entries(u).map(([c,l])=>A(x({},l),{emoji_name:c}))},[a]),i=d.useCallback(()=>{n(null),s==null||s()},[s]);return{reactions:r,message:t,onClose:i,isOpen:t!==null,setReactionMessage:n}},Ia=a=>{var r=a,{isOpen:s,onClose:t}=r,n=K(r,["isOpen","onClose"]);return me()?e.jsx(de,{open:s,onOpenChange:t,children:e.jsx(ue,{className:`${Ne} w-[450px]`,children:e.jsx(is,x({},n))})}):e.jsx(Ie,{open:s,onClose:t,children:e.jsx(Le,{children:e.jsx("div",{className:"pb-12",children:e.jsx(is,x({},n))})})})},La=({message:s})=>e.jsxs(C,{align:"center",gap:"2",id:`message-${s.name}`,className:"pl-1 py-2.5",children:[e.jsx(wn,{timestamp:s.creation}),e.jsx(R,{as:"span",color:"gray",className:"pl-1.5",size:"1",children:s.text})]});function Ba(s,t){const n=Jt(kn),a=d.useRef(null),r=d.useRef(null),i=d.useRef(!1),{call:u}=pe("nora.api.tts.generate_audio");d.useEffect(()=>{if(!n||!t||!s||s.length===0)return;const c=s[s.length-1];if(a.current===c.name)return;if(!c.is_bot_message||!c.text){a.current=c.name;return}if(i.current)return;a.current=c.name;const l=document.createElement("div");l.innerHTML=c.text;const h=l.textContent||l.innerText||"";h.trim()&&(i.current=!0,u({text:h}).then(j=>{if(j!=null&&j.success&&(j!=null&&j.audio_url)){r.current&&(r.current.pause(),r.current=null);const N=new Audio(j.audio_url);r.current=N,N.onended=()=>{i.current=!1,r.current=null},N.onerror=()=>{console.error("TTS audio playback error"),i.current=!1,r.current=null},N.play().catch(_=>{console.error("TTS play error:",_),i.current=!1,r.current=null})}else i.current=!1}).catch(j=>{console.error("TTS API error:",j),i.current=!1}))},[s,t,n,u]),d.useEffect(()=>()=>{r.current&&(r.current.pause(),r.current=null)},[])}const er=d.forwardRef(({channelID:s,replyToMessage:t,showThreadButton:n=!0,pinnedMessagesString:a,scrollRef:r,onModalClose:i,isBot:u=!1},c)=>{const{messages:l,hasOlderMessages:h,loadOlderMessages:j,goToLatestMessages:N,hasNewMessages:_,error:b,loadNewerMessages:w,isLoading:y,highlightedMessage:k,scrollToMessage:p}=pa(s,r,a);Ba(l,u);const f=ga(i),{setDeleteMessage:M}=f,T=K(f,["setDeleteMessage"]),v=xa(i),{setEditMessage:E}=v,I=K(v,["setEditMessage"]),B=Sa(i),{setForwardMessage:V}=B,ne=K(B,["setForwardMessage"]),H=Ea(i),{setAttachDocument:ee}=H,ae=K(H,["setAttachDocument"]),P=Aa(i),{setReactionMessage:re}=P,D=K(P,["setReactionMessage"]),L=S=>{p(S)},{name:m}=Gt();d.useImperativeHandle(c,()=>({onUpArrow:()=>{if(l&&l.length>0){const S=l[l.length-1];S.message_type==="Text"&&S.owner===m&&!S.is_bot_message&&E(S)}}}));const{ref:o}=ns({fallbackInView:!0,initialInView:!1,skip:!h,onChange:(S=>G(null,null,function*(){S&&h&&(yield j())}))}),{ref:g}=ns({fallbackInView:!0,skip:!_,initialInView:!1,onChange:S=>{S&&_&&w()}});return d.useEffect(()=>{if(!r.current)return;const S=new ResizeObserver(()=>{const J=r.current;J&&J.scrollTop+J.clientHeight>=J.scrollHeight-100&&requestAnimationFrame(()=>{J.scrollTo({top:J.scrollHeight,behavior:"instant"})})});return S.observe(r.current),()=>{S.disconnect()}},[]),e.jsxs("div",{className:"relative h-full flex flex-col overflow-y-auto pb-16 sm:pb-0",ref:r,children:[e.jsx("div",{ref:o,children:h&&!y&&e.jsx("div",{className:"flex w-full min-h-8 pb-4 justify-center items-center",children:e.jsx(Y,{})})}),!y&&!h&&e.jsx(Nn,{channelID:s!=null?s:""}),y&&e.jsx(ba,{}),b&&e.jsx(he,{error:b}),e.jsx("div",{className:Z("flex flex-col pb-4 z-50 transition-opacity duration-400 ease-ease-out-cubic",y?"opacity-0":"opacity-100"),children:l==null?void 0:l.map(S=>S.message_type==="date"?e.jsx(Sn,{id:`date-${S.creation}`,className:"p-2 z-10 relative",children:S.creation},`date-${S.creation}`):S.message_type==="System"?e.jsx(La,{message:S},`${S.name}_${S.modified}`):e.jsx("div",{id:`message-${S.name}`,children:e.jsx("div",{className:"w-full overflow-x-clip overflow-y-visible text-ellipsis",children:e.jsx(_n,{message:S,isHighlighted:k===S.name,onReplyMessageClick:L,setEditMessage:E,replyToMessage:t,forwardMessage:V,showThreadButton:n,onAttachDocument:ee,setDeleteMessage:M,setReactionMessage:re})})},`${S.name}_${S.modified}`))}),_&&e.jsx("div",{ref:g,children:e.jsx("div",{className:"flex w-full min-h-8 pb-4 justify-center items-center",children:e.jsx(Y,{})})}),_&&e.jsx("div",{className:"fixed bottom-36 z-50 right-5",children:e.jsxs(X,{className:"shadow-lg",onClick:N,children:["Scroll to new messages",e.jsx(Wt,{size:18})]})}),e.jsx(fa,x({},T)),e.jsx(ja,x({},I)),e.jsx(Ta,x({},ne)),e.jsx(Ma,x({},ae)),e.jsx(Ia,x({},D))]})}),sr=({channelData:s,user:t})=>{const{mutate:n}=Zt(),{threadID:a}=vs(),{createDoc:r,error:i,loading:u}=gs(),c=()=>G(null,null,function*(){return r("Raven Channel Member",{channel_id:s?s==null?void 0:s.name:a,user_id:t}).then(()=>{n(["channel_members",s?s.name:a])})});return e.jsx(U,{children:e.jsxs(C,{direction:"column",align:"center",gap:s?"3":"2",className:"border border-gray-6 rounded-md bg-surface animate-fadein sm:mb-0 mb-2",p:s?"4":"3",children:[e.jsx(he,{error:i}),e.jsxs(R,{as:"span",size:"2",children:["You are not a member of this ",s?"channel":"thread","."]}),e.jsxs(X,{onClick:c,size:s?"2":"1",disabled:u,children:[u&&e.jsx(Y,{className:"text-white"}),u?"Joining":e.jsxs("span",{className:"inline-flex gap-1 not-cal font-medium",children:["Join ",s?`${s==null?void 0:s.channel_name}`:"Conversation"]})]})]})})},za=s=>{const{socket:t}=d.useContext(Ae),[n,a]=d.useState([]);return d.useEffect(()=>{t&&(t.emit("raven_channel_get_typers",s),t.io.on("reconnect",()=>{t.emit("raven_channel_get_typers",s)}))},[s]),xe("raven_channel_typers",r=>{r.channel===s&&a(r.users)}),n},tr=s=>{const[t,n]=d.useState(0),a=d.useRef(!1),{socket:r}=d.useContext(Ae),i=d.useCallback(()=>{r==null||r.emit("raven_channel_typing",s)},[s]),u=d.useCallback(()=>{r==null||r.emit("raven_channel_typing_stopped",s)},[s]),c=d.useCallback(()=>{a.current||(a.current=!0,n(h=>h+1),i())},[i]);return d.useEffect(()=>{let h;return t>0&&(h=setTimeout(()=>{a.current=!1,n(0),u()},1e4)),()=>{clearTimeout(h)}},[t,u]),d.useEffect(()=>()=>{u()},[u]),{stopTyping:d.useCallback(()=>{u(),a.current=!1,n(0)},[u]),onUserType:c}},nr=({channel:s})=>{const t=za(s),n=Dn(),{currentUser:a}=d.useContext(Es),r=d.useMemo(()=>{const i=t.filter(u=>u!==a).map(u=>{var c,l,h,j;return(j=(h=(c=n[u])==null?void 0:c.first_name)!=null?h:(l=n[u])==null?void 0:l.full_name)!=null?j:u});return i.length===0?"":i.length===1?i[0]+" is typing...":i.length===2?i[0]+" and "+i[1]+" are typing...":i.length===3?i[0]+", "+i[1]+" and 1 other are typing...":i[0]+", "+i[1]+" and "+(i.length-2)+" others are typing..."},[t,n,a]);return r===""?null:e.jsxs(je,{className:"gap-1.5 pl-0.5 pt-1 relative sm:bottom-0 bottom-16 sm:pb-0 pb-2",align:"center",children:[e.jsxs("div",{className:"flex items-center space-x-1 -mb-0.5",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"300ms"}})]}),e.jsx(R,{size:"1",as:"span",children:r})]})};export{er as C,Qa as F,Wa as H,sr as J,nr as T,Ga as a,Xa as b,ma as c,Za as d,Hn as e,qe as f,tr as u};
