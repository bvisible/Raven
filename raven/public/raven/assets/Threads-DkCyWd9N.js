var K=Object.defineProperty,ee=Object.defineProperties;var se=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable;var V=(s,a,r)=>a in s?K(s,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[a]=r,_=(s,a)=>{for(var r in a||(a={}))ae.call(a,r)&&V(s,r,a[r]);if(B)for(var r of B(a))re.call(a,r)&&V(s,r,a[r]);return s},y=(s,a)=>ee(s,se(a));import{j as e,b as te,m as ne,be as ie,dl as ce,aD as le,aE as oe,aF as de,aG as G,bo as W,i as g,a7 as he,n as ue,dm as me,a3 as H,dn as Y,a4 as xe,dp as pe,r as h,bx as C,N as je,M as S,a as m,cZ as ge,p as Z,aA as fe,dq as ve,h as be,dr as _e,E as ye,ds as we,dt as Ne,du as ke,f as Se,W as Ce,x as Ie,_ as Te,X as ze}from"./index-DLbNAGlT.js";import{P as Ae}from"./PageHeader-DvksSftg.js";import{u as I}from"./useDebounce-CIElYYyC.js";import{u as Me,M as Ee,U as Le,a as Pe}from"./useCurrentChannelData-Ff8pMrXj.js";import{u as De}from"./useGetUserRecords-BJmq8J8Y.js";import{m as Oe,b as Ue,P as w,f as N}from"./tabs-DNCG8JUF.js";import"./index-C9orlyen.js";import"./useRavenSettings-CaSx_tcD.js";import"./hover-card-Dgjf7T-b.js";import"./preferences-ChbvcSWc.js";import"./DoctypeLinkRenderer-Drd_gl6Y.js";import"./useDoctypeMeta-Zs7XFBWn.js";import"./skeleton-BDAZ3z87.js";const T=({search:s,setSearch:a})=>e.jsx("div",{children:e.jsx(te,{placeholder:"Search threads...",value:s,onChange:r=>a(r.target.value),className:"sm:min-w-64",children:e.jsx(ne,{children:e.jsx(ie,{size:16})})})}),q=({channel:s,setChannel:a})=>{const{channels:r}=ce();return e.jsx("div",{children:e.jsxs(le,{value:s,onValueChange:a,children:[e.jsx(oe,{placeholder:"Channel / DM",className:"sm:min-w-48"}),e.jsxs(de,{className:"z-50",children:[e.jsx(G,{value:"all",children:"Any Channel"}),r.map(n=>e.jsx(G,{value:n.name,children:e.jsxs("div",{className:"gap-1 items-center flex overflow-hidden",children:[e.jsx(W,{type:n.type}),e.jsx(g,{style:{maxWidth:"20ch"},className:"text-ellipsis whitespace-break-spaces line-clamp-1 pb-0.5",children:n.channel_name})]})},n.name))]})]})})},X=({onlyShowUnread:s,setOnlyShowUnread:a})=>{const r=()=>{const l=s;a(!s),l?H.info("Viewing all threads",{position:"bottom-center",duration:800}):H.info("Viewing only unread threads",{position:"bottom-center",duration:800})},n=s?"Showing only unread threads":"Showing all threads";return e.jsx(he,{content:"Filter unread threads",children:e.jsx(ue,{variant:s?"solid":"soft","aria-label":n,title:n,onClick:r,children:e.jsx(me,{size:16})})})},$e=({participants:s})=>{if(s.length===0)return null;const a=Object.keys(s).length,r=Math.min(a-3,9);return e.jsxs("div",{className:"flex items-center -space-x-1 rtl:space-x-reverse animate-fadein",children:[s.map((n,l)=>{var c,u;const i=Y(n.user_id);if(l<3)return e.jsx(xe,{src:(c=i==null?void 0:i.user_image)!=null?c:void 0,alt:(u=i==null?void 0:i.full_name)!=null?u:n.user_id,radius:"full",variant:"solid",className:"border border-gray-2"},n.user_id)}),a>3&&e.jsx("span",{className:"inline-block",children:e.jsx(pe,{fallback:`${r}+`,size:"1",variant:"soft",color:"gray",radius:"full",className:"border border-slate-4 text-[10px]"})})]})},Fe=({thread:s,unreadCount:a})=>{const r=Y(s.owner),n=De(),{channel:l}=Me(s.channel_id),i=l==null?void 0:l.channelData,c=h.useMemo(()=>{var p,o;if(i)return i.is_direct_message?{channelIcon:"",channelName:`DM with ${(o=(p=n[i.peer_user_id])==null?void 0:p.full_name)!=null?o:i.peer_user_id}`}:{channelIcon:i.type,channelName:i.channel_name}},[i,n]),{workspaceID:u}=C();return e.jsx(je,{to:`/${u}/threads/${s.name}`,tabIndex:0,className:({isActive:p})=>S("group block hover:bg-gray-2 dark:hover:bg-gray-4 px-4 py-4 border-b border-gray-4 overflow-hidden","focus:outline-none focus-visible:ring-2 focus-visible:ring-accent-8 focus-visible:ring-inset",p&&"bg-gray-3 dark:bg-gray-3"),children:({isActive:p})=>{var o,x;return e.jsxs("div",{className:"flex w-full justify-between items-center gap-2",children:[e.jsxs(m,{direction:"column",gap:"2",children:[e.jsxs(m,{gap:"2",align:"center",children:[e.jsxs(m,{gap:"1",align:"center",justify:"center",children:[(c==null?void 0:c.channelIcon)&&e.jsx(W,{type:c==null?void 0:c.channelIcon,size:"14"}),e.jsx(g,{as:"span",size:"1",className:"font-semibold",children:c==null?void 0:c.channelName})]}),e.jsx(g,{as:"span",size:"1",color:"gray",children:e.jsx(ge,{date:s.creation})})]}),e.jsxs(m,{gap:"3",children:[e.jsx(Ee,{userID:s.owner,user:r,isActive:!1}),e.jsxs(m,{direction:"column",gap:"0.5",justify:"center",children:[e.jsx(Z,{children:e.jsx(Le,{user:r,userID:s.owner,isActive:!1})}),e.jsx(Pe,{message:s,user:r,forceHideLinkPreview:!0})]})]}),e.jsxs(m,{align:"center",gap:"2",className:"pl-11",children:[e.jsx($e,{participants:(o=s.participants)!=null?o:[]}),e.jsxs(g,{as:"div",size:"1",className:"font-medium text-accent-a11",children:[(x=s.reply_count)!=null?x:0," ",s.reply_count&&s.reply_count===1?"Reply":"Replies"]})]})]}),a>0&&e.jsx(fe,{variant:"soft",className:"font-bold",size:"2",children:a})]})}})},k=5,z=({aiThreads:s,content:a,channel:r,endpoint:n="raven.api.threads.get_all_threads",onlyShowUnread:l})=>{var O,U,$,F;const{workspaceID:i}=C(),{data:c}=ve(),u=h.useMemo(()=>c==null?void 0:c.message.reduce((t,d)=>(t[d.name]=d.unread_count,t),{}),[c]),{call:p}=h.useContext(be),{data:o,size:x,isLoading:J,setSize:A,error:M,mutate:E}=_e((t,d)=>{if(d&&!d.message.length)return null;const j=t*k;return[n,{is_ai_thread:s,workspace:i,content:a,channel_id:r,startAfter:j,onlyShowUnread:l}]},t=>p.get(n,{is_ai_thread:t[1].is_ai_thread,workspace:t[1].workspace,content:t[1].content,channel_id:t[1].channel_id,start_after:t[1].startAfter,limit:k,only_show_unread:t[1].onlyShowUnread}),{revalidateOnFocus:!1,revalidateIfStale:!0}),L=((U=(O=o==null?void 0:o[0])==null?void 0:O.message)==null?void 0:U.length)===0,f=J||x>0&&o&&typeof o[x-1]=="undefined",P=L||o&&((F=($=o[o.length-1])==null?void 0:$.message)==null?void 0:F.length)<k,Q=h.useMemo(()=>{var t;return(t=o==null?void 0:o.flatMap(d=>d.message).sort((d,j)=>new Date(j.last_message_timestamp).getTime()-new Date(d.last_message_timestamp).getTime()))!=null?t:[]},[o]);h.useEffect(()=>{const t=d=>{E(j=>j&&j.map(R=>y(_({},R),{message:R.message.map(b=>b.name===d.detail.threadId?y(_({},b),{reply_count:d.detail.numberOfReplies,last_message_timestamp:d.detail.lastMessageTimestamp}):b)})),{revalidate:!1})};return window.addEventListener("thread_updated",t),()=>{window.removeEventListener("thread_updated",t)}},[E]);const v=h.useRef(null),D=h.useCallback(()=>{!P&&!f&&A(x+1)},[P,f,A,x]);return h.useEffect(()=>{const t=new IntersectionObserver(d=>{d[0].isIntersecting&&D()},{threshold:.1});return v.current&&t.observe(v.current),()=>t.disconnect()},[D]),M?e.jsx(ye,{error:M}):L?e.jsx(Re,{isFiltered:l}):e.jsxs("ul",{className:"list-none",role:"list",children:[Q.map(t=>{var d;return e.jsx("li",{role:"listitem",children:e.jsx(Fe,{thread:t,unreadCount:(d=u==null?void 0:u[t.name])!=null?d:0})},t.name)}),e.jsx("div",{ref:v,className:"h-4"}),f&&e.jsx(we,{text:"Loading more threads..."})]})},Re=({isFiltered:s=!1})=>{const a=h.useMemo(()=>s?{title:"You're all caught up",description:"There are no unread threads to show. Clear the filter to see all threads."}:{title:"No threads yet",description:"Threads help keep conversations organized. Reply to any message to start a new thread or use the thread icon on messages to join existing discussions."},[s]);return e.jsxs(m,{direction:"column",align:"center",justify:"center",className:"h-[400px] px-6 text-center",children:[e.jsx("div",{className:"text-gray-8 mb-4",children:e.jsx(Ne,{size:48})}),e.jsx(g,{size:"5",weight:"medium",className:"mb-2",children:a.title}),e.jsx(g,{as:"p",size:"2",color:"gray",className:"max-w-[400px]",children:a.description})]})},Be=s=>{const[a,r]=h.useState(""),n=I(a,250),[l,i]=h.useState(!1);return e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 justify-between p-2 border-b border-gray-4",children:[e.jsx(T,{search:a,setSearch:r}),e.jsx("div",{className:"flex gap-2",children:e.jsx(X,{onlyShowUnread:l,setOnlyShowUnread:i})})]}),e.jsx("div",{className:"h-[calc(100vh-10rem)] overflow-y-auto",children:e.jsx(z,{content:n,aiThreads:1,onlyShowUnread:l})})]})},Ve=s=>{const[a,r]=h.useState(""),n=I(a,250),[l,i]=h.useState("all");return e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 justify-between p-2 border-b border-gray-4",children:[e.jsx(T,{search:a,setSearch:r}),e.jsx("div",{className:"flex gap-2",children:e.jsx(q,{channel:l,setChannel:i})})]}),e.jsx("div",{className:"h-[calc(100vh-10rem)] overflow-y-auto",children:e.jsx(z,{content:n,endpoint:"raven.api.threads.get_other_threads",channel:l})})]})},Ge=s=>{const[a,r]=h.useState(""),n=I(a,250),[l,i]=h.useState("all"),[c,u]=ke(!0,"raven-participating-threads-only-show-unread");return e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 flex-wrap justify-between p-2 border-b border-gray-4",children:[e.jsx(T,{search:a,setSearch:r}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{channel:l,setChannel:i}),e.jsx(X,{onlyShowUnread:c,setOnlyShowUnread:u})]})]}),e.jsx("div",{className:"h-[calc(100vh-10rem)] overflow-y-auto",children:e.jsx(z,{content:n,channel:l,onlyShowUnread:c})})]})},He=()=>{const{workspaceID:s,threadID:a}=C();return e.jsxs(m,{direction:"column",gap:"0",children:[e.jsx(Ae,{children:e.jsxs(m,{align:"center",gap:"3",className:"h-8",children:[e.jsx(Se,{to:`/${s}`,className:"block bg-transparent hover:bg-transparent active:bg-transparent sm:hidden",children:e.jsx(Ce,{size:"24",className:"block text-gray-12"})}),e.jsx(Ie,{size:"5",children:Te("Threads")})]})}),e.jsxs("div",{className:"flex gap-0",children:[e.jsx(Z,{className:S("w-full sm:w-[50%] pt-12 border-r border-gray-4",a?"hidden sm:block":"block"),children:e.jsxs(Oe,{defaultValue:"Participating",children:[e.jsxs(Ue,{className:"px-4",children:[e.jsx(w,{value:"Participating",children:"Participating"}),e.jsx(w,{value:"Other",children:"Other"}),e.jsx(w,{value:"AI Threads",children:"AI Agents"})]}),e.jsx(N,{value:"Participating",children:e.jsx(Ge,{})}),e.jsx(N,{value:"Other",className:"h-[calc(100vh-6rem)] overflow-y-auto",children:e.jsx(Ve,{})}),e.jsx(N,{value:"AI Threads",className:"h-[calc(100vh-6rem)] overflow-y-auto",children:e.jsx(Be,{})})]})}),e.jsx("div",{className:S("h-screen w-full sm:w-[50%]",a?"block":"hidden"),children:e.jsx(ze,{})})]})]})},cs=He;export{cs as Component};
