var ue=Object.defineProperty,de=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var X=(e,n,t)=>n in e?ue(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,v=(e,n)=>{for(var t in n||(n={}))G.call(n,t)&&X(e,t,n[t]);if(M)for(var t of M(n))K.call(n,t)&&X(e,t,n[t]);return e},_=(e,n)=>de(e,he(n));var Z=(e,n)=>{var t={};for(var a in e)G.call(e,a)&&n.indexOf(a)<0&&(t[a]=e[a]);if(e!=null&&M)for(var a of M(e))n.indexOf(a)<0&&K.call(e,a)&&(t[a]=e[a]);return t};import{dn as me,e2 as ge,r as l,j as s,a as m,p as R,M as W,i as B,eb as pe,dY as fe,dX as xe,dS as je,o as we,dh as Q,d as ve,bd as F,dR as _e,aB as ee,S as Te,ej as ye,n as P,dV as be,bm as D,bx as b,U as Se,x as ke,ak as Ne,al as Ce,bk as Ee,an as Ie,ek as Me,el as Fe,V as se,ao as L,em as ze,en as Ae,eo as Re,br as Be,bq as Pe,a3 as $,ac as ne}from"./index-DnEovQPS.js";import{u as Ue,a as De,b as Le,F as $e,C as He,J as Oe,T as Ye,c as Ve}from"./TypingIndicator-Dd_VZgE-.js";import{M as qe,U as Je,D as Xe,T as Ge,R as Ke}from"./useCurrentChannelData-r_Xi0wsK.js";import{u as U}from"./EmptyState-TZ7XarNt.js";import{D as Ze}from"./DoctypeLinkRenderer-DOPT5so6.js";const Qe=a=>{var o=a,{message:e,user:n}=o,t=Z(o,["message","user"]);var w,p,S,k;const r=me(e.owner),i=ge(e.owner),h=l.useRef(null),[u,f]=l.useState(!((w=e.text)!=null&&w.length)),[j,g]=l.useState(null);l.useLayoutEffect(()=>{var N,C;g((C=(N=h.current)==null?void 0:N.clientHeight)!=null?C:null)});const x=(j&&j>=40||u)&&e.message_type==="Text";return s.jsxs(m,{gap:"3",pb:"2",pt:"7",className:"bg-white dark:bg-gray-2 border-gray-4 sm:dark:border-gray-6 border-b",children:[s.jsx(qe,{userID:e.owner,user:r,isActive:i}),s.jsxs(m,{direction:"column",gap:"0.5",justify:"center",width:"100%",children:[s.jsxs(m,{align:"center",gap:"2",mt:"-1",children:[s.jsx(Je,{user:r,userID:e.owner,isActive:i}),s.jsx(Xe,{timestamp:e.creation,timeFormat:"Do MMM [at] hh:mm A"})]}),s.jsxs(R,{children:[s.jsxs(R,_(v({ref:h,className:W("overflow-y-hidden",u?"max-h-min":"max-h-10")},t),{children:[e.text?s.jsx(Ge,{message:_(v({},e),{message_type:"Text"}),user:n,showMiniImage:!0,showLinkPreview:!1}):null,e.message_type==="Poll"?s.jsxs(B,{as:"span",size:"2",className:"line-clamp-2 flex items-center",children:[s.jsx(pe,{size:"14",className:"inline mr-1"}),"Poll: ",(S=(p=e.content)==null?void 0:p.split(`
`))==null?void 0:S[0]]}):["File","Image"].includes((k=e.message_type)!=null?k:"Text")?s.jsxs(m,{gap:"2",align:"center",children:[e.message_type==="File"&&e.file&&s.jsx(fe,{ext:xe(e.file),size:"18"}),e.message_type==="Image"&&s.jsx("img",{src:e.file,alt:`Image sent by ${e.owner}`,height:"30",width:"30",className:"object-cover rounded-md"}),s.jsx(B,{as:"span",size:"2",children:je(e.file)})]}):null,e.link_doctype&&e.link_document&&s.jsx(Ze,{doctype:e.link_doctype,docname:e.link_document})]})),x&&s.jsxs(we,{size:"1",color:"gray",variant:"ghost",className:"hover:bg-transparent hover:underline cursor-pointer mt-0.5",onClick:()=>f(!u),children:["Show ",u?"Less":"More"]})]})]})]})},We=({channelID:e})=>{const t=(()=>{const g=sessionStorage.getItem("ai_thread_thinking");if(g){const x=JSON.parse(g);if(x.threadID===e&&Date.now()-x.timestamp<5e3)return sessionStorage.removeItem("ai_thread_thinking"),{aiEvent:"Nora is thinking...",showAIEvent:!0,isNewThread:!0,thinkingStartTime:Date.now()}}return{aiEvent:"",showAIEvent:!1,isNewThread:!1,thinkingStartTime:0}})(),[a,o]=l.useState(t.aiEvent),[r,i]=l.useState(t.showAIEvent),[h,u]=l.useState(t.isNewThread),[f,j]=l.useState(t.thinkingStartTime);return Q("ai_event",g=>{g.channel_id===e&&(o(g.text),i(!0),u(!1),j(Date.now()))}),Q("ai_event_clear",g=>{if(g.channel_id===e){const x=f?Date.now()-f:0,w=2e3;if(f&&x<w){const p=w-x;setTimeout(()=>{o(""),u(!1)},p);return}o(""),u(!1)}}),l.useEffect(()=>{!a&&r&&setTimeout(()=>{i(!1)},300)},[a]),s.jsx("div",{className:W("w-full transition-all duration-300 ease-ease-out-quart",r?"translate-y-0 opacity-100 z-50 sm:pb-0 pb-16":"translate-y-full opacity-0 h-0"),children:s.jsxs("div",{className:"flex items-center gap-2 py-2 px-2 bg-white dark:bg-gray-2",children:[s.jsx(ve,{}),s.jsx(B,{size:"2",children:a})]})})},cs=({threadMessage:e})=>{const n=e.name,t=e.channel_id,{channelMembers:a}=U(t!=null?t:""),{stopTyping:o,onUserType:r}=Ue(n!=null?n:""),[i,h]=l.useState(null),u=c=>{h(c)},f=()=>{h(null)},j=l.useRef(null),{mutate:g}=F(),x=c=>{g({path:`get_messages_for_channel_${n}`},d=>{var q,J;if(d&&(d!=null&&d.message.has_new_messages))return d;const T=(q=d==null?void 0:d.message.messages)!=null?q:[],A=[...T];return c.forEach(y=>{const I=T.findIndex(ce=>ce.name===y.name);I!==-1?A[I]=_(v({},y),{_liked_by:"",is_pinned:0,is_continuation:0}):A.push(_(v({},y),{_liked_by:"",is_pinned:0,is_continuation:0}))}),{message:{messages:A.sort((y,I)=>new Date(I.creation).getTime()-new Date(y.creation).getTime()),has_new_messages:!1,has_old_messages:(J=d==null?void 0:d.message.has_old_messages)!=null?J:!1}}},{revalidate:!1}).then(()=>{var d,T;(T=j.current)==null||T.scrollTo(0,(d=j.current)==null?void 0:d.scrollHeight)}),o(),f()},{fileInputRef:w,files:p,setFiles:S,removeFile:k,uploadFiles:N,addFile:C,fileUploadProgress:te}=De(n!=null?n:""),{sendMessage:ae,loading:ie}=Le(n!=null?n:"",N,x,i),H=l.useRef(null),re=l.useCallback(()=>{var c;(c=H.current)==null||c.onUpArrow()},[]),O=l.useRef(null),Y=_e(),oe=l.useCallback(()=>{var c;Y||(c=O.current)==null||c.focusEditor()},[Y]),le=({selectedMessage:c})=>c?s.jsx(Ke,{justify:"between",align:"center",className:"m-2",message:c,children:s.jsx(P,{color:"gray",size:"1",className:"z-50",variant:"soft",onClick:f,children:s.jsx(be,{size:"20"})})}):null,{name:E}=ee(),{channelMembers:z}=U(n!=null?n:""),V=l.useMemo(()=>E&&z?E in z:!1,[E,z]);return s.jsx(m,{direction:"column",justify:"between",gap:"0",className:"h-full p-4",children:s.jsxs($e,{files:p,areaHeight:"h-[calc(100vh-72px)]",height:"100%",width:"w-[calc((100vw-var(--sidebar-width)-var(--space-8)-var(--space-5))/2)]",ref:w,onFileChange:S,maxFiles:10,maxFileSize:1e7,children:[s.jsx(Qe,{message:e}),s.jsx(He,{channelID:n!=null?n:"",scrollRef:j,ref:H,replyToMessage:u,showThreadButton:!1,onModalClose:oe}),s.jsx(We,{channelID:n!=null?n:""}),!V&&s.jsx(Oe,{user:E}),V&&s.jsxs(Te,{children:[s.jsx(Ye,{channel:n!=null?n:""}),s.jsx(Ve,{channelID:n,fileProps:{fileInputRef:w,addFile:C},ref:O,onUpArrow:re,onUserType:r,channelMembers:a,clearReplyMessage:f,replyMessage:i,sessionStorageKey:`tiptap-${n}`,onMessageSend:ae,messageSending:ie,slotBefore:s.jsxs(m,{direction:"column",justify:"center",hidden:!i&&!p.length,children:[i&&s.jsx(le,{selectedMessage:i}),p&&p.length>0&&s.jsx(m,{gap:"2",width:"100%",align:"end",px:"2",p:"2",wrap:"wrap",children:p.map(c=>s.jsx(R,{className:"grow-0",children:s.jsx(ye,{file:c,uploadProgress:te,removeFile:()=>k(c.fileID)})},c.fileID))})]})},n)]})]})})},us=()=>{const e=D(),{threadID:n}=b(),{name:t}=ee(),{channelMembers:a}=U(n!=null?n:""),{currentUser:o}=l.useContext(Se),r=l.useMemo(()=>{var i;return t&&a&&(i=a[t])!=null?i:null},[t,a]);return s.jsx("header",{className:"dark:bg-gray-2 bg-white fixed top-0 px-3 sm:w-[calc((100vw-var(--sidebar-width)-var(--space-8))/2)] w-screen",style:{zIndex:999},children:s.jsx(m,{direction:"column",gap:"2",className:"pt-3",children:s.jsxs(m,{justify:"between",align:"center",children:[s.jsx(ke,{size:"4",className:"pl-1",children:"Thread"}),s.jsxs(m,{gap:"2",justify:"between",align:"center",className:"px-4 sm:px-0",children:[r&&s.jsxs(Ne,{children:[s.jsx(Ce,{children:s.jsx(P,{color:"gray",className:"bg-transparent text-gray-12 hover:bg-gray-3",children:s.jsx(Ee,{})})}),s.jsxs(Ie,{className:"min-w-48",children:[s.jsx(ns,{channelMember:r}),s.jsx(ss,{}),a[o].is_admin===1&&s.jsx(es,{})]})]}),s.jsx(P,{className:"mr-1 text-gray-11",variant:"ghost",color:"gray","aria-label":"Close thread",title:"Close thread",onClick:()=>e("../",{replace:!0}),children:s.jsx(Me,{size:"16"})})]})]})})})},es=()=>{const{threadID:e}=b(),n=D(),{deleteDoc:t}=Be(),a=()=>{const o=t("Raven Channel",e).then(()=>(n("../"),Promise.resolve()));$.promise(o,{success:"You have deleted the thread",error:r=>`Could not delete thread - ${ne(r)}`})};return s.jsx(L,{color:"red",onClick:a,children:s.jsxs(m,{gap:"2",align:"center",children:[s.jsx(Pe,{size:"16"}),"Delete Thread"]})})},ss=()=>{const{threadID:e}=b(),{mutate:n}=F(),t=D(),{call:a}=se("raven.api.raven_channel.leave_channel"),o=()=>{const r=a({channel_id:e}).then(()=>(t("../"),n(["channel_members",e]),Promise.resolve()));$.promise(r,{success:"You have left the thread",error:i=>`Could not leave thread - ${ne(i)}`})};return s.jsx(L,{onClick:o,color:"red",children:s.jsxs(m,{gap:"2",align:"center",children:[s.jsx(Re,{size:"16"}),"Leave Thread"]})})},ns=({channelMember:e})=>{const{threadID:n}=b(),{mutate:t}=F(),a=Fe(),{call:o}=se("raven.api.notification.toggle_push_notification_for_channel"),r=()=>{if(e){const i=o({member:e==null?void 0:e.channel_member_name,allow_notifications:e!=null&&e.allow_notifications?0:1}).then(h=>(h&&h.message&&t(["channel_members",n],u=>({message:_(v({},u.message),{[e.name]:_(v({},u.message[e.name]),{allow_notifications:h.message.allow_notifications})})}),{revalidate:!1}),Promise.resolve()));$.promise(i,{success:"Notification settings updated",error:"Failed to update notification settings"})}};return a?s.jsx(L,{onClick:r,children:s.jsxs(m,{gap:"2",align:"center",children:[e.allow_notifications?s.jsx(ze,{size:"16"}):s.jsx(Ae,{size:"16"}),e.allow_notifications?"Disable":"Enable"," Notifications"]})}):null},ds=e=>{const{mutate:n}=F(),{workspaceID:t}=b();l.useEffect(()=>{const a=o=>{o&&n(["unread_thread_count",t],r=>{if(r&&r.message){const i=[...r.message],h=i.findIndex(u=>u.name===o);return h!==-1&&i.splice(h,1),{message:i}}return r},{revalidate:!1})};return a(e),()=>{a(e)}},[e,t])};export{us as T,cs as a,ds as u};
